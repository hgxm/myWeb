<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<load href="__PUBLIC__/Css/Home/adviser.css"/>
<script>
$(function(){

    $('.tab_return').click(function() {
        location.href = "__URL__";
    })

    // 删除
    $(document).on('click','.notice_cen .click_remode',function(){
        if (confirm('你确定要删除吗？')) {

            var obj = $(this);
            $.post('__APPURL__/Notice/delete', 'no_id='+obj.closest('.notice_cen').attr('attr'), function(json) {
                if (json.status == 1) {
                    obj.closest('.notice_cen').remove();
                } else {
                    showMessage(json.info);
                }
            }, 'json')
        }
    });

    // 弹窗点击添加人姓名
    $(document).on('click','.notice_main span',function(){

        var ind = $(this).index();
        var obj = ind == 0 ? $('.notice_main span') : $(this);

        if ($(this).hasClass('notice_span')) {
            if (ind == 0) {
                $(this).html('全选');
            } else {
                $('.notice_main span').eq(0).removeClass('notice_span').html('全选');
            }
            obj.removeClass('notice_span');
        } else {
            obj.addClass('notice_span');
            if (ind == 0) {
                $(this).html('全不选');
            } else {
                if ($('.notice_main span.notice_span').size() == $('.notice_main span').size() - 1) {
                    $('.notice_main span').eq(0).addClass('notice_span').html('全不选');
                }
            }
        }
    })

    // 发布通知点击
    $('.notice_ask').click(function(){
        $('.notice_pop textarea').val('');
        $('.notice_main span').removeClass('notice_span');
        $(".notice_pop").dialog("open");
    })

    //弹出窗口
    $(".notice_pop").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '602',
        height: 'auto',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
          effect: "explode",
          duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {
                var tTxe = $('.notice_pop textarea').val();
                String.prototype.trim = function (){
                    return this.replace(/[ ]/g, '');
                }
                var tLen = tTxe.trim();
                var str = postStr = showStr = '';
                if (tLen == "") {
                    showMessage('请输入通知内容');
                    return false;
                }

                if ($('.notice_main span.notice_span').size() < 1) {
                    showMessage('请选择通知人');
                    return false;
                }

                var is_all = 0;

                if ($('.notice_main span').eq(0).hasClass('notice_span')) {

                    $('.notice_main .notice_span:gt(0)').each(function(i){

                       str += ',' + $(this).attr('attr');
                    })
                    showStr = '全班同学';
                    is_all = 1;
                } else {

                    $('.notice_main .notice_span').each(function(i){
                        if (i < 3) {
                            showStr += ',' +  $(this).text();
                        }
                       str += ',' + $(this).attr('attr');
                    })

                    if ($('.notice_main .notice_span').size() > 3) {
                        showStr += '等';
                    }
                    showStr = "“" + showStr.slice(1) + "”";
                }

                var obj = $(this);
                postStr = 'c_id='+$('.notice_main span').eq(0).attr('attr')+'&no_peoples='+str.slice(1)+'&no_is_all='+is_all;
                $.post('__APPURL__/Notice/insert', postStr+'&no_content='+tLen, function(json) {
                    if (json) {
                        if (json.status > 0) {

                            if ($('.notice_over .notice_cen').size() < 1) {
                                $('.notice_over').html('');
                            }
                            var myDate = new Date();

                            $('.notice_over').append("<div class='notice_cen' attr="+json.status+"><p class='stu_bold'><span>对</span><span class='hon_content'>"+showStr+"</span><span>通知：</span></p><p class='stu_cen'>"+tLen+"</p><p class='stu_click'>"+myDate.getFullYear()+'-'+(myDate.getMonth()+1)+'-'+myDate.getDate()+' '+(myDate.getHours())+':'+myDate.getMinutes()+"<a class='published'>发布</a><a class='click_remode'>删除</a></p></div>");
                            obj.dialog('close');
                        }
                    }
                }, 'json')
            },
            取消: function() {
                $(this).dialog('close');
            }
        }
    });

    // 发布
    $(document).on('click','.published',function(){

        var obj = $(this);
        $.post('__APPURL__/Notice/published', 'is_ajax=1&no_id='+$(this).parents('.notice_cen').attr('attr'), function(data) {
            if (data == 1) {
                showMessage('发布成功', 1);
                obj.html('再次发布');
            }
        })
    })
})
</script>
<div class="warp">
    <include file="Public:leftSider"/>
    <ul class="top_tab_menu fl">
        <li class="tab_return">返回</li>
        <li class="tab_name">{$class.s_id|replaceClassTitle=$class['c_type'],$class['c_grade'],$class['c_title'],$class['is_graduation']}</li>
        <li onclick="javascript:location.href='__URL__/teachers/id/{$class.c_id}'">任课老师</li>
        <li onclick="javascript:location.href='__URL__/student/id/{$class.c_id}'">同学们</li>
        <li onclick="javascript:location.href='__URL__/group/id/{$class.c_id}'">小组</li>
        <eq name="isBeanOpen" value="1">
            <li onclick="javascript:location.href='__URL__/honor/id/{$class.c_id}'">光荣榜</li>
        </eq>
        <li class="selected">通知</li>
        <li onclick="javascript:location.href='__URL__/syllabus/id/{$class.c_id}'">课程表</li>
    </ul>
    <div class="creat_c_mainBox stu_crere">
        <div class="notice_hea">
            <a class="notice_ask">新增通知</a>
        </div>
        <div class="notice_over">
            <neq name="notice.list" value="">
                <volist name="notice.list" id="vo">
                    <div class="notice_cen" attr="{$vo.no_id}">
                        <p class="stu_bold">
                            <span>对</span>
                            <span class="hon_content">{$vo.show}</span>
                            <span>通知：</span>
                        </p>
                        <p class="stu_cen" title="{$vo.no_content}">{$vo.no_content}</p>
                        <p class="stu_click"><eq name="vo.no_published" value="0">{$vo.no_created|toDate='Y-m-d H:i'}<else/>{$vo.no_published|toDate='Y-m-d H:i'}</eq>
                            <a class="published"><eq name="vo.no_published" value="0">发布<else/>再次发布</eq></a>
                            <a class="click_remode">删除</a>
                        </p>
                    </div>
                </volist>
            <else/>
                <div class="font">暂无通知</div>
            </neq>
        </div>
        <div class="page">{$notice.page}</div>
    </div>
</div>
<!--弹窗-->
<div class="notice_pop" title="发布通知">
    <div>
        <label class="pop_lab">通知内容：</label>
        <textarea></textarea>
    </div>
    <div class="clear"></div>
    <div>
        <label class="pop_lab">通知人：</label>
        <p class="notice_main">
            <span attr="{$class.c_id}" class="selectAll">全选</span>
            <volist name="students" id="stu">
                <span attr="{$stu.a_id}">{$stu.a_nickname}</span>
            </volist>
        </p>
    </div>
</div>
<include file="Public:footer"/>