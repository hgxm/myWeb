<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<load href="__PUBLIC__/Css/Ilc/lead.css"/>
<script>
$(function(){

    //checkbox 按钮
    $(document).on('click','input[name=allcheck]',function(){
        if($(this).is(':checked')){
            $('.data_main .data_check').prop('checked',true)
        }else{
            $('.data_main .data_check').prop('checked',false)
        }
    })

    //禁用，发布等 按钮的 滑入滑利效果
    $('.handle_operate li').hover(function(){
        var oldName = $(this).attr('class');
        $(this).removeClass(oldName).addClass(oldName+'_on');
    },function(){
        var oldName = $(this).attr('class');
        var oLen = oldName.length - 3;
        var newName = oldName.substring(0,oLen);
        //.str.slice(0,-3);
        $(this).removeClass(oldName).addClass(newName);
    })

    //cheaked选中事件
    $(document).on('change','.data_main .data_check',function(){
        if ($(this).is(":checked")) {
            $(this).parent().addClass('del_on');
        } else {
            $(this).parent().removeClass('del_on');
        }
    })

    //删除按钮 点击
    $('.tools .del').click(function(){
        if ($('.data_main .del_on').size() == 0)
        {
            showMessage('请选择删除项');
            return false;
        } else {
            if (confirm('你确定要删除吗')){
                $('.data_main .del_on').remove();
            } else {
                return false;
            }
        }
    })

    //禁用按钮点击
    $('.tools .forbidden').click(function(){
        var t_true = true;
        if ($('.data_main .del_on').size() == 0) {
            showMessage('请选择禁用项');
            return false;
        } else {
            t_true = true;
        }

        $('.data_main .del_on').each(function(){
            if ($(this).hasClass('dal_res')) {
                t_true = false;
            } else {
                t_true = true;
            }
        })

        if (t_true == true) {
            if (confirm('你确定要禁用吗')) {
                $('.data_main .del_on').children('.data_tran').html("<img src='/Public/Images/Ilc/jy_status.gif'>");
                $('.data_main .del_on').children('.data_state').text('启用');
                $('.data_main .del_on').addClass('dal_res');
            } else {
                return false;
            }
        }
    })

    // 启用按钮点击
    $('.tools .resume').click(function(){
        var t_true = true;
        if ($('.data_main .del_on').size() == 0) {
            showMessage('请选择启用项');
            t_true = false;
            return false;
        } else {
            t_true = true;
        }

        if ($('.data_main .del_on').hasClass('dal_res')) {
            t_true = true;
        } else {
            t_true = false;
            return false;
        }

        if (t_true == true) {
            if (confirm('你确定要启用吗')) {
                $('.data_main .del_on').children('.data_tran').html("<img src='__APPURL__/Public/Images/Ilc/qy_status.png'/>");
                $('.data_main .del_on').removeClass('dal_res');
                $('.data_main .del_on').children('.data_state').text('禁用');
            } else {
                return false;
            }
        }
    })


    //小三角图标
    $('.colu_arrow').addClass($('.colu_carte li.car_click').attr('attr'));

    //弹窗span点击
    $(document).on('click','.mod_type span',function(){
        if ($(this).hasClass('on')) {
            $(this).removeClass('on')
        } else {
            $(this).addClass('on').siblings().removeClass('on');
        }
    })

    // 栏目选择
    $(document).on('click', '.choose', function() {
        getChild(0);
        $('.list').show();
    })

    // 获取子栏目
    $(document).on('click', '.list li', function() {

        var level = $(this).attr('level');
        $('.list li').each(function() {
            if ($(this).attr('level') > level) {
                $(this).remove();
            }
        })
        $(this).addClass('on').siblings().removeClass('on');
        getChild($(this).attr('attr'));
    })

    // 数据列表
    getDataList();

    // 点击搜索列表
    $('.search').click(function(){
        getDataList();
    });

})


function getChild(id, s_id) {

    var str = '';
    if ($('.list li').size() == 0) {
        str += '<li attr="0" level="0" type="{$authInfo[\'s_id\']}">本校栏目</li>';
        $('.list ul').html(str);return;

    } else {

        if ($('.list').css('display') == 'none') {
            $('.list').show();
        } else {
            $.post('/AuthResource/findSub', 'id='+id, function(json) {
                var str = '';

                if (json) {
                    $.each(json, function(i, data){

                        if (data['rc_pid'] == id && data['s_id'] == $('.list li.on').attr('type')) {
                            str += '<li attr="' + data['rc_id'] + '" level="' + data['rc_level'] + '" type="' + data['s_id'] + '">' + getLevel(data['rc_level']) + data['rc_title'] + '</li>';
                        }
                    })
                }

                if (!str) {
                    var t_val = $('.list li.on').html();
                    var reg=/&nbsp;/g;
                    var new_val = t_val.replace(reg,'');
                    $('.choose').html(new_val);
                    $('.choose').attr('attr', $('.list li.on').attr('attr'));
                    $('.list.on').removeClass('on');
                    $('.list').hide();
                } else {
                    $(str).insertAfter($('.list li.on'));
                    $('.list').show();
                }

            }, 'json')
        }
    }
}

function getLevel(level) {

    var result = '';
    for (var i = 0; i < level; i ++) {

        result += '&nbsp;&nbsp;&nbsp;&nbsp;';
    }

    return result;
}

// 获取资源列表
function getDataList(p) {

    p = p ? p : 1;

    var parm = 'p='+p;

    if ($('input[name=re_title]').val() != '') {
        parm += '&re_title='+$('input[name=re_title]').val();
    }

    if ($('.choose').attr('attr') != undefined) {
        parm += '&rc_id='+$('.choose').attr('attr');
    }

    $.post('__URL__/lists', parm, function(json){

        var str = '';

        if (json.list) {

            for (var i = 0; i < json.list.length; i ++) {

                str += '<li><input type="checkbox" name="key" class="data_check" value="'+json.list[i]['re_id']+'"/><span class="data_id">'+json.list[i]['re_id']+'</span><span class="data_name">'+json.list[i]['m_title']+'</span><span class="data_name" title="'+json.list[i]['re_title']+'">'+json.list[i]['re_title']+'</span><span class="data_pop">'+json.list[i]['a_nickname']+'</span><span class="data_integral">'+json.list[i]['re_download_points']+'分</span><span class="data_tran" attr="'+json.list[i]['re_is_pass']+'">';

                if (json.list[i]['re_is_pass'] == 1) {
                    str += '通过';
                } else {
                    str += '未审核';
                }

                str += '</span><span class="data_opera" onclick="edit('+json.list[i]['re_id']+')">进入</span></li>';
            }

        } else {
            str += '<li><span style="padding-left:350px;">暂无数据</span></li>';
        }

        $('.data_main').html(str);
        $('.page').html(json.page);

        setWidth({'data_check':'2%','data_id':'8%','data_name':'18%','data_type':'18%','data_tran':'10%','data_pop':'10%','data_integral':'16%','data_opera':'10%'});

    }, 'json');
}

// 数据分页
function getList(p) {
    getDataList(p);
}

// 审核资源是否通过
function resPass(type) {

    keyValue = getSelectCheckboxValues();

    if (!keyValue) {
        showMessage('请选择操作项！');
        return false;
    }

    $.post(URL+'/resPass', 'id='+keyValue+'&type='+type, function(json){

        if (json) {

            if (type == 1) {
                $("input[name=key]:checked").each(function(){
                    $(this).parents('li').remove();
                })
            }

            if (type == 0) {
                $("input[name=key]:checked").each(function(){
                    $(this).parents('li').remove();
                })
            }

        } else {
            showMessage('操作失败');
        }
    });
}

// 编辑
function edit(id) {
    location.href = URL+"/edit/id/"+id;
}

</script>
<div class='warp'>
<include file="Public:left"/>
<div class="colu_right">
    <ul class="colu_carte">
        <volist name="secondList" id="selist">
            <li attr="{$selist['sn_name']}" <eq name="selist.sn_name" value="ResourceExamine">class="car_click"</eq>><a href="__APPURL__{$selist['sn_url']}">{$selist['sn_title']}</a></li>
        </volist>
    </ul>
    <div class="colu_arrow">
        <image src="__APPURL__/Public/Images/Ilc/resource_arrow.png"/>
    </div>
    <div class="colu_main lead_center">
        <div class="model_search">
            <a>名称：</a>
            <input type="text" name="re_title" value=""/>
            <a class="search">搜索</a>
            <div class="pub_name">
            <a>栏目：</a>
            <span class="choose" style="margin-left:20px;">选择</span>
            </div>
            <div class="list">
                <ul>

                </ul>
            </div>
        </div>
        <div class="tools fl">
            <span class="pass" onclick="resPass(1)"><i></i>通过</span>
            <span class="unpass" onclick="resPass(0)"><i></i>不通过</span>
            <!--span class="forbidden"><i></i>禁用</span>
            <span class="resume"><i></i>启用</span-->
        </div>
        <ul class="handle_data data_hea">
            <li>
                <input type="checkbox" name="allcheck" class="data_check"/>
                <span class="data_id">编号</span>
                <span class="data_type">类型</span>
                <span class="data_name">名称</span>
                <span class="data_pop">发布人</span>
                <span class="data_integral">积分</span>
                <span class="data_tran">状态</span>
                <span class="data_opera">操作</span>
            </li>
        </ul>
        <ul class="handle_data data_main">
        </ul>
    </div>
    <div class="page"></div>
</div>
</div>
<include file="Public:footer"/>