//
//  ViewController.m
//  ClassRoomTeacher
//
//  Created by apple  on 13-6-3.
//  Copyright (c) 2013年 apple . All rights reserved.
//

#import "ViewController.h"
#import "HomeViewController.h"
#import "LoginView.h"
#import "SetView.h"

#import "LocalViewController.h"
#import "RecordViewController.h"
#import "TuyaViewController.h"
#import "NoteViewController.h"
@interface ViewController ()

@end

@implementation ViewController
-(void)mySuccessImage:(id)sender{
    
    AppDelegate *dele = [[UIApplication sharedApplication]delegate];
    NSString *str = [sender responseString];
    NSLog(@"str is %@",str);
    NSDictionary *dict1 = [str JSONValue];
    if ([dict1 isKindOfClass:[NSArray class]]) {
        
    }else{
        
        NSDictionary *dict = [[str JSONValue] mutableCopy];
        dispatch_async(dispatch_get_global_queue(0, 0), ^(void){
            NSString *strURL = [NSString stringWithFormat:@"%@%@",dele.server_Address_str,[dict objectForKey:@"client_index_pic"]];
            NSData *data = [[NSData alloc]initWithContentsOfURL:[NSURL URLWithString:strURL]];
            UIImage *image = [[UIImage alloc] initWithData:data];
            [data release];
            
            dispatch_async(dispatch_get_main_queue(), ^(void){
                
                
                UIImageView *backImage2 = (UIImageView *)[self.view viewWithTag:11];
                backImage2.image = image;
                [image release];
                
                
            });
        });
    }
    
  

}
-(void)myError:(id)sender{
    
    NSLog(@"error is %@",sender);
}
- (void)viewDidLoad
{
    [super viewDidLoad];
    self.view.backgroundColor=[UIColor clearColor];
   
    
    UIImageView *backImage = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0, 1024, 748)];
    backImage.image = [UIImage imageNamed:@"背景.jpg"];
    [self.view addSubview:backImage];
    [backImage release];
    
       
    UIImageView *backImage2 = [[UIImageView alloc] initWithFrame:CGRectMake(28, 130, 661, 355)];
    backImage2.image = [UIImage imageNamed:@"黑板.jpg"];
    backImage2.tag = 11;
    [self.view addSubview:backImage2];
    [backImage2 release];
    


    
    
     AppDelegate *dele = [[UIApplication sharedApplication]delegate];

    NSString *strIP=[[NSUserDefaults standardUserDefaults]objectForKey:@"IP"];
    if (!strIP) {
        strIP=@"";
    }else{
        dele.server_Address_str=[NSString stringWithFormat:@"http://%@",strIP];
    }
    

    
    
     ASIFormDataRequest *requestOther = [[ASIFormDataRequest alloc]initWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"%@/apps/manage/Api",dele.server_Address_str]]];
     [requestOther setDelegate:self];
     
     
     NSMutableDictionary *postDict=[[NSMutableDictionary alloc]init];
     
     NSString *timeString =[ToolClass getCurretDate];
     [postDict setObject:timeString forKey:@"ts"];
     [postDict setObject:@"1234242" forKey:@"args[num]"];
     [postDict setObject:@"JSON" forKey:@"format"];
     [postDict setObject:@"Public.clientInit" forKey:@"method"];

    
     NSString *strSign=[ToolClass getSign:postDict];
     
     [postDict setObject:[MyMD5 md5:strSign] forKey:@"sign"];
     for(int i=0;i<[[postDict allKeys] count];i++){
     
     [requestOther setPostValue:[[postDict allValues]objectAtIndex:i] forKey:[[postDict allKeys]objectAtIndex:i]];
     }
    
    NSLog(@"postdict is %@",postDict);
    
     [requestOther buildPostBody];
     [requestOther setTimeOutSeconds:30];
     [requestOther startAsynchronous];
     [requestOther setDidFinishSelector:@selector(mySuccessImage:)];
     [requestOther setDidFailSelector:@selector(myError:)];
     
     [postDict release];
     [strSign release];
     
     

     
    
    for (int i=0; i<5; i++) {
        UIButton *btn = [[UIButton alloc] initWithFrame:CGRectMake(28+i*136, 500, 126, 126)];
        [self.view addSubview:btn];
        [btn addTarget:self action:@selector(btnClicks:) forControlEvents:UIControlEventTouchUpInside];
        btn.tag=i+1;
        [btn release];
        
        
        UILabel *lbl = [[UILabel alloc]initWithFrame:CGRectMake(38+i*136, 500+126, 126, 30)];
        lbl.textAlignment = NSTextAlignmentLeft;
        lbl.backgroundColor = [UIColor clearColor];
        lbl.textColor = [UIColor whiteColor];
        [self.view addSubview:lbl];
        [lbl release];
        
        
        switch (i) {
            case 0:
                [btn setImage:[UIImage imageNamed:@"本地资源.png"] forState:UIControlStateNormal];
                lbl.text=@"本地资源";
                break;
            case 1:
                [btn setImage:[UIImage imageNamed:@"涂鸦.png"] forState:UIControlStateNormal];
                lbl.text=@"涂鸦";
                break;
            case 2:
                [btn setImage:[UIImage imageNamed:@"记事本.png"] forState:UIControlStateNormal];
                lbl.text=@"记事本";
                break;
            case 3:
                [btn setImage:[UIImage imageNamed:@"录音机.png"] forState:UIControlStateNormal];
                lbl.text=@"录音机";
                break;
            case 4:
                [btn setImage:[UIImage imageNamed:@"拍照.png"] forState:UIControlStateNormal];
                lbl.text=@"拍照/摄像";
                break;
                
            default:
                break;
                
        }
        
    }
    
    
    for (int i=0; i<2; i++) {
        UIButton *btn = [[UIButton alloc] initWithFrame:CGRectMake(870+i*70, 10, 53, 53)];
        [self.view addSubview:btn];
        [btn addTarget:self action:@selector(btnClicksSet:) forControlEvents:UIControlEventTouchUpInside];
        btn.tag=i+10;
        [btn release];
        switch (i) {
            case 0:
                [btn setImage:[UIImage imageNamed:@"版本.png"] forState:UIControlStateNormal];
                break;
            case 1:
                [btn setImage:[UIImage imageNamed:@"设置.png"] forState:UIControlStateNormal];
                break;
                
            default:
                break;
                
        }
    }
    

    
    UIButton *homeBtn = [[UIButton alloc] initWithFrame:CGRectMake(920, 657, 53, 48)];
    [self.view addSubview:homeBtn];
    homeBtn.hidden = YES;
    [homeBtn setImage:[UIImage imageNamed:@"主页.png"] forState:UIControlStateNormal];
    [homeBtn addTarget:self action:@selector(homeBtnClicks) forControlEvents:UIControlEventTouchUpInside];
    [homeBtn release];
    
    LoginView *login = [[LoginView alloc]initWithFrame:CGRectMake(700, 140, 316, 270+40)];
    login.delegate = self;
    [self.view addSubview:login];
    [login release];
	// Do any additional setup after loading the view, typically from a nib.
}
-(void)btnClicksSet:(UIButton *)btn{
    
    if (btn.tag==11) {
        SetView *setv = [[SetView alloc]initWithFrame:CGRectMake(0, 0, 1024, 748)];
        [self.view addSubview:setv];
        [setv release];
    }
}
-(void)btnClicks:(UIButton *)btn{
    
    if (btn.tag == 5) {
        UIImagePickerController *picker = [[UIImagePickerController alloc] init];
        
        if([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
            picker.sourceType = UIImagePickerControllerSourceTypeCamera;
            NSArray *temp_MediaTypes = [UIImagePickerController availableMediaTypesForSourceType:picker.sourceType];
            picker.mediaTypes = temp_MediaTypes;
            picker.delegate = self;
            [self presentModalViewController:picker animated:YES];
            [picker release];

        }else{
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:@"您的设备不支持拍照!" delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
            [alert show];
            [alert release];
        }
        
        
        
    }
    if (btn.tag == 1) {
        
        LocalViewController *localView = [[LocalViewController alloc] init];
        [self.navigationController pushViewController:localView animated:YES];
        [localView release];
    }
    if (btn.tag == 2) {
        
        TuyaViewController *tyvc = [[TuyaViewController alloc]init];
        [self.navigationController pushViewController:tyvc animated:YES];
        [tyvc release];
    }
    if (btn.tag == 3) {
        
        NoteViewController *note = [[NoteViewController alloc]init];
        [self.navigationController pushViewController:note animated:YES];
        [note release];
    }
    
    if (btn.tag == 4) {
        
        RecordViewController *recordVc = [[RecordViewController alloc] init];
        [self.navigationController pushViewController:recordVc animated:YES];
        [recordVc release];
    }
}

//下面两个函数是遵守UIImagePickerControllerDelegate这个协议所实现的类.这样就能够完整的实现,获取照片或者视频,然后写入文件的过程.
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info
{
    
    NSString *mediaType = [info objectForKey:UIImagePickerControllerMediaType];
    tempPicker = picker;
    
       
    NSLog(@"info is %@",info);
    if ([mediaType isEqualToString:@"public.image"]){
        
        UIImage *image = [info objectForKey:@"UIImagePickerControllerOriginalImage"];
        fileData = [UIImageJPEGRepresentation(image, 1.0f) mutableCopy] ;

        type = 1;
       
        /*
        
        */
        
        //SETIMAGE(image);
        //CFShow([[NSFileManager defaultManager] directoryContentsAtPath:[NSHomeDirectory() stringByAppendingString:@"/Documents"]]);
    }
    else if([mediaType isEqualToString:@"public.movie"]){
        NSURL *videoURL = [info objectForKey:UIImagePickerControllerMediaURL];
        NSLog(@"%@", videoURL);
        NSLog(@"found a video");
        
        fileData = [[NSData dataWithContentsOfURL:videoURL] mutableCopy];
        type = 2;
        //NSData *videoData = [NSData dataWithContentsOfURL:videoURL];
        
        /****************************************/
        
//        NSString *videoFile = [documentsDirectory stringByAppendingPathComponent:@"temp.mov"];
//        NSLog(@"%@", videoFile);
//        
//        success = [fileManager fileExistsAtPath:videoFile];
//        if(success) {
//            success = [fileManager removeItemAtPath:videoFile error:&error];
//        }
       // [videoData writeToFile:videoFile atomically:YES];
        //CFShow([[NSFileManager defaultManager] directoryContentsAtPath:[NSHomeDirectory() stringByAppendingString:@"/Documents"]]);
        //NSLog(videoURL);
    }
    
    UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"请输入文件保存名字" message:@"\n\n\n" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确定", nil];


    UITextField *textField3 = [[UITextField alloc]initWithFrame:CGRectMake(10, 70, 260, 30)];
    [textField3 setBorderStyle:UITextBorderStyleRoundedRect];
    textField3.tag = 10;
    textField3.text = @"";
    textField3.backgroundColor = [UIColor clearColor];
    [alert addSubview:textField3];
    [textField3 release];
    
    [textField3 becomeFirstResponder];
    
    [alert show];
    [alert release];
}

- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
    
    [picker dismissModalViewControllerAnimated:YES];
    
}
- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    
    
    NSString *strTitle = ((UITextField *)[alertView viewWithTag:10]).text;
    NSLog(@"str is %@",strTitle);

   
    
    if (buttonIndex == 1) {
        BOOL success;
        NSFileManager *fileManager = [NSFileManager defaultManager];
        NSError *error;
        
        
        NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
        NSString *documentsDirectory = [paths objectAtIndex:0];
        
        NSString *strName = @"";
        if (type == 1) {
            strName = [NSString stringWithFormat:@"%@.jpg",[ToolClass getCurretDate]];
        }else if(type == 2){
            
            strName = [NSString stringWithFormat:@"%@.mp4",[ToolClass getCurretDate]];
        }
        
        NSString *imageFile = [documentsDirectory stringByAppendingPathComponent:strName];
        NSLog(@"%@", imageFile);
        
        success = [fileManager fileExistsAtPath:imageFile];
        if(success) {
            success = [fileManager removeItemAtPath:imageFile error:&error];
        }

        [fileData writeToFile:imageFile atomically:YES];
        
        NSString *dbName =[NSString stringWithFormat:@"%@.db",@"local"];
        NSString *dbPath = [documentsDirectory stringByAppendingPathComponent:dbName];
        FMDatabase *db = [FMDatabase databaseWithPath:dbPath];
        if (![db open]) {
            //NSLog(@"Could not open db.");
        }
        [db executeUpdate:@"INSERT INTO resour_table(re_id,type,re_title,localURL) VALUES (?,?,?,?)",@"",[NSString stringWithFormat:@"%d",type],strTitle,strName];
        
    }
    
    [tempPicker dismissModalViewControllerAnimated:YES];
    
    
    
   

}
-(void)homeBtnClicks{
    
    
    HomeViewController *homeVc = [[HomeViewController alloc]init];
    [self.navigationController pushViewController:homeVc animated:YES];
    [homeVc release];
}
- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}



#if __IPHONE_OS_VERSION_MAX_ALLOWED >= __IPHONE_6_0

-(NSUInteger)supportedInterfaceOrientations
{
    return UIInterfaceOrientationMaskLandscape;
}

- (BOOL)shouldAutorotate {
    return YES;
}

#endif
// Override to allow orientations other than the default portrait orientation.
- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation
{
    // Return YES for supported orientations
    return (interfaceOrientation == UIInterfaceOrientationLandscapeLeft  ||
            interfaceOrientation == UIInterfaceOrientationLandscapeRight);
    
}

-(void)dealloc{
    
    [fileData release];
    [super dealloc];
}

@end
