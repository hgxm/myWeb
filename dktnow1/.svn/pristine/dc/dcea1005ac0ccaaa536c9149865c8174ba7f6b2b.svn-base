//
//  AvPlayer.m
//  iPhoneStreamingPlayer
//
//  Created by apple  on 13-1-14.
//
//

#import "AvPlayer.h"

@implementation AvPlayer
@synthesize deleDelegate;
-(void)startPlay{
    
    [self buttonPressed:playBtn];
}
-(void)stopPlay{
    [player stop];
}
-(void)buttonPressed:(UIButton *)button{
    
    if(player.playing)
    {

        if (processTimer) {
            [processTimer invalidate];
            processTimer=nil;
        }
        
        [playBtn setImage:[UIImage imageNamed:@"播放.png"] forState:UIControlStateNormal];
        [player pause];

    }
    
    else
    {
         processTimer=[NSTimer scheduledTimerWithTimeInterval:0.1 target:self selector:@selector(process) userInfo:nil repeats:YES];
        
        [playBtn setImage:[UIImage imageNamed:@"暂倯.png"] forState:UIControlStateNormal];
        [player play];
    }
}
- (id)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        // Initialization code
        UIImageView *backImage=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, self.frame.size.width, self.frame.size.height)];
        backImage.image=[UIImage imageNamed:@"音频背景.png"];
        backImage.userInteractionEnabled=YES;
        [self addSubview:backImage];
        [backImage release];
        
        UIPanGestureRecognizer *panGestureCaogao = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(panPieceCaogao:)];
        [panGestureCaogao setMaximumNumberOfTouches:2];
        [backImage addGestureRecognizer:panGestureCaogao];
        [panGestureCaogao release];
        
        lblTitle=[[UILabel alloc]initWithFrame:CGRectMake(10, 15, 300, 30)];
        
        lblTitle.textColor=[UIColor colorWithRed:104.0/255 green:169.0/255 blue:236.0/255 alpha:1];
        lblTitle.font=[UIFont boldSystemFontOfSize:14];
        lblTitle.backgroundColor=[UIColor clearColor];
        [self addSubview:lblTitle];
        [lblTitle release];
        
        currentLbl=[[UILabel alloc]initWithFrame:CGRectMake(55, 55, 30, 30)];
        currentLbl.text=@"0:00";
        currentLbl.font=[UIFont systemFontOfSize:12];
        currentLbl.backgroundColor=[UIColor clearColor];
        [self addSubview:currentLbl];
        [currentLbl release];
        
        slider=[[UISlider alloc]initWithFrame:CGRectMake(90, 60,260, 20)];
        [slider addTarget:self action:@selector(sliderValue:) forControlEvents:UIControlEventValueChanged];
        [slider setMinimumValue:0];
        [slider setMaximumValue:100];
        [self addSubview:slider];
        [slider release];
        
        lastLbl=[[UILabel alloc]initWithFrame:CGRectMake(360, 55, 60, 30)];
        lastLbl.text=@"0:00";
        lastLbl.font=[UIFont systemFontOfSize:12];
        lastLbl.backgroundColor=[UIColor clearColor];
        [self addSubview:lastLbl];
        [lastLbl release];
        
        playBtn= [UIButton buttonWithType:UIButtonTypeCustom];
        playBtn.frame=CGRectMake(5, 45, 40, 40);
        playBtn.backgroundColor=[UIColor clearColor];
        [playBtn setImageEdgeInsets:UIEdgeInsetsMake(10, 0, 0, 0)];
        [playBtn setContentVerticalAlignment:UIControlContentVerticalAlignmentCenter];
        [playBtn setImage:[UIImage imageNamed:@"播放.png"] forState:UIControlStateNormal];
        [playBtn addTarget:self action:@selector(buttonPressed:) forControlEvents:UIControlEventTouchUpInside];
        [self addSubview:playBtn];
        
       
        
        UIButton *closeBtn=[[UIButton alloc]initWithFrame:CGRectMake(self.frame.size.width-50, 15, 32, 32)];
        closeBtn.backgroundColor=[UIColor clearColor];
        [closeBtn addTarget:self action:@selector(closeBtnAction) forControlEvents:UIControlEventTouchDown];
        [closeBtn setImage:[UIImage imageNamed:@"关闭.png"] forState:UIControlStateNormal];
        [self addSubview:closeBtn];
        [closeBtn release];
       
    }
    return self;
}
-(void)setlblTitle:(NSString *)strTitle{
    
    
    lblTitle.text=strTitle;
    
}

-(void)initPlayer:(NSString *)strFile{
//    NSString *strFilePath=[[[NSBundle mainBundle]resourcePath] stringByAppendingPathComponent:@"江南style.mp3"];
    
    //NSLog(@"filePath is %@",strFile);
    
    NSError *errror;
    player=[[AVAudioPlayer alloc]initWithContentsOfURL:[NSURL fileURLWithPath:strFile] error:&errror];
    player.delegate=self;
    [player prepareToPlay];
    
    
    [self changeTimeLabel];

}
-(void)closeBtnAction{
    [player stop];
    if (deleDelegate && [deleDelegate respondsToSelector:@selector(removeMyselfAvPlayer:)]) {
        [deleDelegate removeMyselfAvPlayer:self];
    }
    [self removeFromSuperview];
}
-(void)panPieceCaogao:(UIPanGestureRecognizer *)gestureRecognizer{
    
    UIView *piece = [[gestureRecognizer view] superview];
	if ([gestureRecognizer state] == UIGestureRecognizerStateBegan || [gestureRecognizer state] == UIGestureRecognizerStateChanged) {
        
        [[self superview] bringSubviewToFront:self];
        
		CGPoint translation = [gestureRecognizer translationInView:[piece superview]];
        [piece setCenter:CGPointMake([piece center].x + translation.x, [piece center].y+ translation.y)];
        
        
        CGRect rect=piece.frame;
        if (rect.origin.y<=0) {
            rect.origin.y=0;
        }
        if (rect.origin.x<=0) {
            rect.origin.x=0;
        }
        if (rect.origin.x+rect.size.width>=1024) {
            rect.origin.x=1024-rect.size.width;
        }
        if (rect.origin.y+rect.size.height>=748) {
            rect.origin.y=748-rect.size.height;
        }
        

        piece.frame=rect;
        
		[gestureRecognizer setTranslation:CGPointZero inView:[piece superview]];
	}
}
-(void)changeTimeLabel{
    
    currentLbl.text=[self getMin:(int)player.currentTime];
    lastLbl.text=[NSString stringWithFormat:@"-%@",[self getMin:(int)(player.duration-player.currentTime)]];
}
-(NSString *)getMin:(int)lasttime{
    
    int min = lasttime/60;
    int second=lasttime%60;
    
    if (second<10) {
        return [NSString stringWithFormat:@"%d:0%d",min,second];
    }
    
    return [NSString stringWithFormat:@"%d:%d",min,second];
}
- (void)audioPlayerDidFinishPlaying:(AVAudioPlayer *)player successfully:(BOOL)flag{
    if (processTimer) {
        [processTimer invalidate];
        processTimer=nil;

    }
//    slider.value=0;
    [playBtn setImage:[UIImage imageNamed:@"播放.png"] forState:UIControlStateNormal];
//    [self changeTimeLabel];
    
}
-(void)process{
    
   
    [self changeTimeLabel];
    
    slider.value= 100*player.currentTime/player.duration;
    

}
-(void)sliderValue:(UISlider *)_slider{
    
    if (_slider.value==_slider.maximumValue) {

        
    }else{
        [self changeTimeLabel];
        player.currentTime=slider.value/100*player.duration;
        if(player.playing==YES)
            [player playAtTime:player.currentTime];
    }
  
}
-(void)dealloc{
    if (processTimer) {
        [processTimer invalidate];
        processTimer=nil;
    }

    [player release];
    [super dealloc];
}
/*
// Only override drawRect: if you perform custom drawing.
// An empty implementation adversely affects performance during animation.
- (void)drawRect:(CGRect)rect
{
    // Drawing code
}
*/

@end
