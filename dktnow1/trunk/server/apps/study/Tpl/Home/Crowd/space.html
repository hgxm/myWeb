<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/group_home.css"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<script type="text/javascript">
var croId = '{$crowd.cro_id}';
$(function(){

    // 隐藏专业
    $('.major').hide();

    // 显示动态
    getTrend();

    // 点击查看更多
    $(document).on('click', '.get_more', function(){
        getTrend($(this).attr('attr'));
    })

    $('.classmain_number').hide();

    // 记录一开始的需要审核的群组数量
    var checkNum = $('.check_auth .group_content').size();

    // 切换
    $('.member_title span').click(function(){

        $(this).addClass("member_leagure").siblings().removeClass("member_leagure");
        $(".leagure_html").children('div').css('display','none');
        $(".leagure_html").children('div').eq($(this).index()).css('display','block');

        // 如果点击成员时，审核的群组数量少了，则说明已经审核了，需要刷新页面
        if ($(this).index() == 1 && checkNum > $('.check_auth .group_content').size()) {
            location.reload(true);
        }
        if ($(this).index() == 3) {
            $('.check_auth').css('display','block');
        } else {
            $('.check_auth').css('display','none');
        }
    }).eq(0).click();

    // 添加成员按钮
    $('.gro_app').mouseover(function(){
        $(this).addClass('gro_appd');
    }).mouseout(function(){
        $(this).removeClass('gro_appd')
    })

    // 添加成员
    $(document).on('click','.gro_app',function(){

        // 进行初始化
        $(".classmain_number").hide();
        $('select[name=school_type_option]').val(0);
        $('select[name=grade]').val(0);
        $('input[name=authName]').val('');
        $(".found_classname").show();
    });

    // 添加成员弹窗
    $(document).on('click','.classmain_number li',function(){
        if (!$(this).hasClass('still')) {
            if ($(this).hasClass('on')) {
                $(this).removeClass('on');
            } else {
                $(this).addClass('on');
            }
        }
    })

    //查询
    $(document).on('click','.classname_search',function(){

        var schoolType = $("select[name=school_type_option]").val();
        var grade = $("select[name=grade]").val();
        var authName = $("input[name=authName]").val();

        $.post("__URL__/searchAuth", 'schoolType=' + schoolType + '&grade=' + grade + '&authName=' + authName, function(json){
            var attr = '';
            if (json) {

                var still = ',';
                $('.group_content').each(function() {
                    still += $(this).attr('attr') + ',';
                })

                var str = "<ul>";
                var tmp = '';
                for (var i = 0; i < json.length; i++) {
                    tmp = ','+json[i]['a_id']+',';

                    if (still.indexOf(tmp) != -1) {
                        str += '<li class="still" attr="'+json[i]['a_id']+'">'+json[i]['a_nickname']+'</li>';
                    } else {
                        str += '<li attr="'+json[i]['a_id']+'">'+json[i]['a_nickname']+'</li>';
                    }
                }

                str += "</ul>";
                $(".classmain_number").html(str);
            } else {
                // 未找到用户
                $(".classmain_number").html('未找到匹配的用户');
            }
        },'json');
        $('.classmain_number').show();
    })

    $(document).on('click','.gro_app',function(){
        $(".found_classname").dialog("open");
    })

    // 添加成员弹出窗口
    $(".found_classname").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '546',
        height: 'auto',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
          effect: "explode",
          duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {

                var str = "";

                // 记录用户ID
                $(".classmain_number li.on").each(function() {

                    str += ',' + $(this).attr('attr');
                });

                // 添加用户
                if (str != '') {
                    var obj = $(this);
                    $.post("__URL__/addCrowdAuth", 'aidStr=' + str + '&croId=' + croId, function(json) {

                        if (json['status'] == 1) {

                            location.reload(true);

                        } else {
                            showMessage(json['info']);
                        }
                    },'json');
                } else {
                    showMessage('请选择用户');
                }
            },
            取消: function() {

                $(this).dialog('close');
            }
        }
    });

    $("select[name=school_type_option]").change(function() {

        var choose_type = $("select[name=school_type_option] option:selected").attr('value');

        if (choose_type == 4) {
            $('.major').show();
            listGradeOption(choose_type, 'major', 0);
            $("select[name=grade]").html('<select name="grade"><option value="0">请选择</option></select>');
        } else {
            $('.major').hide();
        listGradeOption(choose_type, 'grade', 0);
        }
    });

    $("select[name=major]").change(function() {

        var choose_type = $("select[name=major] option:selected").attr('value');

        if (choose_type != 0) {
            listGradeOption(choose_type, 'grade', 0, 'major');
        }

    });

    $(document).on('click','.del', function(){
        if (window.confirm('确定要删除该成员吗？')) {

            var obj = $(this).parents('.group_content');
            $.post('__URL__/deleteAuth', 'authId=' + obj.attr('attr') + '&croId=' + croId, function(json){
                if (json['status'] == 1) {

                    obj.remove();

                } else {
                    showMessage(json['info']);
                }
            }, 'json');
        }
    })

    //群组名称验证
    $('input[name=cro_title]').blur(function(){
        var oVal = $(this).val();
        String.prototype.trim = function(){
            return this.replace(/[ ]/g,'')
        }
        var newVal = oVal.trim();
        if (newVal == '') {
            $(this).next().text('请输入群组名称').css('color','red');
            return false;
        }

        if (newVal.length < 7) {
            $(this).next().text('');
            $(this).next().append("<img src='__APPURL__/Public/Images/Home/true.png'/>");
        } else {
            $(this).next().text('输入的格式不正确，请重新输入').css('color','red').focus();
            return false;
        }
    })
    $('input[name=cro_title]').focus(function(){
        $(this).next().text('名称最多6个字符').css('color','gray');
    })

    // 允许
    $(document).on('click', '.allow', function () {
        $(this).parent().parent().addClass('on').siblings().removeClass('on');
        deleteCrowdCheck($(this).attr('ctype'), $(this).attr('cro_id'), $(this).attr('a_id'));
    });

    // 拒绝
    $(document).on('click', '.refuse', function () {
        $(this).parent().parent().parent().addClass('on').siblings().removeClass('on');
        deleteCrowdCheck($(this).attr('ctype'), $(this).attr('cro_id'), $(this).attr('a_id'))
    });

})

// 异步删除群组审核表的数据
function deleteCrowdCheck(type, cro_id, a_id) {

    $.post('__APPURL__/CrowdCheck/delete', {type:type, cro_id:cro_id, a_id:a_id}, function (json) {
        if (json.status == 1) {
            $('.check_auth div.on').remove();
        } else {
            showMessage(json.info);
        }
    }, 'json');
}

String.prototype.TextFilter=function(){
    var pattern=new RegExp("[/\<>]"); //[]内输入你要过滤的字符
    var rs="";
    for(var i=0;i<this.length;i++){
        rs+=this.substr(i,1).replace(pattern,'');
    }
    return rs;
}
function checkChar() {

    var uname = $('.tion_text').val();//通过ID取到texteara的值
    var txt=uname.TextFilter(); //调用上面的去字符方法
    if(txt!=uname){
        showMessage("您输入的内容含有限定字符");
        return false;
    }

    //群组名验证
    var tVal = $('input[name=cro_title]').val();
    var ntwVal = tVal.replace(/[ ]/g,'');
    if(ntwVal == ''){
        showMessage('请输入姓名');
        $('input[name=cro_title]').focus();
        return false;
    }
    if(ntwVal.length < 7 && ntwVal.length > 1){
    }else{
        showMessage('你输入的姓名格式不正确，请重新输入姓名');
        $('input[name=cro_title]').focus();
        return false;
    }
}

// 获取动态
function getTrend(p) {

    var cro_id = '{$crowd.cro_id}';
    p = p ? p : 1;

    $.post('__URL__/crowdTrend', 'cro_id='+cro_id+'&is_ajax=1&p='+p, function(json){

        if (json.list) {
            var str = '';
            var obj = json.list;
            var len = obj.length;

            for (var i = 0; i < len; i++) {

                str += '<li><img src="'+obj[i]['a_avatar']+'"/><div class="fl"><p><span>'+obj[i]['a_nickname']+'</span></p><p>'+obj[i]['tr_action']+'了&nbsp;<span>'+obj[i]['tr_obj']+'-'+obj[i]['tr_title']+'</span></p><p>'+obj[i]['tr_created']+'</p></li>';

            }
            if (len == 10) {
                $(".notrend").html("<a href='javascript:void(0);' attr='"+(json.page+1)+"' class='get_more'>点击查看更多</a>");
            } else {
                $(".notrend").html('');
            }

            $(".trends_content").append(str);

        } else {
            $(".notrend").html('');
        }

        if (!$(".trends_content li").size()) {
            $('.notrend').html('<a href="javascript:void(0);">暂无动态</a>');
        }

    }, 'json');

}
</script>
<div class="warp">
<include file="Public:leftSider"/>
    <div class="group_right fr">
        <ul class="fl" id="member_header">
            <a href="__URL__/index">返回</a>
            <li class="group_hover fl">{$crowd.cro_title}</li>
        </ul>
        <div class="group_center fl">
            <div class="member_title">
                <span class="member_leagure">动态</span>
                <span>成员</span>
                <span>信息</span>
                <span>审核</span>
            </div>
            <div class="leagure_html">
                <div class="member_tab fl" id="trends_title">
                    <ul class="trends_content">

                        <!--a class="trends_click notrend" href="javascript">点击查看更多</a-->
                    </ul>
                    <p class="notrend not_not">

                    </p>
                </div>
                <div class="fl crowd_auth">
                    <eq name='type' value='1'>
                        <div class="gro_app">
                            <a href="#">
                                <span></span>
                                <center>添加成员</center>
                            </a>
                        </div>
                    </eq>
                    <volist name='authList' id='authValue' key='k'>
                        <div class="group_content" attr="{$authValue.a_id}">
                            <img src="{$authValue.a_avatar|getAuthAvatar=$authValue['a_type'],$authValue['a_sex'],96}" width="96" height="96" class="fl"/>
                            <div class="fl">
                                <p class="gro_number">{$authValue.a_nickname}</p>
                                <eq name='type' value='1'>
                                    <a href="javascript:void(0);" class="del">删除</a>
                                </eq>
                            </div>
                        </div>
                    </volist>
                </div>
                <div class="informa_tion">
                    <div>
                        <form action="__URL__/update/" method="post" onsubmit="return checkChar();" enctype="multipart/form-data">
                            <span>群组名称：</span>
                            <eq name='type' value='1'>
                                <input type="text" name="cro_title" class="tion_text" value="{$crowd.cro_title}"/>
                            <else/>
                                <span>{$crowd.cro_title}</span>
                            </eq>
                            <p class="fl"></p>
                            <p class="clear"></p>
                            <span>群组图片：</span>
                            <img src="{$crowd.cro_logo|getCrowdLogo}"alt="{$crowd.cro_title}" title="{$crowd.cro_title}" width="96" height="96"/>
                            <p class="clear"></p>
                            <span>修改图片：</span>
                            <eq name='type' value='1'>
                                <span><input type="file" name="cro_logo" class="tion_file"/></span>
                                <div class="clear"></div>
                                    <input type="hidden" name="cro_id" value="{$crowd.cro_id}"/>
                                    <input type="submit" class="tion_submit" value="提交"/>
                                    <input type="reset" class="tion_reset" value="重置"/>
                                </div>
                            </eq>
                        </form>
                    </div>
                </div>
                <div class="fl crowd_auth check_auth">
                    <volist name='check' id='vo' key='k'>
                        <div class="group_content" attr="{$vo.a_id}">
                            <img src="{$vo.a_avatar|getAuthAvatar=$vo['a_type'],$vo['a_sex'],96}" width="96" height="96" class="fl"/>
                            <div class="fl">
                                <p class="gro_number">{$vo.a_nickname}</p>
                                    <a href="javascript:void(0);" ctype="1" cro_id="{$vo.cro_id}" a_id="{$vo.a_id}" class="allow">允许加入</a>
                                    <p><a href="javascript:void(0);" ctype="2" cro_id="{$vo.cro_id}" a_id="{$vo.a_id}" class="refuse">拒绝申请</a></p>
                            </div>
                        </div>
                    </volist>
                </div>
            </div>
        </div>
    </div>
    <div class="clear"></div>
    <div class="found_classname" title="添加成员">
        <div class="classname_main">
            <select name="school_type_option" class="school_ty">
               <option value="0">请选择</option>
               <volist name="schoolType" id="typ">
                    <option value="{$typ}">{$school_type[$typ]}</option>
               </volist>
            </select>
            <select name="major" class="major">
                <option value="0">请选择</option>
            </select>
            <select name="grade">
                <option value="0">请选择</option>
            </select>
             <div class="clear"></div>
            <div class="classname_searche">
                <input type="text" name="authName" value="" class="classname_input"/>
                <a class="classname_search">查找</a>
            </div>
            <div class="clear"></div>
            <div class="classmain_number">
            </div>
        </div>
    </div>
<include file="Public:footer"/>