//
//  StuentDoHomeWork.m
//  ClassRoomTeacher
//
//  Created by apple  on 13-7-8.
//  Copyright (c) 2013年 apple . All rights reserved.
//

#import "StuentDoHomeWork.h"

@interface StuentDoHomeWork ()

@end

@implementation StuentDoHomeWork
@synthesize actDict,courseDict;
@synthesize apId;
@synthesize isShowRightAnswer;
- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}
-(void)btnSubmit:(UIButton *)btn{
    
    if (doHomeView) {
        [doHomeView saveCurrentToDatabase];
    }
    
    if (requestDetail) {
        [requestDetail cancel];
        requestDetail.delegate = nil;
        [requestDetail release];
        requestDetail  = nil;
    }
    NSDictionary *dict=[[NSUserDefaults standardUserDefaults]objectForKey:@"loginInfo"];
    NSString *timeString =[ToolClass getCurretDate];
    requestDetail=[[ASIFormDataRequest alloc]initWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"%@/apps/manage/Api",dele.server_Address_str]]];
    [requestDetail setDelegate:self];
    
    
    NSMutableDictionary *postDict=[[NSMutableDictionary alloc]init ];
    [postDict setObject:timeString forKey:@"ts"];
    [postDict setObject:[dict objectForKey:@"auth_id"] forKey:@"args[a_id]"];
    
    if (apId == 0) {
        if ([[actDict objectForKey:@"act_type"] intValue] == 1) {
            
            [postDict setObject:[actDict objectForKey:@"ap_id"] forKey:@"args[h_id]"];
            [postDict setObject:[ToolClass encodeURL:[daanDict JSONFragment]] forKey:@"args[hd_answer]"];
            [postDict setObject:@"" forKey:@"args[hd_persent]"];
            [postDict setObject:@"" forKey:@"args[hd_use_time]"];
            [postDict setObject:@"Homework.insert" forKey:@"method"];
        }else{
            [postDict setObject:[actDict objectForKey:@"ap_id"] forKey:@"args[cw_id]"];
            [postDict setObject:[ToolClass encodeURL:[daanDict JSONFragment]] forKey:@"args[cd_answer]"];
            [postDict setObject:@"" forKey:@"args[cd_persent]"];
            [postDict setObject:@"" forKey:@"args[cd_use_time]"];
            [postDict setObject:@"Classwork.insert" forKey:@"method"];
        }
    }else{
        [postDict setObject:[NSString stringWithFormat:@"%d",apId] forKey:@"args[cw_id]"];
        [postDict setObject:[ToolClass encodeURL:[daanDict JSONFragment]] forKey:@"args[cd_answer]"];
        [postDict setObject:@"" forKey:@"args[cd_persent]"];
        [postDict setObject:@"" forKey:@"args[cd_use_time]"];
        [postDict setObject:@"Classwork.insert" forKey:@"method"];
    }
   
    
    [postDict setObject:@"JSON" forKey:@"format"];
    [postDict setObject:[dict objectForKey:@"skey"] forKey:@"skey"];
    
    NSString *strSign=[ToolClass getSign:postDict];
    
    
    NSLog(@"strSign is %@",strSign);
    [postDict setObject:[MyMD5 md5:strSign] forKey:@"sign"];
    
    NSLog(@"postdict is %@",postDict);
    
    for(int i=0;i<[[postDict allKeys] count];i++){
        
        [requestDetail setPostValue:[[postDict allValues]objectAtIndex:i] forKey:[[postDict allKeys]objectAtIndex:i]];
    }
    
    for (int i = 0; i<[muArrContent count]; i++) {
        NSMutableDictionary *muDict = [muArrContent objectAtIndex:i];
        if ([[muDict objectForKey:@"to_type"] intValue] == 5) {
            
            NSString *dbName =[NSString stringWithFormat:@"answers%@.db",[muDict objectForKey:@"to_id"]];
            NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
            NSString *documentDirectory = [paths objectAtIndex:0];
            NSString *dbPath = [documentDirectory stringByAppendingPathComponent:dbName];
            FMDatabase *db = [FMDatabase databaseWithPath:dbPath];
            if (![db open]) {
                //NSLog(@"Could not open db.");
            }
            [db executeUpdate:@"CREATE TABLE IF NOT EXISTS handwriting(ha_id text PRIMARY KEY,ha_title text,ha_bitmap blob,ba_bitmap blob,sa_bitmap blob)"];
            FMResultSet *rs = [db executeQuery:@"SELECT * FROM handwriting"];
            while ([rs next]) {
                
                NSData *imageData = [rs dataForColumn:@"sa_bitmap"];
                NSString *filePath = [documentDirectory stringByAppendingPathComponent:@"test.png"];
                [imageData writeToFile:filePath atomically:YES];
                
                
                NSString *strTitle = [rs stringForColumn:@"ha_title"];
                [requestDetail addData:imageData withFileName:strTitle andContentType:@"image/png" forKey:@"picture_answer[]"];
            }
        }
    }
    
    
    [requestDetail buildPostBody];
    [requestDetail setTimeOutSeconds:30];
    [requestDetail startAsynchronous];
    [requestDetail setDidFinishSelector:@selector(mySuccessSubmit:)];
    [requestDetail setDidFailSelector:@selector(myError:)];
    
    
    [postDict release];
    [strSign release];
    
    NSLog(@"答案 %@",[daanDict JSONFragment]);
    
    
}
-(void)mySuccessSubmit:(id)sender{
    
    NSString *str = [sender responseString];
    NSMutableDictionary *muDict = [str JSONValue];
    
    if (muDict) {
        if ([[muDict objectForKey:@"status"] intValue] ==0) {
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:[muDict objectForKey:@"message"] delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
            [alert show];
            [alert release];
        }else{
            UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:@"提交成功!" delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
            [alert show];
            [alert release];
            
            
        }
        if (dele.markLianxi == 1) {
            [self.navigationController popViewControllerAnimated:YES];
            dele.markLianxi = 0;
        }
       
    }
    
    
    
    NSLog(@"muDict is %@",str);
}
-(void)clickTakePicture{
    
   
    UIImagePickerController *picker = [[UIImagePickerController alloc] init];
    if([UIImagePickerController isSourceTypeAvailable:UIImagePickerControllerSourceTypeCamera]) {
        
        
        picker.sourceType = UIImagePickerControllerSourceTypeCamera;
        
//        NSArray *temp_MediaTypes = [UIImagePickerController availableMediaTypesForSourceType:picker.sourceType];
//        picker.mediaTypes = temp_MediaTypes;
        
        [picker setAllowsEditing:YES];
        picker.delegate = self;
        [self presentModalViewController:picker animated:YES];
        [picker release];
        
        
        
    }else{
        
       
        
        
        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:@"您的设备不支持拍照!" delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
        [alert show];
        [alert release];
    }
    


}
//下面两个函数是遵守UIImagePickerControllerDelegate这个协议所实现的类.这样就能够完整的实现,获取照片或者视频,然后写入文件的过程.
- (void)imagePickerController:(UIImagePickerController *)picker didFinishPickingMediaWithInfo:(NSDictionary *)info
{
    
    NSString *mediaType = [info objectForKey:UIImagePickerControllerMediaType];
   
    if ([mediaType isEqualToString:@"public.image"]){
        //拿到编辑后的图片。
		UIImage *image = [info objectForKey:@"UIImagePickerControllerEditedImage"];
        [doHomeView setBackImage:image];
    }
        
    [picker dismissModalViewControllerAnimated:YES];
}

- (void)imagePickerControllerDidCancel:(UIImagePickerController *)picker {
    
    [picker dismissModalViewControllerAnimated:YES];
    
}
- (void)viewDidLoad
{
    [super viewDidLoad];
    
    self.view.backgroundColor = [UIColor whiteColor];

    
    infoLabel.hidden = YES;
    nameLabel.hidden = YES;
    headBackImage.hidden = YES;
    
    dele = [[UIApplication sharedApplication] delegate];
    
    infoLabel.hidden = NO;
    infoLabel.textAlignment = NSTextAlignmentCenter;
    infoLabel.text = [actDict objectForKey:@"act_title"];
    
    

    
    if (apId != 0) {
        
        btnBack.enabled = NO;
        infoLabel.text = @"课堂练习";
        
    }else{
        
    }
    
        
    UIButton *btnSubmit = [[UIButton alloc] initWithFrame:CGRectMake(1024-160, 10, 151, 38)];
    btnSubmit.backgroundColor = [UIColor clearColor];
    [btnSubmit setImage:[UIImage imageNamed:@"提交.png"] forState:UIControlStateNormal];
    [btnSubmit addTarget:self action:@selector(btnSubmit:) forControlEvents:UIControlEventTouchUpInside];
    [self.view addSubview:btnSubmit];
    [btnSubmit release] ;
    
    mainScrollview = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 54, 507, 407)];
    mainScrollview.backgroundColor = [UIColor clearColor];
    [mainScrollview setShowsVerticalScrollIndicator:NO];
    [mainScrollview setShowsHorizontalScrollIndicator:NO];
    [self.view addSubview:mainScrollview];
    [mainScrollview release];
    
    
    tikuScro = [[UIScrollView alloc] initWithFrame:CGRectMake(0, 475, 507, 277)];
    [tikuScro setShowsHorizontalScrollIndicator:NO];
    [self.view addSubview:tikuScro];
    [tikuScro release];
    
    
    lblTitle = [[UILabel alloc] initWithFrame:CGRectMake(0, 0, 507, 30)];
    lblTitle.backgroundColor = [UIColor clearColor];
    lblTitle.textColor = MYCOLOR;
    lblTitle.textAlignment = NSTextAlignmentLeft;
    [mainScrollview addSubview:lblTitle];
    [lblTitle release];
    
    topicImage = [[UIImageView alloc] initWithFrame:CGRectMake(0, 30, 507, 407-30)];
    [mainScrollview addSubview:topicImage];
    [topicImage release];
    
    
    UIImageView *hline = [[UIImageView alloc]initWithFrame:CGRectMake(0, 465, 510, 2)];
    hline.image = [UIImage imageNamed:@"homework横线.png"];
    [self.view addSubview:hline];
    [hline release];
    
    UIImageView *vline = [[UIImageView alloc]initWithFrame:CGRectMake(510, 54, 2, 695)];
    vline.image = [UIImage imageNamed:@"homework竖线.png"];
    [self.view addSubview:vline];
    [vline release];
    
    
    
    
    UISwipeGestureRecognizer *swipeLeft=[[UISwipeGestureRecognizer alloc]initWithTarget:self action:@selector(moveLeft)];
    swipeLeft.direction = UISwipeGestureRecognizerDirectionLeft;
    [tikuScro addGestureRecognizer:swipeLeft];
    [swipeLeft release];
    
    UISwipeGestureRecognizer *swipeRight=[[UISwipeGestureRecognizer alloc]initWithTarget:self action:@selector(moveRight)];
    swipeRight.direction = UISwipeGestureRecognizerDirectionRight;
    [tikuScro addGestureRecognizer:swipeRight];
    [swipeRight release];
    
    
    
    
      
    
    
    NSDictionary *dict=[[NSUserDefaults standardUserDefaults]objectForKey:@"loginInfo"];
    NSString *timeString =[ToolClass getCurretDate];
    requestDetail=[[ASIFormDataRequest alloc]initWithURL:[NSURL URLWithString:[NSString stringWithFormat:@"%@/apps/manage/Api",dele.server_Address_str]]];
    [requestDetail setDelegate:self];
    
    
    NSMutableDictionary *postDict=[[NSMutableDictionary alloc]init ];
    [postDict setObject:timeString forKey:@"ts"];
    [postDict setObject:[dict objectForKey:@"auth_id"] forKey:@"args[a_id]"];
    [postDict setObject:@"JSON" forKey:@"format"];

    if (apId == 0) {
        
       
        [postDict setObject:[actDict objectForKey:@"ap_id"] forKey:@"args[ap_id]"];
        if ([[actDict objectForKey:@"act_type"] intValue] == 1) {
            [postDict setObject:@"Homework.doHomework" forKey:@"method"];
            
        }else{
            [postDict setObject:@"Classwork.doClasswork" forKey:@"method"];
            
        }
    }else{
       
        [postDict setObject:[NSString stringWithFormat:@"%d",apId] forKey:@"args[ap_id]"];
        [postDict setObject:@"Classwork.doClasswork" forKey:@"method"];
    }
    
    
    [postDict setObject:[dict objectForKey:@"skey"] forKey:@"skey"];
    
    NSString *strSign=[ToolClass getSign:postDict];
    
    NSLog(@"strSign is %@",strSign);
    [postDict setObject:[MyMD5 md5:strSign] forKey:@"sign"];
    
    
    NSLog(@"postdict is %@",postDict);
    
    for(int i=0;i<[[postDict allKeys] count];i++){
        
        [requestDetail setPostValue:[[postDict allValues]objectAtIndex:i] forKey:[[postDict allKeys]objectAtIndex:i]];
    }
    [requestDetail buildPostBody];
    [requestDetail setTimeOutSeconds:30];
    [requestDetail startAsynchronous];
    [requestDetail setDidFinishSelector:@selector(mySuccessDetailWork:)];
    [requestDetail setDidFailSelector:@selector(myError:)];
    
    
    [postDict release];
    [strSign release];
    
    [MBProgressHUD showHUDAddedTo:self.view animated:YES];
    
	// Do any additional setup after loading the view.
}


-(void)moveLeft{
    
    
    
    [self btnNextClick];
}
-(void)moveRight{
    
    
    
    [self btnUPClick];
}
-(void)btnUPClick{
    
    if (index>0) {
        
        
        CATransition *animation = [CATransition animation];
        [animation setDuration:0.3f];
        [animation setTimingFunction:[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseIn]];
        [animation setType:@"push"];
        [animation setSubtype: kCATransitionFromLeft];
        [mainScrollview.layer addAnimation:animation forKey:@"pushRight"];
        if (doHomeView) {
            [doHomeView.layer addAnimation:animation forKey:@"pushRight2"];
            
        }
        
        [[self.view viewWithTag:100+index] removeFromSuperview];
        
        index--;
        [self loadContentView];
    }
}

-(void)btnNextClick{
    
    if (index<[muArrContent count]-1) {
        
        
        CATransition *animation = [CATransition animation];
        [animation setDuration:0.3f];
        [animation setTimingFunction:[CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseIn]];
        [animation setType:@"push"];
        [animation setSubtype: kCATransitionFromRight];
        [mainScrollview.layer addAnimation:animation forKey:@"pushLeft"];
        if (doHomeView) {
            
            [doHomeView.layer addAnimation:animation forKey:@"pushLeft2"];
            
        }
        [[self.view viewWithTag:100+index] removeFromSuperview];
        
        index++;
        
        [self loadContentView];
    }
}
-(void)loadContentView{
    NSMutableDictionary *subDict = [muArrContent objectAtIndex:index];
    
    for (UIView *v in [tikuScro subviews]) {
        v.layer.borderColor = [UIColor clearColor].CGColor;
    }
    
    UIView *tempBtn = [tikuScro viewWithTag:index +500];
    tempBtn.layer.borderColor = [UIColor redColor].CGColor;
    
    if (doHomeView) {
        [doHomeView saveCurrentToDatabase];
        [doHomeView removeFromSuperview];
        doHomeView = nil;
    }
    
    
    //加载题库
    NSString *strImgURL = [subDict objectForKey:@"path"];
    NSString *strFile=[FileManageUnit getFile:strImgURL];
    
    if([FileManageUnit fileIsExist:strFile]==NO){
        
        dispatch_async(dispatch_get_global_queue(0, 0),^(void){
        
            NSData *imgData = [[[NSData alloc] initWithContentsOfURL:[NSURL URLWithString:strImgURL]] autorelease];
            
                       
            dispatch_async(dispatch_get_main_queue(), ^(void){
        
                UIImage *image=[[UIImage alloc]initWithData:imgData];
                if (strFile) {
                    [imgData writeToFile:strFile atomically:YES];
                    
                }
                topicImage.image = image;
                [image release];
            
                topicImage.frame = CGRectMake(topicImage.frame.origin.x, topicImage.frame.origin.y, topicImage.image.size.width, topicImage.image.size.height);
                [mainScrollview setContentSize:CGSizeMake(topicImage.image.size.width, topicImage.image.size.height+30)];
        
            });
            
        });

    }else{
        
        
        UIImage *image=[[UIImage alloc]initWithContentsOfFile:strFile];
        topicImage.image = image;
        [image release];
        
        topicImage.frame = CGRectMake(topicImage.frame.origin.x, topicImage.frame.origin.y, topicImage.image.size.width, topicImage.image.size.height);
        [mainScrollview setContentSize:CGSizeMake(topicImage.image.size.width, topicImage.image.size.height+30)];

    }

    
    NSLog(@"subDict is %@",subDict);
    
    
    if ([[subDict objectForKey:@"to_type"] intValue] == 1) {
        
        lblTitle.text = [NSString stringWithFormat:@"%d.单选题",index+1];
        
        
        OneSelectView *view = [[OneSelectView alloc] initWithFrame:CGRectMake(512,54,512,690)];
        view.tag = 100+index;
        view.backgroundColor = [UIColor clearColor];
        [self.view addSubview:view];
        [view release];
        
        [view changUI:subDict daan:daanDict index:index];
    }
    if ([[subDict objectForKey:@"to_type"] intValue] == 2) {
        
        
        lblTitle.text = [NSString stringWithFormat:@"%d.多选题",index+1];

        
        ManySelectView *view = [[ManySelectView alloc] initWithFrame:CGRectMake(512,54,512,690)];
        view.tag = 100+index;
        [self.view addSubview:view];
        [view release];
        
        [view changUI:subDict daan:daanDict index:index];
    }
    if ([[subDict objectForKey:@"to_type"] intValue] == 3) {
        
        lblTitle.text = [NSString stringWithFormat:@"%d.填空题",index+1];

        
        TiankongView *view = [[TiankongView alloc] initWithFrame:CGRectMake(512,54,512,690)];
        view.tag = 100+index;
        [self.view addSubview:view];
        [view release];
        
        [view changUI:subDict daan:daanDict index:index];
    }
    if ([[subDict objectForKey:@"to_type"] intValue] == 4) {
        
        lblTitle.text = [NSString stringWithFormat:@"%d.判断题",index+1];

        
        PanduanView *view = [[PanduanView alloc] initWithFrame:CGRectMake(512,54,512,690)];
        view.tag = 100+index;
        [self.view addSubview:view];
        [view release];
        
        [view changUI:subDict daan:daanDict index:index];
    }
    if ([[subDict objectForKey:@"to_type"] intValue] == 5) {
        
        lblTitle.text = [NSString stringWithFormat:@"%d.简答题",index+1];

        
        doHomeView = [[DatiView alloc] initWithFrame:CGRectMake(512,54,512,690)];
        doHomeView.delegate = self;
        [self.view addSubview:doHomeView];
        [doHomeView release];
        
        [doHomeView setTo_Id:[[subDict objectForKey:@"to_id"] intValue]];
         
        
    }
     
    
    [MBProgressHUD hideAllHUDsForView:self.view animated:YES];
    
    
}
//练习或者作业的详情.
-(void)mySuccessDetailWork:(id)sender{
    
    NSString *str=[sender responseString];
    
    NSMutableDictionary *muDict = [str JSONValue];
    
    
    
    
    muArrContent = [[[[muDict objectForKey:@"info"] objectForKey:@"list"] objectForKey:@"topic"] mutableCopy];
    
    for (int i=0; i<[muArrContent count]; i++) {
        
        NSMutableDictionary *dict = [muArrContent objectAtIndex:i];
        
        
        UIButton *btn = [[UIButton alloc] initWithFrame:CGRectMake(i%3*(115+30)+20,i/3*(40+20)+20, 115, 40)];
        btn.backgroundColor = MYCOLOR;
        btn.tag = i+500;
        [btn addTarget:self action:@selector(selectTimu:) forControlEvents:UIControlEventTouchUpInside];
        btn.titleLabel.font = [UIFont boldSystemFontOfSize:18];
        if ([[dict objectForKey:@"to_type"] intValue] == 1) {
            [btn setTitle:[NSString stringWithFormat:@"%d.单选题",i+1] forState:UIControlStateNormal];
        }
        if ([[dict objectForKey:@"to_type"] intValue] == 2) {
            [btn setTitle:[NSString stringWithFormat:@"%d.多选题",i+1] forState:UIControlStateNormal];
        }
        if ([[dict objectForKey:@"to_type"] intValue] == 3) {
            [btn setTitle:[NSString stringWithFormat:@"%d.填空题",i+1] forState:UIControlStateNormal];
        }
        if ([[dict objectForKey:@"to_type"] intValue] == 4) {
            [btn setTitle:[NSString stringWithFormat:@"%d.判断题",i+1] forState:UIControlStateNormal];
        }
        if ([[dict objectForKey:@"to_type"] intValue] == 5) {
            [btn setTitle:[NSString stringWithFormat:@"%d.简答题",i+1] forState:UIControlStateNormal];
        }
        [btn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
        btn.layer.borderWidth = 2.0;
        btn.layer.masksToBounds = YES;
        btn.layer.borderColor = [UIColor clearColor].CGColor;
        [tikuScro addSubview:btn];
        [btn release];
        
    }
    [tikuScro setContentSize:CGSizeMake(507,([muArrContent count]/3+1)*(40+20)+20)];
    
    
    
    if ([muDict objectForKey:@"ad_answer"]) {
        
        daanDict = [[[muDict objectForKey:@"ad_answer"] JSONValue] mutableCopy];
        NSLog(@"[muDict objectForKey:@\"ad_answer\"] %@",[muDict objectForKey:@"ad_answer"]);
        if (!daanDict) {
            
            daanDict = [[NSMutableDictionary alloc] init];

        }

        
    }else{
        
        daanDict = [[NSMutableDictionary alloc] init];

        for (int i=0; i<[muArrContent count]; i++) {
            
            NSMutableDictionary *dict2 = [muArrContent objectAtIndex:i];
            
            if ([[dict2 objectForKey:@"to_type"] intValue] == 1 || [[dict2 objectForKey:@"to_type"] intValue] == 2 ||[[dict2 objectForKey:@"to_type"] intValue] == 4) {
                
                [daanDict setObject:@"-1" forKey:[dict2 objectForKey:@"to_id"]];
                
            }else if([[dict2 objectForKey:@"to_type"] intValue] == 5){
            
                [daanDict setObject:@"" forKey:[dict2 objectForKey:@"to_id"]];

                
            }else if([[dict2 objectForKey:@"to_type"] intValue] == 3){
                

                NSArray *arr = [[dict2 objectForKey:@"to_answer"] JSONValue];
                NSMutableArray *muArr = [[NSMutableArray alloc] init];
                for (int i=0;i<[arr count];i++) {
                    [muArr addObject:@""];
                }
                [daanDict setObject:[muArr JSONFragment] forKey:[dict2 objectForKey:@"to_id"]];
                
            }
        }
        
    }
    NSLog(@"muDict is %@",muDict);

    NSLog(@"daandict is %@",daanDict);
    
    if ([muDict objectForKey:@"picture_answer"]) {
        if ([[muDict objectForKey:@"picture_answer"] count]>0) {
            
            for (int i=0; i<[muArrContent count]; i++) {
                
                NSMutableDictionary *dict2 = [muArrContent objectAtIndex:i];
                
                if ([[dict2 objectForKey:@"to_type"] intValue] == 5) {
                    
                    NSString *dbName =[NSString stringWithFormat:@"answers%@.db",[dict2 objectForKey:@"to_id"]];
                    NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
                    NSString *documentDirectory = [paths objectAtIndex:0];
                    NSString *dbPath = [documentDirectory stringByAppendingPathComponent:dbName];
                    FMDatabase *db = [FMDatabase databaseWithPath:dbPath];
                    if (![db open]) {
                        //NSLog(@"Could not open db.");
                    }
                    [db executeUpdate:@"CREATE TABLE IF NOT EXISTS handwriting(ha_id text PRIMARY KEY,ha_title text,ha_bitmap blob,ba_bitmap blob,sa_bitmap blob)"];
                    
                    
                    NSArray *arr = [[muDict objectForKey:@"picture_answer"] objectForKey:[dict2 objectForKey:@"to_id"]];
                    for (int i=0; i<[arr count]; i++) {
                        NSString *strURL = [arr objectAtIndex:i];
                        NSLog(@"strURL is %@",strURL);
                        NSData *data = [[NSData alloc] initWithContentsOfURL:[NSURL URLWithString:strURL]];
                        
                        
                        
                        NSArray *arr2 = [strURL componentsSeparatedByString:@"/"];
                        NSString *strFileName = [arr2 objectAtIndex:[arr2 count] -1];
                        NSLog(@"strFileName is %@",strFileName);
                        
                        NSString *strID = [strFileName substringToIndex:[strFileName length]-4];
                        
                        NSLog(@"strID is %@",strID);
                        NSArray *arr3 = [strID componentsSeparatedByString:@"-"];
                        int  currentPage = [[arr3 objectAtIndex:1] intValue];
                        NSLog(@"curretnPagei s%d",currentPage);
                        
                        [db executeUpdate:@"INSERT OR REPLACE INTO handwriting(ha_id,ha_title,sa_bitmap) VALUES (?,?,?)",[NSString stringWithFormat:@"%d",currentPage],strFileName, data];
                        
                    }
                }
            }
        }
        
    }
    
    for (int i=0; i<[muArrContent count]; i++) {
        
        NSMutableDictionary *dict2 = [muArrContent objectAtIndex:i];
        
        if ([[dict2 objectForKey:@"to_type"] intValue] == 1 || [[dict2 objectForKey:@"to_type"] intValue] == 2 ||[[dict2 objectForKey:@"to_type"] intValue] == 4) {
            
            NSString *answer  = [[[dict2 objectForKey:@"to_answer"] JSONValue] objectAtIndex:0];

            NSString *stuAns = [daanDict objectForKey:[dict2 objectForKey:@"to_id"]];
            
            NSLog(@"answer is %@ ,struans is %@",answer,stuAns);
            
            if ([answer isEqualToString:stuAns]) {
                
                
                UIImageView *image = [[UIImageView alloc]initWithFrame:CGRectMake(115-24, 0, 24, 24)];
                image.image = [UIImage imageNamed:@"homework对.png"];
                image.hidden = !isShowRightAnswer;
                [[tikuScro viewWithTag:500+i] addSubview:image];
                [image release];
            }else{
                UIImageView *image = [[UIImageView alloc]initWithFrame:CGRectMake(115-24, 0, 24, 24)];
                image.image = [UIImage imageNamed:@"homework错.png"];
                image.hidden = !isShowRightAnswer;

                [[tikuScro viewWithTag:500+i] addSubview:image];
                [image release];
            }
            
            
        }
    }
    
    [self loadContentView];
    
}
-(void)selectTimu:(UIButton *)btn{
    
    
    if (index != btn.tag -500) {
        [[self.view viewWithTag:100+index] removeFromSuperview];
        index = btn.tag -500;
        [self loadContentView];
    }
    
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
#if __IPHONE_OS_VERSION_MAX_ALLOWED >= __IPHONE_6_0

-(NSUInteger)supportedInterfaceOrientations
{
    return UIInterfaceOrientationMaskLandscape;
}

- (BOOL)shouldAutorotate {
    return YES;
}

#endif


// Override to allow orientations other than the default portrait orientation.
- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation
{
    // Return YES for supported orientations
    return (interfaceOrientation == UIInterfaceOrientationLandscapeLeft  ||
            interfaceOrientation == UIInterfaceOrientationLandscapeRight);
    
}
-(void)dealloc{
    [requestDetail cancel];
    requestDetail.delegate = nil;
    [requestDetail release];
    
    [muArrContent release];
    [daanDict release];
    if (apId == 0) {
        
        [courseDict release];
        [actDict release];
        
    }
    
    [super dealloc];
}
@end
