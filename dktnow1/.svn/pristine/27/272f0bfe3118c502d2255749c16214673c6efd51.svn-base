<include file="Public:header"/>
<load href="/Public/Js/Public/flexPlugin/js/flexpaper.js, /Public/Js/Public/flexPlugin/js/flexpaper_handlers.js" />
<load href="__PUBLIC__/Css/Home/document.css"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<script type="text/javascript">
<!--
    $(function() {

        // 上传我的文档
        $(document).on('click', '.upload_area', function () {

            // 查看是否登录
            if ($('.exit').html()) {
                window.open("__APPURL__/AuthResource");
            } else {

                popCenterWindow();
            }
        })

        // 收藏
        $(document).on('click', '.sc', function () {

            // 查看是否登录
            if ($('.exit').html()) {
                $.post('__APPURL__/ResourceCollect/insert/', {re_id:$('input[name=re_id]').val()}, function (json) {
                    if (json.status == 1) {
                        showMessage(json.info, 1);
                    } else {
                        showMessage(json.info);
                    }
                }, 'json');
            } else {

                popCenterWindow();
            }
        })

        // 下载
        $(document).on('click', '.dw', function () {

            // 查看是否登录
            if ($('.exit').html()) {
                location.href = "__APPURL__/MyResource/download?id=" + $('input[name=re_id]').val();
            } else {

                popCenterWindow();
            }
        });

        // 资源排行
        $.getJSON('/html/today.txt', function (json) {
            if (json) {
                var htm = '';
                for (var i=0, len=json.length; i<len; i++) {
                        htm += '<li>'
                            +  '<span class="d-name" title="' + json[i]['re_title'] + '"><a href="__APPURL__/Resource/index/id/' + json[i]['re_id'] + '" target="_blank">' + json[i]['re_title'] + '</a></span>'
                            +  '<span class="d-p fl"></span>'
                            +  '</li>'
                }
                $('.resourceSort').append(htm);
            }
        });

        // 短评输入框字数计算
        var maxSize = 140;
        $(".scommentInput").keyup(function(){
            var str = $(".scommentInput").val().trimLeft().length;
            var canInput = maxSize - str;
            if(canInput >= 0){
                $(".scommentInputCount").html("还能输入"+canInput+"个字符");
                $(".scommentInputCount").removeClass('overWord');
            }else{
                $(".scommentInputCount").addClass('overWord');
                $(".scommentInputCount").html("已经超过"+(-canInput)+"个字符");
            }
        })

        // 回复输入框字数计算
        $(document).on('keyup', ".innerText", function(){

            var str = $(this).val().trimLeft().length;
            var canInput = maxSize - str;
            if(canInput >= 0){
                $(this).next().children('.innerCount').html("还能输入"+canInput+"个字符");
                $(this).next().children('.innerCount').removeClass('overWord');
            }else{
                $(this).next().children('.innerCount').addClass('overWord');
                $(this).next().children('.innerCount').html("已经超过"+(-canInput)+"个字符");
            }
        })

        // 添加评论
        $('.scommentSubmit').click(function(){

            // 弹出登录框
            if (!$('.exit').html()) {
                popCenterWindow();
                return;
            }

            var comm_cont = $('.scommentInput').val();
            if (comm_cont.trim() == '') {
                showMessage('请填写评论内容');
                return;
            } else if (comm_cont.trim().length > 140) {
                showMessage('评论的内容请不要超过140个字');
                return;
            }

            $.post('__APPURL__/Commit/insert', {com_object_id:$('input[name=re_id]').val(), com_content:comm_cont}, function (json) {
                var htm = '';
                if (json.status == 1) {
                    htm += '<li attr="' + json.info + '">'
                        +  '<p class="des">' + comm_cont.trim() + '</p>'
                        +  '<div class="fun">'
                        +  '<p class="commit from"><a href="#">我</a>发表于1秒前</p>'
                        + '<div class="ope"><a class="innerA" href="javascript:void(0)" attr="0">回复(0)</a>|<a class="innerB" href="javascript:void(0)" com_id="' + json.info + '">删除</a></div>'
                        + '</div>'
                        + '<div class="innerDiv">'
                        + '<div class="replyList"><ul></ul></div>'
                        + '<textarea class="innerText" attr="回复:"></textarea>'
                        + '<p class="sendbox">'
                        + '<button class="innerButton" type="button">发短评</button>'
                        + '<span class="innerCount">还可以输入140字</span>'
                        + '</p></div></li>'
                    if ($('.CommitList li').size() == 1 && $('.CommitList li').attr('attr') == 0) {
                        $('.CommitList').html(htm);
                    } else {
                        $('.CommitList').prepend(htm);
                    }

                    if ($('.get_score').html() == '暂无评论') {
                        $('.get_score').html('1条记录')
                    } else {
                        $('.moreArea a').last().text((parseInt($('.moreArea a').last().text().slice(0,1)) + 1) + '条记录')
                        var arr = $('.get_score').html().match(/\d+/g);
                        $('.get_score').html((parseInt(arr[0]) + 1) + '条评论');
                    }

                    $('.scommentInput').val('');
                } else {
                    showMessage('评论失败');
                }
            }, 'json')
        })

        // 回复
        $(document).on('click', '.innerA', function () {

            // 展开隐藏的回复文本输入框
            var _this = $(this);

            // 如果有回复的并且没有加载过，还需异步查询并展现
            if (_this.parents('.fun').next().css('display') == 'none') {

                var innerDiv = $(this).parents('li').children('.innerDiv');
                innerDiv.css('display', 'inline');
                innerDiv.children('.innerText').val(innerDiv.children('.innerText').attr('attr'));

                if (innerDiv.children('.replyList').children('ul').children('li').size() == 0) {
                    $.post("__APPURL__/Public/getList", {com_id:$(this).parents('li').attr('attr')}, function (json) {
                        var htm = '';
                        if (json) {
                            for (var i=0,len = json.length; i<len; i++) {
                                htm += '<li class="hf" attr="' + json[i]['rep_id'] + '">'
                                    +  '<p class="des">' + json[i]['rep_content'] + '</p>'
                                    +  '<div class="fun">'
                                    +  '<p class="from"><a href="">' + json[i]['nickname'] + '</a>发表于' + json[i]['rep_created'] + '</p>'
                                    + '<div class="ope"><a class="innerA" href="javascript:void(0)">回复</a>|<a class="innerB" href="javascript:void(0)" rep_id="' + json[i]['rep_id'] + '">删除</a></div>'
                                    + '</div>'
                                    + '</li>'
                                }
                            _this.parents('.fun').next().children('.replyList').children('ul').append(htm);

                            // 聚焦回复文本框
                            innerDiv.children('.innerText').focus();
                        }
                    }, 'json')

                }
            } else {
                _this.parents('.fun').next().css('display', 'none');
            }
        })

        // 提交回复
        $(document).on('click', '.innerButton', function () {

            // 弹出登录框
            if (!$('.exit').html()) {
                popCenterWindow();
                return;
            }

            // 赋值并检测
            var val = $(this).parents('.innerDiv').children('.innerText').val();
            if (val.trim() == '') {
                showMessage('请填写回复内容');
                return;
            } else if (val.trim().length > 140) {
                showMessage('回复内容请不要超过140个字');
                return;
            }

            var _this = $(this);
            var replyName = _this.parents('.innerDiv').prev().children('.commit').children('a').text();

            // ajax写入
            $.post("__APPURL__/Reply/insert", {com_id:_this.parents('li').attr('attr'), rep_content:val.trim()}, function (json) {
                var htm = '';
                if (json.status == 1) {
                    htm += '<li class="hf" attr="' + json.info + '">'
                        +  '<p class="des">' + val.trim() + '</p>'
                        +  '<div class="fun">'
                        +  '<p class="from"><a href="">我</a>发表于1秒前</p>'
                        + '<div class="ope"><a class="innerA" href="javascript:void(0)">回复</a>|<a class="innerB" href="javascript:void(0)" rep_id="' + json.info + '">删除</a></div>'
                        + '</div>'
                        + '</li>'

                    var arr = _this.parents('.innerDiv').prev().find('.innerA').text().match(/\d+/g);
                    _this.parents('.innerDiv').prev().find('.innerA').text('回复(' + (parseInt(arr[0]) + 1) + ')');

                    _this.parents('.innerDiv').find('.replyList').children('ul').prepend(htm);
                    _this.parents('.innerDiv').children('.innerText').val(_this.parents('.innerDiv').children('.innerText').attr('attr')
                    )
                    _this.parents('.innerDiv').children('.innerText').focus();
                } else {
                    showMessage('发表回复失败');
                }
            }, 'json')
        })

        // 删除
        $(document).on('click', '.innerB', function () {

            // 弹出登录框
            if (!$('.exit').html()) {
                popCenterWindow();
                return;
            }

            // 展开隐藏的回复文本输入框
            if (confirm('是否真的要删除此评论?')) {

                var _this = $(this);

                // 删除评论
                if ($(this).attr('com_id')) {
                    $.post('__APPURL__/Commit/delete', 'com_id=' + $(this).attr('com_id'), function (json) {
                        if (json.status == 1) {
                            $('.moreArea a').last().text((parseInt($('.moreArea a').last().text().slice(0,1)) - 1) + '条记录');
                            var arr = $('.get_score').html().match(/\d+/g);
                            $('.get_score').html((parseInt(arr[0]) - 1) + '条评论');
                            _this.parents('li').remove();
                        } else {
                            showMessage(json.info);
                        }
                    }, 'json');
                }

                // 删除回复
                if ($(this).attr('rep_id')) {
                    $.post('__APPURL__/Reply/delete', 'rep_id=' + _this.attr('rep_id') + '&com_id=' + _this.parents('.innerDiv').parents('li').attr('attr'), function (json) {
                        if (json.status == 1) {

                            var arr = _this.parents('.innerDiv').prev().find('.innerA').text().match(/\d+/g);
                            _this.parents('.innerDiv').prev().find('.innerA').text('回复(' + (parseInt(arr[0]) - 1) + ')');

                            _this.parent().parent().parent().remove();
                        } else {
                            showMessage(json.info);
                        }
                    }, 'json');
                }

            }
        })

        // 加载评论
        ajaxShow();
    })

    // 分页显示
    function getList(p) {
        ajaxShow(p);
    }

    // ajax显示评论
    function ajaxShow(p) {
        var p = p ? p : 1;

        $.post("__APPURL__/Public/search", {com_object_id:$('input[name=re_id]').val(), p:p}, function (json) {
            var htm = '';
            if (json.list) {
                for (var i=0,len = json.list.length; i<len; i++) {
                    htm += '<li attr="' + json.list[i]['com_id'] + '">'
                        +  '<p class="des">' + json.list[i]['com_content'] + '</p>'
                        +  '<div class="fun">'
                        +  '<p class="commit from"><a href="#">' + json.list[i]['nickname'] + '</a>发表于' + json.list[i]['com_created'] + '</p>'
                        + '<div class="ope"><a class="innerA" href="javascript:void(0)" attr="' + json.list[i]['com_reply_count'] + '">回复(' + json.list[i]['com_reply_count'] + ')</a>|<a class="innerB" href="javascript:void(0)" com_id="' + json.list[i]['com_id'] + '">删除</a></div>'
                        + '</div>'
                        + '<div class="innerDiv">'
                        + '<div class="replyList"><ul></ul></div>'
                        + '<textarea class="innerText" attr="回复' + json.list[i]['nickname'] + ':"></textarea>'
                        + '<p class="sendbox">'
                        + '<button class="innerButton" type="button">发短评</button>'
                        + '<span class="innerCount">还可以输入140字</span>'
                        + '</p></div></li>'
                }
                $('.yp ul').html(htm);
                $('.moreArea').html(json.page);
                var arr = json.page.slice(-10,-7).match(/\d+/g);
                $('.get_score').html(parseInt(arr[0]) + '条评论');
            } else {
                $('.yp ul').html('<li attr="0">暂无评论</li>');
                $('.get_score').html('暂无评论');
            }
        }, 'json')

    }

//-->
</script>
<div class="warp">
    <div class="doc_box fl">
        <div class="top_dir">
            {$cate}
        </div>
        <div class="main_box">
            <div class="main-left">
                <div class="main-left_top">
                    <div class="doc_name fl">
                        <!--img src="/Public/Images/Home/d-w.png" /-->
                        <span class="tt fl">{$res.re_title}</span>
                        <span class="rr fl"><i>{$res.re_hits}</i>人阅读</span>
                        <input type="hidden" name="re_id" value="{$res.re_id}">
                        <!--span class="jb fr">举报文档</span-->
                    </div>
                    <p class="f_tit"></p>
                    <div id="documentViewer" class="flexpaper_viewer"></div>
                    <script type="text/javascript">
                        var swf = "{$path}";
                        $('#documentViewer').FlexPaperViewer(
                            { config : {
                                SWFFile :swf, 
                                Scale : 0.6,
                                ZoomTransition : 'easeOut',
                                ZoomTime : 0.5,
                                ZoomInterval : 0.2,
                                FitPageOnLoad : true,
                                FitWidthOnLoad : false,
                                FullScreenAsMaxWindow : false,
                                ProgressiveLoading : false,
                                MinZoomSize : 0.2,
                                MaxZoomSize : 5,
                                SearchMatchAll : false,
                                InitViewMode : 'Portrait',
                                RenderingOrder : 'flash,html',
                                StartAtPage : '',
                                ViewModeToolsVisible : true,
                                ZoomToolsVisible : true,
                                NavToolsVisible : true,
                                CursorToolsVisible : true,
                                SearchToolsVisible : true,
                                WMode : 'window',
                                localeChain: 'en_US'
                            }}
                        );
                    </script>
                    <div class="tools fl">
                        <a href="javascript:void(0);" class="sc"></a>
                        <a href="javascript:void(0);" class="dw"></a>
                        <span class="dw_info">大小：{$filesize}</span>
                    </div>
                </div>
                <!-- 评论区域开始 -->
                <div class="main-left-center">
                    <div class="res_comment">    <!-- 短评 -->
                        <p class="title">短评</p>
                        <div class="topic_input">
                            <div class="t_box">
                                <textarea class="scommentInput" placeholder="我来说两句"></textarea>
                            </div>
                            <p class="sendbox">
                                <button class="scommentSubmit" type="button">发短评</button>
                                <span class="scommentInputCount">还可以输入140字</span>
                            </p>
                        </div>
                        <ul class="tabbox">
                            <li class="newestSComment on">最热短评</li>
                        </ul>
                        <div class="comment_box new fl">
                            <div class="yp" id="comment">
                                <ul class="CommitList">
                                </ul>
                                <p class="moreArea"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 评论区域结束 -->
            </div>
            <div class="main-right">
                <a href="javascript:void(0)" class="upload_area"></a>    <!-- 上传文档 -->
                <div class="doc_info">    <!-- 评价文档 -->
                    <p class="tit">文档信息</p>
                    <p class="author"><cite>{$authInfo.a_nickname}</cite>贡献于{$res.re_created}</p>
                    <div class="give_score">
                        <div class="show">
                            <div class="top fl">
                                <span class="get_score"></span>
                            </div>
                        </div>
                        <div class="give">
                            <a href="#comment"><b class="ic-value"></b>我要评论</a>
                        </div>
                    </div>
                </div>
                <neq name="recommend" value="">
                    <div class="doc_tj fl">    <!-- 相关文档推荐 -->
                        <p class="tit">资源推荐</p>
                        <ul class="resourceCommend">
                            <volist name="recommend" id="vo">
                            <li>
                            <span title="{$re_title}" class="d-name">
                            <a target="_blank" href="__APPURL__/Resource/index/id/{$re_id}">{$re_title}</a>
                            </span>
                            <span class="d-p fl"></span>
                            </li>
                            </volist>
                        </ul>
                    </div>
                </neq>
                <div class="doc_tj fl">
                    <p class="tit">资源排行榜</p>
                    <ul class="resourceSort"></ul>
                </div>
            </div>
        </div>
    </div>
<div class="clear"></div>
</div>
<include file="Public:footer"/>