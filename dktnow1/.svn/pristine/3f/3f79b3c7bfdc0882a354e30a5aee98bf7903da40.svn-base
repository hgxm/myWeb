//
//  RecordViewController.m
//  ClassRoomStudent
//
//  Created by apple  on 13-8-7.
//  Copyright (c) 2013年 apple . All rights reserved.
//

#import "RecordViewController.h"

@interface RecordViewController ()

@end

@implementation RecordViewController

- (void)audio
{
    //录音设置
    NSMutableDictionary *recordSetting = [[[NSMutableDictionary alloc]init] autorelease];
    //设置录音格式  AVFormatIDKey==kAudioFormatLinearPCM
    [recordSetting setValue:[NSNumber numberWithInt:kAudioFormatMPEG4AAC] forKey:AVFormatIDKey];
    //设置录音采样率(Hz) 如：AVSampleRateKey==8000/44100/96000（影响音频的质量）
    [recordSetting setValue:[NSNumber numberWithFloat:44100] forKey:AVSampleRateKey];
    //录音通道数  1 或 2
    [recordSetting setValue:[NSNumber numberWithInt:1] forKey:AVNumberOfChannelsKey];
    //线性采样位数  8、16、24、32
    [recordSetting setValue:[NSNumber numberWithInt:16] forKey:AVLinearPCMBitDepthKey];
    //录音的质量
    [recordSetting setValue:[NSNumber numberWithInt:AVAudioQualityMedium] forKey:AVEncoderAudioQualityKey];
    
    NSString *strUrl = [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject];
    NSURL *url = [NSURL fileURLWithPath:[NSString stringWithFormat:@"%@/lll.aac", strUrl]];

    
    NSError *error;
    //初始化
    recorder = [[AVAudioRecorder alloc]initWithURL:url settings:recordSetting error:&error];
    //开启音量检测
    recorder.meteringEnabled = YES;
    recorder.delegate = self;
}
- (void)detectionVoice
{
    
    [self updateTimer];
    imageView.hidden = NO;
    [recorder updateMeters];//刷新音量数据
    //获取音量的平均值  [recorder averagePowerForChannel:0];
    //音量的最大值  [recorder peakPowerForChannel:0];
    
    double lowPassResults = pow(10, (0.05 * [recorder peakPowerForChannel:0]));
   // NSLog(@"%lf",lowPassResults);
    //最大50  0
    //图片 小-》大
    if (0<lowPassResults<=0.06) {
        [imageView setImage:[UIImage imageNamed:@"1.png"]];
    }else if (0.06<lowPassResults<=0.13) {
        [imageView setImage:[UIImage imageNamed:@"2.png"]];
    }else if (0.13<lowPassResults<=0.20) {
        [imageView setImage:[UIImage imageNamed:@"3.png"]];
    }else if (0.20<lowPassResults<=0.27) {
        [imageView setImage:[UIImage imageNamed:@"4.png"]];
    }else if (0.27<lowPassResults<=0.34) {
        [imageView setImage:[UIImage imageNamed:@"5.png"]];
    }else if (0.34<lowPassResults<=0.41) {
        [imageView setImage:[UIImage imageNamed:@"6.png"]];
    }else if (0.41<lowPassResults<=0.48) {
        [imageView setImage:[UIImage imageNamed:@"7.png"]];
    }else if (0.48<lowPassResults<=0.55) {
        [imageView setImage:[UIImage imageNamed:@"8.png"]];
    }else if (0.55<lowPassResults<=0.62) {
        [imageView setImage:[UIImage imageNamed:@"9.png"]];
    }else if (0.62<lowPassResults<=0.69) {
        [imageView setImage:[UIImage imageNamed:@"10.png"]];
    }else if (0.69<lowPassResults<=0.76) {
        [imageView setImage:[UIImage imageNamed:@"11.png"]];
    }else if (0.76<lowPassResults<=0.83) {
        [imageView setImage:[UIImage imageNamed:@"13.png"]];
    }else if (0.83<lowPassResults<=0.9) {
        [imageView setImage:[UIImage imageNamed:@"15.png"]];
    }else {
        [imageView setImage:[UIImage imageNamed:@"17.png"]];
    }
}


- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    headBackImage.hidden = YES;
    
    UIImageView *backImage = [[UIImageView alloc] initWithFrame:CGRectMake(0, 0, 1024, 748)];
    backImage.image = [UIImage imageNamed:@"rebj.jpg"];
    [self.view addSubview:backImage];
    [backImage release];
    
    infoLabel.text = @"录音机";
    infoLabel.textAlignment = NSTextAlignmentCenter;
    nameLabel.hidden = YES;
    
    [self.view sendSubviewToBack:backImage];
    
    
    UIImageView *huaTong = [[UIImageView alloc]initWithFrame:CGRectMake(1024/2-188/2, 200, 188, 316)];
    huaTong.image = [UIImage imageNamed:@"reht.png"];
    [self.view addSubview:huaTong];
    [huaTong release];
    
    UIImageView *showTime = [[UIImageView alloc]initWithFrame:CGRectMake(1024-300, 70, 287, 51)];
    showTime.image = [UIImage imageNamed:@"re_time.png"];
    [self.view addSubview:showTime];
    [showTime release];
    
    
    timerLab = [[UILabel alloc]initWithFrame:CGRectMake(0, 0, 287, 50)];
    timerLab.font = [UIFont systemFontOfSize:26];
    timerLab.text = @"00:00:00";
    timerLab.backgroundColor = [UIColor clearColor];
    timerLab.textAlignment = NSTextAlignmentCenter;
    timerLab.textColor = [UIColor redColor];
    [showTime addSubview:timerLab];
    [timerLab release];
    
    imageView = [[UIImageView alloc] initWithFrame:CGRectMake(630, 230, 36, 234)];
    imageView.image = [UIImage imageNamed:@"1.png"];
    imageView.hidden = YES;
    [self.view addSubview:imageView];
    [imageView release];
    
    needStart = NO;
    
    
    
    btnPlay = [[UIButton alloc]initWithFrame:CGRectMake(450,600, 100, 100)];
    btnPlay.backgroundColor = [UIColor clearColor];
    [btnPlay setImage:[UIImage imageNamed:@"re_start"] forState:UIControlStateNormal];
    [btnPlay addTarget:self action:@selector(btnStart:) forControlEvents:UIControlEventTouchUpInside];
    [self.view addSubview:btnPlay];
    [btnPlay release];
    
    UIButton *btn2 = [[UIButton alloc]initWithFrame:CGRectMake(600,600, 100, 100)];
    btn2.backgroundColor = [UIColor clearColor];
    [btn2 setImage:[UIImage imageNamed:@"re_stop.png"] forState:UIControlStateNormal];
    [btn2 addTarget:self action:@selector(btnStop) forControlEvents:UIControlEventTouchUpInside];
    [self.view addSubview:btn2];
    [btn2 release];
    
   
        
    
    UIButton *btnSave = [[UIButton alloc] initWithFrame:CGRectMake(900, 10, 101, 38)];
    [btnSave setImage:[UIImage imageNamed:@"note保存.png"] forState:UIControlStateNormal];
    [btnSave addTarget:self action:@selector(btnSave) forControlEvents:UIControlEventTouchUpInside];
    [stateImage addSubview:btnSave];
    [btnSave release];
    
    
	// Do any additional setup after loading the view.
}

- (void)updateTimer
{

    
    
    NSDate *timerDate = [NSDate dateWithTimeIntervalSince1970:recorder.currentTime];
    
    NSDateFormatter *dateFormatter = [[NSDateFormatter alloc] init];
    [dateFormatter setDateFormat:@"HH:mm:ss"];
    [dateFormatter setTimeZone:[NSTimeZone timeZoneForSecondsFromGMT:0.0]];
    
    NSString *timeString=[dateFormatter stringFromDate:timerDate];
    timerLab.text = timeString;
    [dateFormatter release];
}

-(void)btnStart:(UIButton *)btn{
    
    
    if (isRecord ==0){
        
        //如果存在录音的话，就stop，删除，释放，然后重置。
        if (needStart == NO) {
            
            [self audio];
        }else{
            
            if (isSaved == NO) {
                [recorder stop];
                [recorder release];
            }
            [self audio];
        }
        //创建录音文件，准备录音
        if ([recorder prepareToRecord]) {
            //开始
            [recorder record];
        }
        
        
        
        //设置定时检测
        timer = [NSTimer scheduledTimerWithTimeInterval:0.01 target:self selector:@selector(detectionVoice) userInfo:nil repeats:YES];
        [btnPlay setImage:[UIImage imageNamed:@"re_pause"] forState:UIControlStateNormal];
        isRecord = 1;
        
    }else{
        if (timer) {
            [timer invalidate];
            timer = nil;
        }
        
        [recorder pause];
        [btnPlay setImage:[UIImage imageNamed:@"re_start"] forState:UIControlStateNormal];

        isRecord = 0;
    }
    
   
}

//停止的时候
-(void)btnStop{
    
   
    
    [recorder pause];
    if (timer) {
        
        [timer invalidate];
        timer = nil;
    }
    needStart = YES;
    
    
    
    [btnPlay setImage:[UIImage imageNamed:@"re_start"] forState:UIControlStateNormal];
    isRecord = 0;

    

}
-(BOOL)isTimeEnough{
    
    double cTime = recorder.currentTime;
    
    NSLog(@"cTime is %f",cTime);
    
    if (cTime > 2) {//如果录制时间<2 不发送
        NSLog(@"发出去");
        
        return YES;
    }
    return NO;
   
}
//显示警告窗体
-(void)showAlertView{
    
    
    UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"请输入文件保存名字" message:@"\n\n\n" delegate:self cancelButtonTitle:@"取消" otherButtonTitles:@"确定", nil];
    
    
    UITextField *textField3 = [[UITextField alloc]initWithFrame:CGRectMake(10, 70, 260, 30)];
    [textField3 setBorderStyle:UITextBorderStyleRoundedRect];
    textField3.tag = 10;
    textField3.text = @"";
    textField3.backgroundColor = [UIColor clearColor];
    [alert addSubview:textField3];
    [textField3 release];
    
    [textField3 becomeFirstResponder];
    
    [alert show];
    [alert release];
}

-(void)btnSave{
    
    
    
    if ([self isTimeEnough]) {
        
        [self btnStop];

        [self showAlertView];
        
    }else{
        
        [self btnStop];

        UIAlertView *alert = [[UIAlertView alloc] initWithTitle:@"提示" message:@"录制时间太短，请重新录制!" delegate:nil cancelButtonTitle:@"确定" otherButtonTitles:nil, nil];
        [alert show];
        [alert release];
        
    }

    
    
}
- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex{
    
    if (buttonIndex == 1) {
        
        NSString *strTitle = ((UITextField *)[alertView viewWithTag:10]).text;
        NSLog(@"str is %@",strTitle);
        
        BOOL success;
        NSFileManager *fileManager = [NSFileManager defaultManager];
        NSError *error;
        
        
        NSArray *paths = NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES);
        NSString *documentsDirectory = [paths objectAtIndex:0];
        
        NSString * strName = [NSString stringWithFormat:@"%@.aac",[ToolClass getCurretDate]];
        NSString *imageFile = [documentsDirectory stringByAppendingPathComponent:strName];
        NSLog(@"%@", imageFile);
        
        success = [fileManager fileExistsAtPath:imageFile];
        if(success) {
            success = [fileManager removeItemAtPath:imageFile error:&error];
        }
        NSString *beforeFile = [documentsDirectory stringByAppendingPathComponent:@"lll.aac"];
        
        NSData *fileData = [[NSData alloc] initWithContentsOfFile:beforeFile];
        BOOL isWrite = [fileData writeToFile:imageFile atomically:YES];
        NSLog(@"isWrite is %d",isWrite);
        [fileData release];
        
        BOOL deleteBefore = [fileManager removeItemAtPath:beforeFile error:&error];
        NSLog(@"deleteBefore is %d",deleteBefore);
        
        
        
        NSString *dbName =[NSString stringWithFormat:@"%@.db",@"local"];
        NSString *dbPath = [documentsDirectory stringByAppendingPathComponent:dbName];
        FMDatabase *db = [FMDatabase databaseWithPath:dbPath];
        if (![db open]) {
            //NSLog(@"Could not open db.");
        }
        [db executeUpdate:@"INSERT INTO resour_table(re_id,type,re_title,localURL) VALUES (?,?,?,?)",@"",[NSString stringWithFormat:@"%d",3],strTitle,strName];
        
        isSaved = YES;
        
        [recorder stop];
        [recorder release];
    }
    
}
- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
-(void)btnBackAction{
    
    if (timer) {
        [timer invalidate];
        timer = nil;
    }
    
    if (isSaved == NO) {
        
        [recorder stop];
        [recorder deleteRecording];
        [recorder release];
        
    }
    
    
    
    [super  btnBackAction];
}

#if __IPHONE_OS_VERSION_MAX_ALLOWED >= __IPHONE_6_0

-(NSUInteger)supportedInterfaceOrientations
{
    return UIInterfaceOrientationMaskLandscape;
}

- (BOOL)shouldAutorotate {
    return YES;
}

#endif
// Override to allow orientations other than the default portrait orientation.
- (BOOL)shouldAutorotateToInterfaceOrientation:(UIInterfaceOrientation)interfaceOrientation
{
    // Return YES for supported orientations
    return (interfaceOrientation == UIInterfaceOrientationLandscapeLeft  ||
            interfaceOrientation == UIInterfaceOrientationLandscapeRight);
    
}

-(void)dealloc{
    
    [super dealloc];
}
@end
