<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/homework.css"/>

<!--多文件上传plupload插件-->
<link rel="stylesheet" href="/Public/Js/Public/plupload/jquery.plupload.queue/css/jquery.plupload.queue.css">
<script type="text/javascript" src="/Public/Js/Public/plupload/plupload.full.js"></script>
<script type="text/javascript" src="/Public/Js/Public/plupload/jquery.plupload.queue/jquery.plupload.queue.js"></script>
<script type="text/javascript" src="/Public/Js/Public/plupload/i18n/zh-cn.js"></script>
<!--结束-->

<script type="text/javascript">
    var SysSecond;
    var InterValObj;
    var sign;
    var maxTime;

    $(function(){

        // 删除简答题图片
        $('.del_shortAnswer').click(function(){

            var _this = $(this);
            if(confirm("确定要删除该答案吗?")) {
                $.post('__URL__/del_picAnswer', 'filename='+$(this).prev().attr('alt'), function(json){
                    if (json) {
                            _this.parent().remove();
                        }
                }, 'json');
            }
        });


        if ($('.download a').size() == 0) {
            $('.attachment').hide();
        }

        var width = parseInt($('.do_homework .bar i').html());

        // 题目正确率显示
        $('.do_homework .bar i').animate({width: width+'%'}, "slow");

        // 作业多文件上传
        reloadFileUpload();

        // 计算做作业用时
        if ($('input[name=ad_status]').val() != 4 && $('input[name=ad_storage]').val() != 1) {

            // 开始时间
            if (!$('input[name=ad_use_time]').val()) {
                SysSecond = 0;
            } else {
                SysSecond = parseInt($('input[name=ad_use_time]').val());
            }
            maxTime = {$homework['ap_complete_time']};
            InterValObj = window.setInterval("Timer('+',"+maxTime+")", 1000);    //间隔函数，1秒执行

            // 关闭计时器
            $('.closeTimer').click(function(){

                var reset = "<span class='resetTimer'>开启计时</div>";
                $(this).hide();
                $(this).prev().hide();
                $(this).after(reset);
            })

            // 开启计时器
            $(document).on('click','.resetTimer',function(){

                $(this).hide();
                $(this).prev().show();
                $(this).prev().prev().show();
            })
        } else {
            $('.dohw_bottom').hide();
        }


        //显示正确率
        var per = $('.precision .bar').width();
        if(per == 0){
            $('.precision i').html('');
        }

        $('.publish').click(function(){

            $('input[name=ad_storage]').val(1);
        });

        $('.storage').click(function(){
            $('input[name=ad_storage]').val(0);
        });

        $(document).on('click', '.dohw_bottom .btn img', function () {

            // 如果用户上传了附件，但忘了点击上传按钮，自动点击上传
            if ($('.plupload_buttons').css('display') != 'none' && $('#uploader_filelist').children().size() > 0) {
                $('.plupload_start').click();
                var uploader = $('#uploader').pluploadQueue();
                // Files in queue upload them first
                if (uploader.files.length > 0) {
                    // When all files are uploaded submit form
                    uploader.bind('UploadComplete', function() {
                        if (uploader.files.length === (uploader.total.uploaded + uploader.total.failed)) {
                            check();
                        }
                    });
                    uploader.start();
                }
            } else {
                check();
            }
        });

        // 单机未转码的资源，自动下载
        $(document).on('click', '.ListFiles', function () {
            var rel = $(this).attr('rel');
            if ($(this).attr('trans') == 0) {
                if (confirm('该附件未转码，是否下载该附件？')) {
                    location.href = "/Activity/download/?id=" + rel;
                }
            } else {
                $(this).attr({'target':'_blank', 'href':'__APPURL__/AuthResource/show/ar_id/' + rel});
            }
        })

    })

    // 设置单选按钮
    function setRadio(num, rel) {
        $(".to_answer"+num).val(rel);
    }

    // 设置多选按钮
    function setCheckBox(num) {

        $(".topicObj").each(function() {
            if ($(this).attr('attr') == num) {
                var str = '';
                $(this).find('input[type=checkbox]:checked').each(function() {
                    str += ',' + $(this).attr('rel');
                })

                str = str.slice(1);
                $(".to_answer"+num).val(str);
            }
        })

    }

    // 检查表单
    function check() {

        var flag = true;

        // 循环验证每个题
        $('.topicObj').each(function() {

            var i = $(this).attr('attr');
            var n_type = $(".to_type"+i).val();

            // 验证是否选择答案
            if (n_type != 3 && n_type != 5) {
                if ($(".to_answer"+i).val() == "-1") {
                    flag = false;
                }
            }

        })

        $("input[type=text]").each(function() {

            if ($(this).val() == '') {
                flag = false;
            }
        })

        $("textarea").each(function() {

            if ($(this).val() == '') {
                flag = false;
            }
        })

        if (flag == false) {
            if (confirm('您有未回答的题目，确定要提交吗？')) {
                submitForm();
            } else {
                return false;
            }
        }

        submitForm();

    }

    function submitForm() {

        // 获取作业用时
        var hour = parseInt($('.hour').text()) * 60 * 60;
        var mintue = parseInt($('.mintue').text()) * 60;
        var second = parseInt($('.second').text());

        $('input[name=ad_use_time]').val(hour + mintue + second);

        // 获取练习超时
        if ($('input[name=ad_status]').val() != 4) {

            if ($('.oversecond').text() != '') {

                var overhour = parseInt($('.overhour').text()) * 60 * 60;
                var overmintue = parseInt($('.overmintue').text()) * 60;
                var oversecond = parseInt($('.oversecond').text());

                $('input[name=ad_out_time]').val(overhour + overmintue + oversecond);
                $('input[name=ad_use_time]').val(hour + mintue + second + overhour + overmintue + oversecond);

            }

        }

        // 等待转码
        Loading();
        $('form:first').attr({'action': '__URL__/insert', 'method': 'post'}).submit();
    }

    // 初始化多文件上传
    function reloadFileUpload() {
        var maxSize = {$maxSize};
        $("#uploader").pluploadQueue({
            // General settings
            runtimes: 'html4,html5,flash,silverlight,gears,browserplus',
            url: '__URL__/acceptFiles',
            max_file_size : maxSize+'mb',
            chunk_size : '10mb',
            unique_names: true,
            // Resize images on clientside if we can
            resize: {width: 320, height: 240, quality: 90},
            dragdrop: true,
            // Specify what files to browse for
            filters: [
                {title: "Image files", extensions: "png,jpg,gif,bmp,jpeg"},
                {title: "Zip files", extensions: "zip,rar"},
                {title: "Audio files", extensions: "mp3,m4a,m4v"},
                {title: "Mindmark files", extensions: "db"},
                {title: "Video files", extensions: "mpeg,mp4,avi,rmvb,rm,wmv,fla,3gp,flv"},
                {title: "Docs files", extensions: "txt,doc,xls,ppt,docx,xlsx,pptx,pdf"}
            ],
            // Flash settings
            flash_swf_url: '/Public/Js/Public/plupload/plupload.flash.swf',
            // Silverlight settings
            silverlight_xap_url: '/Public/Js/Public/plupload/plupload.silverlight.xap',
            init: {
                FileUploaded: function(up, file, info) {
                    var reg = /error(.*)<\/p>/ig;
                    var res = info.response.match(reg);
                    if (res) {
                        var str = res.toString();
                        alert(str.slice(7,-4));
                        location.reload(true);
                    }
                }
            },
        });
    }

</script>

<form method="post" class="qqx" action="">
<div class="warp">
<!-- 作业用时 -->
<input name="ad_use_time" value="{$homeworkData['ad_use_time']}" type="hidden" />
<!-- 练习超时 -->
<input name="ad_out_time" value="" type="hidden" />
<!-- 作业状态 -->
<input name="ad_status" value="{$homeworkData['ad_status']}" type="hidden" />

<!-- 是否存为草稿 -->
<input name="ad_storage" value="{$homeworkData['ad_storage']}" type="hidden" />

    <div class="do_homework">
        <div id="book_ring"></div>
        <div class="title">
            {$homework.act_title}
            <eq name="homework.act_type" value="1">
                <a href="__APPURL__/Homework">返回</a>
            <else />
                <a href="__APPURL__/Classwork">返回</a>
            </eq>
        </div>
        <div class="precision">
            <label>正确率：</label>
            <span class="bar"><i><if condition="$homeworkData.ad_persent neq ''">{$homeworkData.ad_persent}%<else /></if></i></span>
        </div>
        <div class="attachment fl">
            <div class="download">
                <label>附件下载：</label>
                <volist name="uploadFiles" id="vo">
                    <a href="javascript:void(0)" rel="{$key}" trans="{$vo.ar_is_transform}" class="ListFiles">{$vo.ar_title}</a>
                </volist>
            </div>
            <div class="upload">
                <label class="fl">附件上传：</label>
                <div id="uploader" style="background:#F3F2F0; margin-left: 10px; width:500px;" class="fl">
                    <p>上传资源控件加载错误，可能是您的浏览器不支持 Flash, Silverlight, Gears, BrowserPlus 或 HTML5，请检查</p>
                </div>
            </div>
        </div>

        <input type="hidden" value="{$homework.ap_id}" name="ap_id" />
        <div class="dohw_list fl">
        <php> $showKey = 0; </php>
            <volist name="lists" id="list">
                <eq name="list.to_type" value="1">
                    <div class="topicObj fl" attr="{$list.to_id}" ty="{$list.to_type}">
                        <p class="tpoic_top <eq name='list.ex_er' value='0'>answer_error</eq>" >第{$showKey+1}题：单选题</p>
                        <div class="tpoic_main fl">
                            <div class="tpoic_main_r">
                                <div class="content">{$list.to_title}</div>

                                <eq name="answerShow" value="1">
                                    <div class="answer">
                                        <label>正确答案：</label>{$list.exact}
                                    </div>
                                </eq>


                                <div class="s_answer">
                                    <label class="la">答案：</label>
                                    <input type="hidden" name="to_answer[{$list.to_id}]" class="to_answer{$list.to_id}" value="{$list.stu_answer}">
                                    <input type="hidden" name="to_type[{$list.to_id}]" class="to_type{$list.to_id}" value="{$list.to_type}">
                                    <div class="student_answer">
                                            <php> $showOption = 1; </php>
                                            <volist name="list.to_option" id="option">

                                                <input type="radio" name="single to_answer{$list.to_id}" value="0" onclick="setRadio('{$list.to_id}', '{$showOption-1}')" <gt name='list.stu_answer|intval' value='-1'><eq name='showOption-1' value='$list.stu_answer'>checked="checked"</eq></gt>><label class="option" style="cursor: pointer;">{$tit[$showOption-1]}</label>

                                                <php> $showOption ++; </php>
                                           </volist>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </eq>
                <eq name="list.to_type" value="2">
                    <div class="topicObj fl" attr="{$list.to_id}" ty="{$list.to_type}">
                    <p class="tpoic_top <eq name='list.ex_er' value='0'>answer_error</eq>">第{$showKey+1}题：多选题</p>
                        <div class="tpoic_main fl">
                            <div class="tpoic_main_r">
                                <div class="content">{$list.to_title}</div>
                                <eq name="answerShow" value="1">
                                    <div class="answer">
                                        <label>正确答案：</label>{$list.exact}
                                    </div>
                                </eq>
                                <div class="s_answer">
                                    <label class="la">答案：</label>
                                    <input type="hidden" name="to_answer[{$list.to_id}]" class="to_answer{$list.to_id}" value="{$list.stu_answer}">
                                    <input type="hidden" name="to_type[{$list.to_id}]" class="to_type{$list.to_id}" value="{$list.to_type}">
                                    <div class="student_answer">
                                        <php> $showOption = 1; </php>
                                        <volist name="list.to_option" id="option">
                                            <input type="checkbox" name="multiple to_answer" value="0" onclick="setCheckBox({$list.to_id})" rel="{$showOption-1}" <neq name='list.stu_answer' value=''><in name='showOption-1' value='$list.stu_answer'>checked="checked"</in></neq>><label class="option" style="cursor: pointer;">{$tit[$showOption-1]}</label>
                                            <php> $showOption ++; </php>
                                        </volist>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </eq>
                <eq name="list.to_type" value="3">
                    <div class="topicObj fl" attr="{$list.to_id}" ty="{$list.to_type}">
                    <p class="tpoic_top <eq name='list.ex_er' value='0'>answer_error</eq>">第{$showKey+1}题：填空题</p>
                        <div class="tpoic_main fl">
                            <div class="tpoic_main_r">
                                <div class="content">{$list.to_title}</div>
                                <eq name="answerShow" value="1">
                                    <div class="answer">
                                        <label>正确答案：</label>{$list.exact}
                                    </div>
                                </eq>
                                <div class="s_answer">
                                    <label class="la">答案：</label>
                                    <input type="hidden" name="to_type[{$list.to_id}]" class="to_type{$list.to_id}" value="{$list.to_type}">
                                    <div class="student_answer" type="text">
                                         <php> $showOption = 1; </php>
                                         <volist name="list.to_option" id="option" key='kkk'>
                                            {$showOption}、<input type="text" name="to_answer[{$list.to_id}][]" value="{$list['stu_answer'][$kkk-1]}" />
                                            <php> $showOption ++; </php>
                                         </volist>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </eq>
                <eq name="list.to_type" value="4">
                    <div class="topicObj fl" attr="{$list.to_id}" ty="{$list.to_type}">
                    <p class="tpoic_top <eq name='list.ex_er' value='0'>answer_error</eq>">第{$showKey+1}题：判断题</p>
                        <div class="tpoic_main fl">
                            <div class="tpoic_main_r">
                                <div class="content">{$list.to_title}</div>
                                 <eq name="answerShow" value="1">
                                    <div class="answer">
                                        <label>正确答案：</label>{$list.exact}
                                    </div>
                                </eq>
                                <div class="s_answer">
                                    <label class="la">答案：</label>
                                    <input type="hidden" name="to_answer[{$list.to_id}]" class="to_answer{$list.to_id}" value="{$list.stu_answer}">
                                    <input type="hidden" name="to_type[{$list.to_id}]" class="to_type{$list.to_id}" value="{$list.to_type}">
                                    <div class="{$list.stu_answer}">
                                        <input type="radio" name="judge to_answer{$list.to_id}" onclick="setRadio({$list.to_id}, 0)" <eq name='list.stu_answer' value='0'>checked="checked"</eq>><label class="option" style="cursor: pointer;" attr="1"><img src="__APPURL__/Public/Images/Home/ok.png" width="20" height="20" border="0"></label>
                                        <input type="radio" name="judge to_answer{$list.to_id}" onclick="setRadio({$list.to_id}, 1)" <eq name='list.stu_answer' value='1'>checked="checked"</eq>><label class="option" style="cursor: pointer;" attr="0"><img src="__APPURL__/Public/Images/Home/err.png" width="20" height="20" border="0"></label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </eq>
                <eq name="list.to_type" value="5">
                    <div class="topicObj fl" attr="{$list.to_id}" ty="{$list.to_type}">
                    <p class="tpoic_top <eq name='list.ex_er' value='0'>answer_error</eq>">第{$showKey+1}题：简答题</p>
                        <div class="tpoic_main fl">
                            <div class="tpoic_main_r">
                                <div class="content">{$list.to_title}</div>
                                <eq name="answerShow" value="1">
                                    <div class="answer">
                                        <label>正确答案：</label>{$list.exact}
                                    </div>
                                </eq>
                                <div class="s_answer">
                                    <label class="la">答案：</label>
                                    <input type="hidden" name="to_type[{$list.to_id}]" class="to_type{$list.to_id}" value="{$list.to_type}">
                                    <div class="student_answer">
                                        <textarea name="to_answer[{$list.to_id}]" style="width:400px;height:80px" type="text"><if condition="$list.stu_answer eq -1"><else />{$list.stu_answer}</if></textarea>
                                    </div>
                                </div>
                                <div class="shorAnswer">
                                    <volist name="list.picture_answer" id="pic">
                                        <div>
                                            <img src="{$pic.url}" alt="{$pic.filename}" style="width:600px;height:450px;"/>
                                            <a href="javascript:void(0);" class="del_shortAnswer"></a>
                                        </div>

                                    </volist>
                                </div>
                            </div>
                        </div>
                    </div>
                </eq>
                <php> $showKey ++; </php>

            </volist>
        </div>
        <if condition="$homeworkData.ad_status eq 4">
            <div class="scolded">
                <label>老师评语：</label>
                <p>{$homeworkData.ad_remark}</p>
            </div>
        </if>
    </div>


    <div class="clear"></div>
</div>

<div class="dohw_bottom">
    <div class="timer">
        <img src="__APPURL__/Public/Images/Home/use_time.png">
        <span class="useSeconds">
            <cite class="hour"></cite>时
            <cite class="mintue"></cite>分
            <cite class="second"></cite>秒
        </span>
        <span class="overTime hide">
            <cite>你已超出：</cite>
            <cite class="overhour"></cite>时
            <cite class="overmintue"></cite>分
            <cite class="oversecond"></cite>秒
        </span>
    </div>
    <span class="closeTimer">关闭计时</span>
    <div class="btn fr">
        <img class="storage"/>
        <img class="publish"/>
    </div>
</div>
</form>

