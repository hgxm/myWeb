//
//  FabuHomework.m
//  BigClassRoom
//
//  Created by apple  on 13-1-24.
//
//

#import "FabuHomework.h"

#define offsetx 60
@implementation FabuHomework
@synthesize workDele;
- (id)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        // Initialization code
        

        
        UIView *blackview=[[UIView alloc]initWithFrame:CGRectMake(0, 0, 1024, 748)];
        blackview.backgroundColor=[UIColor blackColor];
        blackview.tag = 1;
        blackview.alpha=0.3;
        [self addSubview:blackview];
        [blackview release];
        
        UIImageView *backImageview=[[UIImageView alloc]initWithFrame:CGRectMake(1024/2-914/2, 748/2-514/2+30, 914, 514)];
        backImageview.image=[UIImage imageNamed:@"dt答题板.png"];
        backImageview.userInteractionEnabled=YES;
        [self addSubview:backImageview];
        [backImageview release];
        
        UILabel *lblTime=[[UILabel alloc]initWithFrame:CGRectMake(20, 15, 200, 25)];
        lblTime.textAlignment=NSTextAlignmentLeft;
        lblTime.font=[UIFont boldSystemFontOfSize:20];
        lblTime.textColor = MYCOLOR;
        lblTime.backgroundColor=[UIColor clearColor];
        lblTime.text=@"作业截止时间:";
        [backImageview addSubview:lblTime];
        [lblTime release];
        
        calendar = [[NSCalendar alloc] initWithCalendarIdentifier:NSGregorianCalendar];

        comps = [[NSDateComponents alloc] init];
        unitFlags = NSYearCalendarUnit | NSMonthCalendarUnit | NSDayCalendarUnit | NSWeekdayCalendarUnit |
        NSHourCalendarUnit | NSMinuteCalendarUnit | NSSecondCalendarUnit;
        myDate=[[NSDate alloc] init];
        comps = [calendar components:unitFlags fromDate:myDate];
        
        year=[comps year];
        month=[comps month];
        day=[comps day];
        
        //    month = [comps month];
        //    day = [comps day];
        //    hour = [comps hour];
        //    min = [comps minute];
        //    sec = [comps second];
        //@"2013年1月20日00点00分";
        lblShowTime=[[UILabel alloc]initWithFrame:CGRectMake(160, 15, 240, 25)];
        lblShowTime.textAlignment=NSTextAlignmentLeft;
        lblShowTime.font=[UIFont boldSystemFontOfSize:20];
        lblShowTime.textColor=[UIColor redColor];
        lblShowTime.backgroundColor=[UIColor clearColor];
        lblShowTime.text=[NSString stringWithFormat:@"%d年%d月%d日00点00分",year,month,day];
        [backImageview addSubview:lblShowTime];
        [lblShowTime release];
        
               
              
        select1=0;
        select2=0;
        
        strHour=@"00";
        strMinute=@"00";
        
        
           
        muarr1 = [[NSMutableArray alloc] init];
        [muarr1 addObject:@""];
        [muarr1 addObject:@""];
        for (int i=0; i<24; i++) {
            if (i<10) {
                [muarr1 addObject:[NSString stringWithFormat:@"0%d",i]];

            }else{
                [muarr1 addObject:[NSString stringWithFormat:@"%d",i]];

            }
        }
        [muarr1 addObject:@""];
        [muarr1 addObject:@""];
        
        for (int i=0; i<2; i++) {
            UILabel *lbl = [[UILabel alloc] initWithFrame:CGRectMake(100+i*80+offsetx, 120, 40, 20)];
            lbl.backgroundColor = [UIColor clearColor];
            lbl.textAlignment = NSTextAlignmentCenter;
            lbl.font = [UIFont boldSystemFontOfSize:20];
            lbl.textColor = [UIColor colorWithRed:69.0/255 green:69.0/255 blue:69.0/255 alpha:1];
            switch (i) {
                case 0:
                    lbl.text = @"时";
                    break;
                case 1:
                    lbl.text = @"分";
                    break;
                default:
                    break;
            }
            [backImageview addSubview:lbl];
            [lbl release];
        }
        
        UILabel *lbl = [[UILabel alloc] initWithFrame:CGRectMake(140+offsetx, 150+110, 40, 20)];
        lbl.backgroundColor = [UIColor clearColor];
        lbl.textAlignment = NSTextAlignmentCenter;
        lbl.font = [UIFont boldSystemFontOfSize:20];
        lbl.textColor = [UIColor redColor];
        lbl.text = @":";
        [backImageview addSubview:lbl];
        [lbl release];
        
        UIView *lineView = [[UIView alloc] initWithFrame:CGRectMake(370, 110, 1, 280)];
        lineView.backgroundColor = [UIColor colorWithRed:56.0/255 green:56.0/255 blue:56.0/255 alpha:1];
        [backImageview addSubview:lineView];
        [lineView release];
        
        scroll = [[UIScrollView alloc] initWithFrame:CGRectMake(100+offsetx, 170, 40, 200)];
        scroll.backgroundColor =[ UIColor clearColor];
        scroll.delegate = self;
        [scroll setShowsVerticalScrollIndicator:NO];
        [backImageview addSubview:scroll];
        [scroll release];
        
        UIView *viewSeeee = [[UIView alloc] initWithFrame:CGRectMake(100+offsetx, 170+80, 40, 40)];
        viewSeeee.backgroundColor = [UIColor colorWithRed:56.0/255 green:56.0/255 blue:56.0/255 alpha:1];
        viewSeeee.alpha = 0.3;
        [backImageview addSubview:viewSeeee];
        [viewSeeee release];
        
        
                
        for (int i=0; i<[muarr1 count]; i++) {
            UIButton *btn = [[UIButton alloc] initWithFrame:CGRectMake(0, i*40, 40, 40)];
            [btn setTitle:[muarr1 objectAtIndex:i] forState:UIControlStateNormal];
            btn.tag = i+100;
            btn.titleLabel.font = [UIFont boldSystemFontOfSize:18];
            [btn addTarget:self action:@selector(selectHour:) forControlEvents:UIControlEventTouchUpInside];
            [btn setTitleColor:[UIColor colorWithRed:69.0/255 green:69.0/255 blue:69.0/255 alpha:1] forState:UIControlStateNormal];
            [scroll addSubview:btn];
            [btn release];
        }
        [scroll setContentSize:CGSizeMake(40,[muarr1 count]*40)];
        
        
        
        
        muarr2 = [[NSMutableArray alloc] init];
        [muarr2 addObject:@""];
        [muarr2 addObject:@""];
        for (int i=0; i<60; i++) {
            
            
            if (i<10) {
                [muarr2 addObject:[NSString stringWithFormat:@"0%d",i]];
                
            }else{
                [muarr2 addObject:[NSString stringWithFormat:@"%d",i]];
                
            }
        }
        [muarr2 addObject:@""];
        [muarr2 addObject:@""];
        
        scroll2 = [[UIScrollView alloc] initWithFrame:CGRectMake(100+80+offsetx, 170, 40, 200)];
        scroll2.backgroundColor =[ UIColor clearColor];
        scroll2.delegate = self;
        [scroll2 setShowsVerticalScrollIndicator:NO];
        [backImageview addSubview:scroll2];
        [scroll2 release];
        
        UIView *viewSeeee2 = [[UIView alloc] initWithFrame:CGRectMake(100+80+offsetx, 170+80, 40, 40)];
        viewSeeee2.alpha = 0.3;
        viewSeeee2.backgroundColor = [UIColor colorWithRed:56.0/255 green:56.0/255 blue:56.0/255 alpha:1];
        [backImageview addSubview:viewSeeee2];
        [viewSeeee2 release];
        
        for (int i=0; i<[muarr2 count]; i++) {
            UIButton *btn = [[UIButton alloc] initWithFrame:CGRectMake(0, i*40, 40, 40)];
            [btn setTitle:[muarr2 objectAtIndex:i] forState:UIControlStateNormal];
            btn.tag = i+200;
            btn.titleLabel.font = [UIFont boldSystemFontOfSize:18];
            [btn addTarget:self action:@selector(selectSecond:) forControlEvents:UIControlEventTouchUpInside];
            [btn setTitleColor:[UIColor colorWithRed:69.0/255 green:69.0/255 blue:69.0/255 alpha:1] forState:UIControlStateNormal];
            [scroll2 addSubview:btn];
            [btn release];
        }
        [scroll2 setContentSize:CGSizeMake(40,[muarr2 count]*40)];
        

        
        
        
        UIButton *btnHour = (UIButton *)[scroll viewWithTag:100+10];
        [self selectHour:btnHour];
        
        UIButton *btnSecond = (UIButton *)[scroll2 viewWithTag:200+32];
        [self selectSecond:btnSecond];
        
        
        
        VRGCalendarView *calendar2 = [[VRGCalendarView alloc] init];
        calendar2.frame=CGRectMake(550, 250, calendar2.frame.size.width, calendar2.frame.size.height);
        calendar2.delegate=self;
        [self addSubview:calendar2];
        [calendar2 release];
       
        
        
        UIButton *btnFinish = [[UIButton alloc] initWithFrame:CGRectMake(840, 14, 56, 25)];
        [btnFinish addTarget:self action:@selector(btnSubmitAction) forControlEvents:UIControlEventTouchUpInside];
        [btnFinish setImage:[UIImage imageNamed:@"dt完成.png"] forState:UIControlStateNormal];
        [backImageview addSubview:btnFinish];
        [btnFinish release];

        
               
        
    }
    return self;
}

-(void)selectHourAndSecond{
    
    
    
   
    comps = [calendar components:unitFlags fromDate:myDate];
    
    year=[comps year];
    month=[comps month];
    day=[comps day];
    
    
    
    strHour=[muarr1 objectAtIndex:select1];
    strMinute=[muarr2 objectAtIndex:select2];
    
    NSString *strTitle = [NSString stringWithFormat:@"%d年%d月%d日%@点%@分",year,month,day,strHour,strMinute];
    strTitle = [strTitle stringByReplacingOccurrencesOfString:@"\t" withString:@""];
    lblShowTime.text  = strTitle;
    
    
}


-(void)setUPScroll{
    
    for (int i= 0; i<[muarr1 count]; i++) {
        
        UIButton *btn = (UIButton *)[scroll viewWithTag:100+i];
        [btn setTitleColor:[UIColor colorWithRed:69.0/255 green:69.0/255 blue:69.0/255 alpha:1] forState:UIControlStateNormal];
    }
}
-(void)setUPScroll2{
    
    for (int i= 0; i<[muarr2 count]; i++) {
        
        UIButton *btn = (UIButton *)[scroll2 viewWithTag:200+i];
        [btn setTitleColor:[UIColor colorWithRed:69.0/255 green:69.0/255 blue:69.0/255 alpha:1] forState:UIControlStateNormal];
    }
    
}
-(void)selectHour:(UIButton *)btn{
    
    if (btn.tag == 100||btn.tag == 101||btn.tag == [muarr1 count]-1+100 ||btn.tag == [muarr1 count]-2+100) {
        return;
    }
    [self setUPScroll];
    
    
    [scroll setContentOffset:CGPointMake(0, (btn.tag-100-2)*40) animated:YES];
    [btn setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
    
    select1 = btn.tag - 100;
    
    //刷新时间
    [self selectHourAndSecond];

}
-(void)selectSecond:(UIButton *)btn{
    

    if (btn.tag == 200||btn.tag == 201||btn.tag == [muarr2 count]-1+200 ||btn.tag == [muarr2 count]-2+200) {
        return;
    }
    [self setUPScroll2];

    [scroll2 setContentOffset:CGPointMake(0, (btn.tag-200-2)*40) animated:YES];
    
    [btn setTitleColor:[UIColor redColor] forState:UIControlStateNormal];

    
    select2 = btn.tag -200;
    
    
    //刷新时间
    [self selectHourAndSecond];
}


#pragma mark scrollDelegate
- (void)scrollViewDidEndDecelerating:(UIScrollView *)scrollView{


    if (scrollView == scroll) {
        
        if (flag1 == YES) {
            
            int height = scroll.contentOffset.y;
            int number = height/40;
            [scroll setContentOffset:CGPointMake(0, number*40) animated:YES];
            
            [self setUPScroll];
            
            UIButton *btn = (UIButton *)[scroll viewWithTag:100+number+2];
            [btn setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
            select1 = btn.tag - 100;
            
            //刷新时间
            [self selectHourAndSecond];
            
        }
    }else{
        
        if (flag2 == YES) {
            
            int height = scroll2.contentOffset.y;
            int number = height/40;
            [scroll2 setContentOffset:CGPointMake(0, number*40) animated:YES];
            
            [self setUPScroll2];
            
            UIButton *btn = (UIButton *)[scroll2 viewWithTag:200+number+2];
            [btn setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
            select2 = btn.tag - 200;
            
            //刷新时间
            [self selectHourAndSecond];
            
        }
    }
   
   

}
- (void)scrollViewDidScroll:(UIScrollView *)scrollView{

    if (scrollView ==scroll) {
        flag1 = YES;

    }else{
        flag2 = YES;
    }
   
}


- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate{

    
    if (scrollView ==scroll) {
        
        flag1 = NO;
        [self performSelector:@selector(shuaxinScroll1) withObject:self afterDelay:0.1];
    }else{
        
        flag2 = NO;
        [self performSelector:@selector(shuaxinScroll2) withObject:self afterDelay:0.1];
    }
   
   
        
    
}
-(void)shuaxinScroll1{
    
    if (flag1 == NO) {
        int height = scroll.contentOffset.y;
        int number = height/40;
        [scroll setContentOffset:CGPointMake(0, number*40) animated:YES];
        
        [self setUPScroll];

        
        UIButton *btn = (UIButton *)[scroll viewWithTag:100+number+2];
        [btn setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
        
        select1 = btn.tag - 100;
        
        //刷新时间
        [self selectHourAndSecond];
    }
}

-(void)shuaxinScroll2{
    
    if (flag2 == NO) {
        
        int height = scroll2.contentOffset.y;
        int number = height/40;
        [scroll2 setContentOffset:CGPointMake(0, number*40) animated:YES];
        
        [self setUPScroll2];

        UIButton *btn = (UIButton *)[scroll2 viewWithTag:200+number+2];
        [btn setTitleColor:[UIColor redColor] forState:UIControlStateNormal];
        
        select2 = btn.tag - 200;
        
        //刷新时间
        [self selectHourAndSecond];
    }
}





-(void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event{
    
    UITouch *touch = [touches anyObject];
    if (touch.view == [self viewWithTag:1]) {
        [self removeFromSuperview];
    }
}


-(void)btnSubmitAction{
    
    
    
    NSString *lastModifiedString = [NSString stringWithFormat:@"%d %d %d %@:%@:00",year,month,day,strHour,strMinute];
    NSDateFormatter *df = [[NSDateFormatter alloc] init];
    df.dateFormat = @"yyyy MM dd HH:mm:ss";
    NSDate *dateEnd = [df dateFromString:lastModifiedString];
    NSTimeInterval timeInterval2 = [dateEnd timeIntervalSince1970];
    NSString *timeString = [NSString stringWithFormat:@"%.f", timeInterval2];
    
    [df release];
    
    [workDele fabuHomeWork:timeString];
    
}


-(void)calendarView:(VRGCalendarView *)calendarView switchedToMonth:(int)month targetHeight:(float)targetHeight animated:(BOOL)animated {
//    if (month==[[NSDate date] month]) {
//        NSArray *dates = [NSArray arrayWithObjects:[NSNumber numberWithInt:1],[NSNumber numberWithInt:5], nil];
//        [calendarView markDates:dates];
//    }
}

-(void)calendarView:(VRGCalendarView *)calendarView dateSelected:(NSDate *)date {
    
    myDate=date;
    
    [self selectHourAndSecond];

}

-(void)dealloc{
    
    [muarr1 release];
    [muarr2 release];

    [myDate release];
    [comps release];
    [calendar release];
    [super dealloc];
}

/*
// Only override drawRect: if you perform custom drawing.
// An empty implementation adversely affects performance during animation.
- (void)drawRect:(CGRect)rect
{
    // Drawing code
}
*/

@end
