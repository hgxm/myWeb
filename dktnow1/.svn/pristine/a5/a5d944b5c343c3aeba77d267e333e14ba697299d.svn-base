//
//  ClearView.m
//  BigClassRoom
//
//  Created by apple  on 13-1-11.
//
//

#import "ClearView.h"

@implementation ClearView
@synthesize cleardele;
@synthesize width;
- (id)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        // Initialization code
        //420*217
        UIImageView *backViewImage=[[UIImageView alloc]initWithFrame:CGRectMake(0, 0, self.frame.size.width, self.frame.size.height)];
        backViewImage.image=[UIImage imageNamed:@"橡皮背景.png"];
        backViewImage.userInteractionEnabled=YES;
        [self addSubview:backViewImage];
        [backViewImage release];
        
        UIPanGestureRecognizer *panGestureBack = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(panGestureBack:)];
        [panGestureBack setMaximumNumberOfTouches:2];
        [backViewImage addGestureRecognizer:panGestureBack];
        [panGestureBack release];
        
        UILabel *lbl1=[[UILabel alloc]initWithFrame:CGRectMake(10, 20, 100, 25)];
        lbl1.text=@"橡皮设置";
        lbl1.backgroundColor=[UIColor clearColor];
        lbl1.textColor=[UIColor whiteColor];
        lbl1.font=[UIFont boldSystemFontOfSize:15];
        lbl1.textAlignment=NSTextAlignmentLeft;
        [self addSubview:lbl1];
        [lbl1 release];
        
        UIButton *closeBtn=[[UIButton alloc]initWithFrame:CGRectMake(self.frame.size.width-50, 15, 32, 32)];
        closeBtn.backgroundColor=[UIColor clearColor];
        [closeBtn addTarget:self action:@selector(closeBtnAction) forControlEvents:UIControlEventTouchDown];
        [closeBtn setImage:[UIImage imageNamed:@"关闭按钮.png"] forState:UIControlStateNormal];
        [self addSubview:closeBtn];
        [closeBtn release];

        UIView *view1=[[UIView alloc]initWithFrame:CGRectMake(30, 100, self.frame.size.width-150, 10)];
        view1.backgroundColor=[UIColor colorWithRed:96.0/255 green:72.0/255 blue:50.0/255 alpha:1];
        //view1.layer.cornerRadius=5;
        [view1.layer setMasksToBounds:NO];
        [self addSubview:view1];
        [view1 release];
        
        
        moveImage=[[UIImageView alloc]initWithFrame:CGRectMake(30, 85, 16, 38)];
        moveImage.image=[UIImage imageNamed:@"橡皮滑块.png"];
        moveImage.userInteractionEnabled=YES;
        [self addSubview:moveImage];
        [moveImage release];
        
        yuanImage=[[UIImageView alloc]initWithFrame:CGRectMake(330-1, 68.5, 69, 69)];
        yuanImage.image=[UIImage imageNamed:@"橡皮圈.png"];
        [self addSubview:yuanImage];
        [yuanImage release];
        
        CGAffineTransform transform=CGAffineTransformMakeScale(0.05, 0.05);
        yuanImage.transform=transform;
        
        UIPanGestureRecognizer *panGesturemoveImage = [[UIPanGestureRecognizer alloc] initWithTarget:self action:@selector(panGesturemoveImage:)];
        [panGesturemoveImage setMaximumNumberOfTouches:2];
        [moveImage addGestureRecognizer:panGesturemoveImage];
        [panGesturemoveImage release];
        
        UIButton *clearBtn=[[UIButton alloc]initWithFrame:CGRectMake(10, 155, 400, 48)];
        clearBtn.backgroundColor=[UIColor clearColor];
        [clearBtn setTitle:@"全部清除" forState:UIControlStateNormal];
        [clearBtn setTitleColor:[UIColor blackColor] forState:UIControlStateNormal];
        [clearBtn addTarget:self action:@selector(clearBtnAction:) forControlEvents:UIControlEventTouchDown];
        [clearBtn setBackgroundImage:[UIImage imageNamed:@"清屏1.png"] forState:UIControlStateNormal];
        [self addSubview:clearBtn];
        [clearBtn release];
        
        width=2;
       
        
    }
    return self;
}
-(void)panGesturemoveImage:(UIPanGestureRecognizer *)gestureRecognizer{
    
    UIView *piece = [gestureRecognizer view];
	if ([gestureRecognizer state] == UIGestureRecognizerStateBegan || [gestureRecognizer state] == UIGestureRecognizerStateChanged) {
        
		CGPoint translation = [gestureRecognizer translationInView:[piece superview]];
        [piece setCenter:CGPointMake([piece center].x + translation.x, [piece center].y)];
       
        if (piece.frame.origin.x<=30) {

            piece.frame=CGRectMake(30, piece.frame.origin.y, piece.frame.size.width, piece.frame.size.height);
        }
        if(piece.frame.origin.x>=(self.frame.size.width-120-16)){
            

            piece.frame=CGRectMake(self.frame.size.width-120-16, piece.frame.origin.y, piece.frame.size.width, piece.frame.size.height);
        }
        width = 18.0*(piece.frame.origin.x-30)/(self.frame.size.width-150-16)+2;
        
        float scale=width/40.0;
        CGAffineTransform transform=CGAffineTransformMakeScale(scale, scale);
        yuanImage.transform=transform;
        //NSLog(@"width is %d",width);
        
        if (cleardele&&[cleardele respondsToSelector:@selector(changeClearWidth:)]) {
            [cleardele changeClearWidth:width];
        }
        
		[gestureRecognizer setTranslation:CGPointZero inView:[piece superview]];
	}
}
-(void)panGestureBack:(UIPanGestureRecognizer *)gestureRecognizer{
    
    UIView *piece = [[gestureRecognizer view] superview];
	if ([gestureRecognizer state] == UIGestureRecognizerStateBegan || [gestureRecognizer state] == UIGestureRecognizerStateChanged) {
        
        [[self superview] bringSubviewToFront:self];
        
		CGPoint translation = [gestureRecognizer translationInView:[piece superview]];
        [piece setCenter:CGPointMake([piece center].x + translation.x, [piece center].y+ translation.y)];
        
        CGRect rect=piece.frame;
        if (rect.origin.y<=0) {
            rect.origin.y=0;
        }
        if (rect.origin.x<=0) {
            rect.origin.x=0;
        }
        if (rect.origin.x+rect.size.width>=1024) {
            rect.origin.x=1024-rect.size.width;
        }
        if (rect.origin.y+rect.size.height>=748) {
            rect.origin.y=748-rect.size.height;
        }
        
        
        piece.frame=rect;
        
		[gestureRecognizer setTranslation:CGPointZero inView:[piece superview]];
	}
}
-(void)clearBtnAction:(UIButton*)btn{
    
   // [btn setBackgroundImage:[UIImage imageNamed:@"清屏.png"] forState:UIControlStateNormal];
    if (cleardele&&[cleardele respondsToSelector:@selector(clearScreen)]) {
        [cleardele clearScreen];
    }
    
}
-(void)setNeedsDisplayMyView{
    
    float clearWidth = [[[NSUserDefaults standardUserDefaults]objectForKey:@"clear_width"] floatValue];
    
    //width = 18.0*(piece.frame.origin.x-30)/(self.frame.size.width-150-16)+2;

    float moveX = (clearWidth-2)*(self.frame.size.width-150-16)/18+30;
    
    float scale=clearWidth/40.0;
    CGAffineTransform transform=CGAffineTransformMakeScale(scale, scale);
    yuanImage.transform=transform;
    
    moveImage.frame = CGRectMake(moveX, moveImage.frame.origin.y, moveImage.frame.size.width, moveImage.frame.size.height);
}
-(void)closeBtnAction{
    
    self.hidden=YES;
}


/*
// Only override drawRect: if you perform custom drawing.
// An empty implementation adversely affects performance during animation.
- (void)drawRect:(CGRect)rect
{
    // Drawing code
}
*/

@end
