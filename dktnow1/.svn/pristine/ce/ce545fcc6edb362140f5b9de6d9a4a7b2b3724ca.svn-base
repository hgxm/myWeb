<include file="../Public/header_main" />
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>

<load file="__PUBLIC__/Css/Ilc/resource_index.css"/>

<script type="text/javascript">
$(function(){

     //删除学生
     $(document).on('click','.tea_stu li',function(){
        onClass($(this));
     })
    //选择课程老师选中状态
    $(document).on('click','.tea_set li',function(){
        $(this).addClass('on').siblings().removeClass('on');
    })
    //设置课程老师弹窗
    $('.tea_main .cour').click(function(){
        $('.tea_main li').removeClass('on');
        $(this).parent().addClass('on');
        $(".tea_set").dialog("open");
    })

    //设置课程老师弹窗
    $(".tea_set").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '500',
        height: '350',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
          effect: "explode",
          duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {

                var obj = $(this);

                if ($(".tea_set ul li.on").attr('attr')) {
                    $.post("__URL__/setClassCourseTeacher", 'a_id=' + $(".tea_set ul li.on").attr('attr') + '&cst_id=' + $('.tea_main li.on span:last').attr('cst_id') , function(data) {

                  //  + '&cc_course=' + $(".teacher .setAuth.on").attr('cc_course')

                        if (data == 1) {

                            // 替换标签值
                            var str=",";
                            var tex="";
                            $('.tea_set li').each(function(){
                                var n_text = $(this).text();
                                if ($(this).hasClass('on')) {
                                    tex += str + n_text;
                                }
                            })
                            var new_tex = tex.replace(',',"");
                            $('.tea_main .on').children('span').eq(1).text(new_tex);

                            //关闭窗口
                            obj.dialog('close');

                        } else {
                            alert('操作失败');
                        }
                    })

                } else {
                    alert('请选择老师');
                }


            },
            取消: function() {
                $(this).dialog('close');
            }
        }
    })

    // 教师设置窗口
    $(".cour").click(function() {

        if ($(this).parent().hasClass('on')) {

            $('.tea_set').html('');

            $(".cour").each(function() {
                $(this).removeClass('on');
            })

            $(this).addClass('on');

            $.post("__URL__/listTeachers", 's_id=' + $(this).attr('s_id') + '&a_id=' + $(this).attr('a_id') + '&cst_course=' + $(this).attr('cst_course'), function(json) {

                var str = '<ul>';

                if (json) {
                    for (var i = 0; i < json.length; i ++) {

                        str += '<li class="cour" attr="' + json[i]['a_id'] + '">' + json[i]['a_nickname'] + '</li>';

                    }
                    str += '</ul>';

                    $('.tea_set').append(str);

                } else {

                    alert('请添加教授此课程的教师');
                    $('.tea_set').dialog('close');
                }

            }, 'json');
        }
    })

    // 根据学制选择年级
    $("select[name=c_type]").click('change', function() {
        listGradeOption($('input[name=s_id]').val(), $(this).val(), 'c_grade');
    })

    // 根据年级选择班级
    $("select[name=c_grade]").click('change', function() {
        listClass($('input[name=s_id]').val(), $('select[name=c_type]').val(), $('select[name=c_grade]').val(), 'c_class', 0);
    })

    //添加学生选中状态
    $(document).on('click','.add_right li',function(){
        onClass($(this));
    })
    //添加学生
    $('.stu_add').click(function(){
        $(".tea_add").dialog("open");
    })
    //添加学生弹框
    $(".tea_add").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '500',
        height: '350',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
          effect: "explode",
          duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {

                var obj = $(this);

                // 获取已经选中的所有学生，用于选中学生时做判断处理
                var selectedStudents = new Array();
                $(".tea_stu li").each(function(i) {
                    selectedStudents[i] = $(this).text();
                })

                // 初始化选中的ID
                var chooseId = '';
                // 初始化验证的变量
                var result = true;

                // 获取选中的学生ID,以,号连接
                $(".add_right ul li.on").each(function() {

                    // 默认变量为真
                    result = true;

                    // 遍历已经存在于班级的学生
                    for ( p in selectedStudents ) {

                        // 若选中的学生已经存在于班级
                        if ( selectedStudents[p] == $(this).text() ) {

                            // 变量为假
                            result = false;
                            $(".add_right ul li.on").removeClass('on');
                            // 跳出循环
                            break;
                        }
                    }

                    // 只处理变量为真，即未存在于班级的学生
                    if (result) {
                        // 组织字符串
                        chooseId += ',' + $(this).attr('attr');
                    }
                })

                // 如果有选中的学生
                if (chooseId) {

                    $.post("__URL__/setAllStudents", 's_id='+$('input[name=s_id]').val()+'&a_id=' + chooseId + '&c_id=' + $("input[name=c_id]").val(), function(json) {

                        if (json['status'] == 1) {
                            var insertStudent = $(".tea_stu").html();
                            $(".add_right ul li.on").each(function() {
                                insertStudent += '<li attr="' + $(this).attr('attr') + '">' + $(this).text() + '</li>';
                            })

                            $(".tea_stu").html(insertStudent);

                            // 关闭窗口
                            obj.dialog('close');
                        } else {

                            alert('操作失败');
                        }
                    }, 'json');
                } else {
                    $(this).dialog('close');
                }

            },
            取消: function() {
                $(this).dialog('close');
            }
        }
    })

    //根据条件筛选学生
    $('.save').click(function(){

        // 判断
        if ($("select[name=c_type]").val() == 0) {
            alert("请选择学制");
            return false;
        }
        if($("select[name=c_grade]").val()==0){
            alert("请选择年级");
            return false;
        }

        // 点击一次后不许再点
        $(this).attr('disabled', true);

        var postStr = 'c_type=' + $('select[name=c_type]').val() + '&c_grade=' + $('select[name=c_grade]').val();

        if ($("select[name=c_class]").val()) {
            postStr += '&c_id=' + $("select[name=c_class]").val();
        }

        if ($('input[name=a_nickname]').val()) {
            postStr += '&a_nickname=' + $('input[name=a_nickname]').val();
        }

        postStr += '&s_id='+$('input[name=s_id]').val();

        //提交
        $.post("__URL__/listStudents", postStr, function(json) {

            var str = '';

            if (json) {

                str += '<ul>';
                for (var i = 0; i < json.length; i ++) {

                    str += '<li attr="' + json[i]['a_id'] + '">' + json[i]['a_nickname'] + '</li>';
                }
                str += '</ul>';
            } else {
                str += '<ul><li>没有符合条件的学生</li></ul>';
            }

            $('.add_right').html(str);
            $(".save").attr('disabled', false);
        }, 'json');

    });

    //删除学生
    $('.stu_del').click(function(){

        // 初始化选中的ID
        var chooseId = '';

        //获取选中学生ID,以,连接
        $(".tea_stu li.on").each(function() {

            chooseId += ',' + $(this).attr('attr');

        })



        chooseId = chooseId.slice(1);


        // 如果有选中的学生
        if (chooseId) {

            $.post("__URL__/DeleteStudents", 'a_id=' + chooseId + '&c_id=' + $("input[name=c_id]").val(), function(json) {

                if (json['status'] == 1) {
                    //删除节点
                    $('.tea_stu li').each(function(){
                        if ($(this).hasClass('on')) {
                            $(this).remove();
                        }
                    })
                }
            }, 'json');
        }

    })

})

function onClass(now) {
    if (now.hasClass('on')) {
        now.removeClass('on');
    } else {
        now.addClass('on');
    }
}
</script>

<span class="class_name">{$classData.c_title}师生</span>
<a href="__URL__" class="stydy_return fr">返回列表</a>
<div class="clear"></div>
<h2 class="res">课程教师</h2>
    <input type="hidden" name="c_id" value="{$classData.c_id}">
    <input type="hidden" name="s_id" value="{$classData.s_id}">
<ul class="tea_main">

    <volist name="course" id="row">
        <li>
            <span>{$row.co_title}</span>
            <span>{$row.a_nickname}</span>
            <span class="cour" s_id="{$row.s_id}" a_id="{$row.a_id}" cst_course="{$row.cst_course}" cst_id="{$row.cst_id}">设置</span>
        </li>
    </volist>

</ul>
<h2 class="res">学生列表</h2>
<span class="couree stu_add">添加</span>
<span class="couree stu_del">删除</span>
<div class="clear"></div>
<ul class="tea_stu fl">
    <volist name="student" id="stu">
        <li attr="{$stu.a_id}">{$stu.a_nickname}</li>
    </volist>
</ul>
<!-- 设置 -->
<div class="tea_set" title="设置课程">
    <ul>

    </ul>
</div>
<div class="tea_add" title="设置学生">
    <div class="add_left">
        <ul>
            <li>
                <label><i></i>学制：</label>
                <select name="c_type">

                    <option value="0">请选择</option>
                    <volist name="c_type" id="type">
                        <option value="{$key}">{$type}</option>
                    </volist>

                </select>
            </li>
            <li>
                <label><i></i>年级：</label>
                <select name="c_grade">
                    <option value="0">请选择</option>

                </select>
            </li>
            <li>
                <label><i></i>班级：</label>
                <select name="c_class">
                    <option value="0">请选择</option>

                </select>
            </li>
            <li>
                <label><i></i>名称：</label>
                <input class="fl" type="text" name="a_nickname" value=""/>
            </li>
            <li>
                <button class="save finn" value=""  type="button">提交</button>
            </li>
        </ul>
    </div>
    <div class="add_right">

    </div>
</div>