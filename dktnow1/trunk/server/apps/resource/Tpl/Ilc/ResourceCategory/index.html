<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<load href="__PUBLIC__/Css/Ilc/lead.css"/>
<script>
// 最大栏目数
var maxCategory = {$maxLevel};

// 存储栏目的id和父id
var cateObj = {};
// 表格排列
var dateWidth = {'data_check':'2%','data_id':'8%','data_name':'27%','data_upload':'16%', 'data_tran':'16%','data_hand':'16%'};

$(function(){

    setWidth(dateWidth);

    // 点编辑的时候值为1，点击确定或取消时为0
    var editStatus = 0;

    //禁用，发布等 按钮的 滑入滑利效果
    $('.handle_operate li').hover(function(){
        var oldName = $(this).attr('class');
        $(this).removeClass(oldName).addClass(oldName+'_on');
    },function(){
        var oldName = $(this).attr('class');
        var oLen = oldName.length - 3;
        var newName = oldName.substring(0,oLen);
        //.str.slice(0,-3);
        $(this).removeClass(oldName).addClass(newName);
    })

    // 新增按钮点击
    $('.tools .add').click(function(){

        // 去掉栏目名称中的提示语
        $('.cor_red').hide();
        // 是否显示中，默认选中是
        $('.mod_type').find('span').eq(0).addClass('on');

        $(".model_incre").dialog("open");
    })

    // 新增弹框
    $(".model_incre").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '518',
        height: 'auto',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
            effect: "explode",
            duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {

                var t_mod,t_img,t_name;
                var t_true = true;
                var v_name = $('.model_incre .model_name').val();
                var v_size = $('.data_main li').size() + 1;
                var rc_pid = '';

                // 获取栏目的层级和父id
                rc_pid = $('.returnBack').attr('nowId');

                // 栏目名称
                var t_val = v_name.replace(/[ ]/g,'');

                if (t_val == 0) {
                    $('.model_incre .model_name').next().text('请输入栏目名称').addClass('cor_red');
                    $('.model_incre .model_name').next().show();
                    t_true = false;
                    return;
                } else if (t_val.length > 6) {

                    $('.model_incre .model_name').next().text('名称应小于6个字符').addClass('cor_red');
                    $('.model_incre .model_name').next().show();
                    t_true = false;
                    return;
                } else {
                    t_true = true;
                }

                // 判断类型选择
                $('.model_incre .mod_type input').each(function(){
                    if ($(this).is(':checked')) {
                        $(this).parent().addClass('new_tye');
                    } else {
                        $(this).parent().removeClass('new_tye');
                    }
                })

                var t_tye = $('.model_incre .mod_type .on').size();
                if (t_tye == 0) {
                    showMessage('请选择是否显示');
                    t_true = false;
                } else {
                    t_true = true;
                }

                var isShow = $('.model_incre .mod_type .on').attr('attr');

                if (t_true == true) {

                    var idLength = editStatus == 0 ? ($('.data_main').children().length+1) : $('.data_main li.on .data_id').text();

                    var html1 = '',_this = $(this);

                    // 添加栏目
                    if (editStatus == 0) {

                        // 异步写入数据后添加DOM节点
                        $.post('__URL__/insert', {rc_title:t_val, rc_pid:rc_pid, rc_is_show:$('.model_incre .mod_type .on').attr('attr')}, function (json) {
                            if (json.status == 1) {
                                html1 += '<li attr="' + json.info.id + '" class="plist">'
                                      +  '<input type="checkbox" name="key" value="' + json.info.id + '" class="data_check"/>'
                                      +  '<span class="data_id">' + idLength + '</span>'
                                      +  '<span class="data_name" title="' + t_val + '">' + t_val + '</span>'
                                      +  '<span class="data_tran">' + trans(isShow) + '</span>'
                                      +  '<span class="data_upload" is_show="' + $('.model_incre .mod_type .on').attr('attr') + '">编辑</span>'
                                if (json.info.level < maxCategory) {
                                    html1 += '<span class="sub_category" attr="' + $('.returnBack').attr('level') + '">子栏目</span>'
                                }
                                html1 += '</li>'
                                cateObj[json.info] = rc_pid;
                                $('.data_main').append(html1);
                                setWidth(dateWidth);
                            } else {
                                showMessage(json.info);
                            }

                            _this.dialog('close');

                            // 清空数据
                            $('.model_incre .model_name').val('');
                            $('.model_incre .mod_type span').removeClass('on');
                        }, 'json');

                    // 修改栏目
                    } else if (editStatus == 1) {

                        // 异步写入数据后添加DOM节点
                        $.post('__URL__/update', {rc_title:t_val, rc_pid:rc_pid, rc_is_show:$('.model_incre .mod_type .on').attr('attr'), rc_id:$('.data_main li.on').attr('attr')}, function (json) {
                            if (json.status == 1) {
                                html1 = '';
                                html1 += '<input type="checkbox" name="key" value="' + $('.data_main li.on').attr('attr') + '" class="data_check"/>'
                                      +  '<span class="data_id">' + idLength + '</span>'
                                      +  '<span class="data_name" title="' + t_val + '">' + t_val + '</span>'
                                      +  '<span class="data_tran">' + trans(isShow) + '</span>'
                                      +  '<span class="data_upload" is_show="' + $('.model_incre .mod_type .on').attr('attr') + '">编辑</span>'
                                if ($('.data_main .on span').hasClass('sub_category')) {
                                    html1 += '<span class="sub_category" attr="' + $('.returnBack').attr('level') + '">子栏目</span>'
                                }
                                $('.data_main .on').html(html1);
                                setWidth(dateWidth);
                            } else {
                                showMessage(json.info);
                            }

                            // 把编辑状态置为0
                            editStatus = 0;
                            _this.dialog('close');

                            // 清空数据
                            $('.model_incre .model_name').val('');
                            $('.model_incre .mod_type span').removeClass('on');
                        }, 'json');
                    }
                }
            },
            取消: function() {

                // 清空数据
                $('.model_incre .model_name').val('');
                $('.model_incre .mod_type span').removeClass('on');

                // 把编辑状态置为0
                editStatus = 0;
                $(this).dialog('close');
            }
        }
    })

    // checkbox 全选按钮
    $(document).on('click','input[name=allcheck]',function(){
        if($(this).is(':checked')){
            $('.data_main .data_check').prop('checked',true)
        } else {
            $('.data_main .data_check').prop('checked',false)
        }
    })

    // 操作 编辑 点击
    $(document).on('click','.data_upload',function(){

        // 去掉栏目名称中的提示语
        $('.cor_red').hide();

        var _this = $(this);

        editStatus = 1;
        $(this).parent().addClass('on').siblings().removeClass('on');
        $('.model_incre .model_name').val($(this).siblings('.data_name').text());
        $('.mod_type span').each(function () {
            if ($(this).attr('attr') == _this.attr('is_show')) {
                $(this).addClass('on').siblings().removeClass('on');
            }
        })
        $(".model_incre").dialog("open");
    })

    // 新增弹窗 名称 判断  blur
    $('.model_incre .model_name').blur(function(){
        var t_val = $(this).val().replace(/[ ]/g,'')
        if (t_val.length > 6) {
            $(this).next().text('名称应小于6个字符').addClass('cor_red');
        } else {
            $(this).next().text('');
        }
    })

    // 新增弹窗 名称 判断  focus
    $('.model_incre .model_name').focus(function(){
        if ($('.model_name').val() == '') {
            $(this).next().text('请输入名称').removeClass('cor_red');
        }
    })

    // 编辑弹窗 名称 判断  blur
    $('.model_newly .model_name').blur(function(){
        var t_val = $(this).val().replace(/[ ]/g,'')
        if (t_val.length > 6) {
            $(this).next().text('名称应小于6个字符').addClass('cor_red');
        } else {
            $(this).next().text('');
        }
    })

    // 编辑弹窗 名称 判断  focus
    $('.model_newly .model_name').focus(function(){
        $(this).next().text('请输入名称').removeClass('cor_red');
    })

    // 弹窗 属性值 选中和未选中
    $(document).on('change','.model_cor div input',function(){
        if ($(this).is(':checked')) {
            $(this).next().addClass('cor_pitch');
        } else {
            $(this).next().removeClass('cor_pitch');
        }
    })

    $('.colu_arrow').addClass($('.colu_carte li.car_click').attr('attr'));

    // 弹窗 模型 点击
    $(document).on('click','.mod_type span',function(){
        if ($(this).hasClass('on')) {
            $(this).removeClass('on');
        } else {
            $(this).addClass('on').siblings().removeClass('on');
        }
    })

    // 点击返回按钮
    $(document).on('click', '.returnBack', function () {

        getList(0, $(this).attr('attr'));

    })

    // 点击子栏目按钮
    $(document).on('click', '.sub_category', function () {

        getList(0, $(this).parent().attr('attr'));
    })

    // 自动加载显示栏目
    getList(0, 0);
})

// 显示和隐藏
function trans(id) {
    return id == 1 ? '是' : '否';
}

// 显示栏目
function getList(p, pid) {

    var htm = '', page = '', p = p ? p : 1;
    var cateList = '无';

    pid = pid ? pid : $('.returnBack').attr('nowid');

    // 清除掉勾选的状态
    $('.data_check').prop('checked',false);

    // 设置返回按钮的attr为栏目ID，level为栏目级别
    $('.returnBack').attr('attr', '0');
    $('.returnBack').attr('nowId', '0');
    $('.returnBack').hide();

    $.post('__URL__/ajaxShow', 'rc_pid=' + pid + '&p=' + p, function (json) {
        if (json.status == 1) {
            if (json.list) {
                var obj = json.list;
                for (var i=0, len = obj.length; i<len; i++) {
                    cateObj[obj[i]['rc_id']] = obj[i]['rc_pid'];
                    htm += '<li attr="' + obj[i]['rc_id'] + '" class="plist">'
                        +  '<input type="checkbox" name="key" value="' + obj[i]['rc_id'] + '" class="data_check" />'
                        +  '<span class="data_id">' + (i+1) + '</span>'
                        +  '<span class="data_name" title=' + obj[i]['rc_title'] + '>' + obj[i]['rc_title'] + '</span>'
                        +  '<span class="data_tran">' + trans(obj[i]['rc_is_show']) + '</span>'
                        +  '<span class="data_upload" is_show="' + obj[i]['rc_is_show'] + '">编辑</span>';

                    if (obj[i]['rc_level'] < maxCategory) {
                        htm += '<span class="sub_category" attr="' + obj[i]['rc_level'] + '">子栏目</span>'
                    }
                    htm +=  '</li>';
                }
                page = json.page;
            }
            cateList = json.cateList;

            $('.crumb').html(cateList);
            $('.data_main').html(htm);
            $('.page').html(page);
            setWidth(dateWidth);
        } else {
            showMessage(json.message);
        }
        $('.returnBack').attr('attr', json.pid);
        $('.returnBack').attr('nowId', pid);
        if (pid > 0) {
            $('.returnBack').show();
        }
    }, 'json')
}
</script>
<div class='warp'>
<include file="Public:left"/>
<div class="colu_right">
    <ul class="colu_carte">
        <volist name="secondList" id="selist">
            <li attr="{$selist['sn_name']}" <eq name="selist.sn_name" value="ResourceCategory">class="car_click"</eq>><a href="__APPURL__{$selist['sn_url']}">{$selist['sn_title']}</a></li>
        </volist>
    </ul>
    <div class="colu_arrow">
        <image src="__APPURL__/Public/Images/Ilc/resource_arrow.png"/>
    </div>
    <div class="colu_main lead_center">
        <div class="model_search">
            <input type="text" name="" value=""/>
            <a class="search">搜索</a>
        </div>
        <div class="tools fl">
            <span class="add" attr="1"><i></i>新增</span>
            <span class="del"><i></i>删除</span>
            <span class="returnBack"><i></i>返回</span>
            <!--span class="forbidden"><i></i>禁用</span>
            <span class="resume"><i></i>启用</span-->
        </div>
        <ul class="handle_data data_hea">
            <li>
                <input type="checkbox" name="allcheck" class="data_check"/>
                <span class="data_id">编号</span>
                <span class="data_name">名称</span>
                <span class="data_tran">是否显示</span>
                <span class="data_hand">操作</span>
            </li>
        </ul>
        <ul class="handle_data data_main"></ul>
    </div>
    <div class="page"></div>
</div>
<!--弹窗-->
<div class="model_cor model_incre" title="栏目管理">
    <ul>
        <li>
            <label>栏目名称：</label>
            <input type="text" name="" value="" class="model_name"/>
            <p></p>
        </li>
        <li>
            <label>上级栏目：</label>
            <p class="crumb"></p>
        </li>
        <li class="mod_type mod_tyy">
            <label>是否显示：</label>
            <span attr="1">是</span>
            <span attr="0">否</span>
        </li>
    </ul>
</div>
</div>
<include file="Public:footer"/>