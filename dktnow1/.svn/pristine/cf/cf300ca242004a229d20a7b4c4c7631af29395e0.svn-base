<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/res_publish.css"/>
<script>
$(function(){

    // 默认属性选中
    $('.pub_res span').each(function(){

        if ($(this).hasClass('on')) {
            $(this).parent().find('input:first').val($(this).text());
            $(this).parent().find('input:last').val($(this).attr('attr'));
        }
    });

    //发布到我的资源库 点击
    $('.goOn').click(function(){
        $('.pub_main').slideToggle('slow');
    })

    //名称 点击
    $(document).on('click','.pub_on .i_look',function(){
        $(this).parent().next('.pub_cor').slideDown().end().parents('.pub_ch').siblings().children('.pub_cor').slideUp();
    })

    //属性点击
    $(document).on('click','.pub_res span',function(){
        if ($(this).hasClass('on')){
            $(this).removeClass('on');
            $(this).prev().val('');
            $(this).next().val('');
        } else {
            $(this).addClass('on');
            $(this).siblings('span').removeClass('on');
            $(this).parent().find('input:first').val($(this).text());
            $(this).parent().find('input:last').val($(this).attr('attr'));
        }
    })

    // 栏目选择
    $(document).on('click', '.pub_cor .choose', function() {
        $(this).parents('.pub_ch').addClass('on').siblings().removeClass('on');
        getChild(0, 1);
    })

    // 获取子栏目
    $(document).on('click', '.list li', function() {

        var level = $(this).attr('level');
        $('.list li').each(function() {
            if ($(this).attr('level') > level) {
                $(this).remove();
            }
        })
        $(this).addClass('on').siblings().removeClass('on');
        getChild($(this).attr('attr'));
    })

    $('.pub_pub').click(function(){
        location.href="__URL__/";
    });

})

// 提交验证
function check() {

    var flag = false;
    $('.pub_res input').each(function() {

        if ($(this).attr('attr') == 1 && $(this).val() == '') {
            showMessage('您有未填写的属性值');
            flag = true;
        }

    });

    if (flag) {
        return false;
    }

    $('.points').each(function(){

        if (!/^\d+$/g.test($(this).val()) || $(this).val() > 50 || $(this).val() < 0) {
            showMessage('请正确的填写下载积分');
            flag = true;
        }
    });

    if (flag) {
        return false;
    }

    $('.rc_id').each(function(){

        if ($(this).val() == '') {
            showMessage('请选择资源所属栏目');
            flag = true;
        }
    });

    if (flag) {
        return false;
    }

    return true;

}

function getChild(id, type) {

    var str = '';
    if (type == 1) {
        if ($('.pub_ch.on .list li').size() == 0) {
            if ({$sch}) {
                str += '<li attr="0" level="0" type="{$sch}">本校栏目</li>';
            }
            if ({$sys}) {
                str += '<li attr="0" level="0" type="0">系统栏目</li>';
            }

            $('.pub_ch.on .list ul').html(str);
            $('.pub_ch.on .list').show();
            return;
        } else {
            $('.pub_ch.on .list').show();
        }
    } else {

        if ($('.pub_ch.on .list').css('display') == 'none') {
            $('.pub_ch.on .list').show();
        } else {
            $.post('__URL__/findSub', 'id='+id, function(json) {
                var str = '';

                if (json) {
                    $.each(json, function(i, data){

                        if (data['rc_pid'] == id && data['s_id'] == $('.pub_ch.on .list li.on').attr('type')) {
                            str += '<li attr="' + data['rc_id'] + '" level="' + data['rc_level'] + '" type="' + data['s_id'] + '">' + getLevel(data['rc_level']) + data['rc_title'] + '</li>';
                        }
                    })
                }

                if (!str) {
                    var t_val = $('.pub_ch.on .list li.on').html();
                    var reg=/&nbsp;/g;
                    var new_val = t_val.replace(reg,'');
                    $('.pub_ch.on .list li.on').parents('.list').prev().children('.choose').html(new_val);
                    $('.pub_ch.on .list li.on').parents('.list').prev().prev().val($('.pub_ch.on .list li.on').attr('attr'));
                    $('.pub_ch.on .list.on').removeClass('on');$('.pub_ch.on').removeClass('on');
                    $('.list').hide();
                } else {
                    $(str).insertAfter($('.pub_ch.on .list li.on'));
                    $('.pub_ch.on .list').show();
                }

            }, 'json')
        }
    }
}

function getLevel(level) {

    var result = '';
    for (var i = 0; i < level; i ++) {

        result += '&nbsp;&nbsp;&nbsp;&nbsp;';
    }

    return result;
}
</script>
<div class="warp">
    <include file="Public:leftSider"/>

    <div class="pub_right">
        <eq name="dis" value="0">
        <h3>待发布的资源</h3>
        <button style="margin-left:20px;" class="pub_pub">继续上传</button>
        <button class="goOn">发布到资源库</button>
        <div class="clear"></div>
        <div class="pub_main" style="display:none;">
        <else/>
        <div class="pub_main">
        </eq>
            <form action="__URL__/publish" name="form" onSubmit="return check();" method="post">

                <volist name="authResource" id="resource" key="k">
                    <div class="pub_ch">


                        <input name="ar_id[]" value="{$resource.ar_id}" type="hidden" />

                        <div class="pub_name pub_on">
                            <input type="hidden" value="{$resource.ar_title}" class="re_title"/>
                            <label>文件名称：</label>
                            <p class="pub_p">{$resource.ar_title}</p>
                        </div>
                        <div class="pub_cor">
                            <input name="rc_id[]" class="rc_id" value="" type="hidden" />
                            <div class="pub_name">
                                <label>栏目：</label>
                                <span class="choose">选择</span>
                            </div>
                            <div class="list">
                                <ul>

                                </ul>
                            </div>

                            <div class="two_level" style="display:block">

                            </div>
                            <div class="pub_name">
                                <label>类型：</label>
                                <i class="pub_model" attr="{$resource.m_id}">{$resource.m_title}</i>
                            </div>
                            <volist name="attribute" id="atr" key="key1">

                                <in name="atr.at_id" value="$resource.m_list">
                                    <div class="pub_name pub_res">
                                    <label>{$atr.at_title}<eq name="atr.at_is_required" value="1"><cite style="color:red">*</cite></eq>：</label>
                                        <eq name="atr.at_type" value="1">
                                            <input type='text' name="text[{$k}][{$key1}][are_value]" value='{$atr.at_value}' attr='{$atr.at_is_required}'/>
                                            <input type='hidden' name="text[{$k}][{$key1}][are_name]" value='{$atr.at_name}'/>
                                        </eq>
                                        <eq name="atr.at_type" value="2">

                                            <input type='hidden' name="text[{$k}][{$key1}][are_value]" value=''/>
                                            <volist name="atr.at_extra" id="extra">
                                                <span attr="{$atr.at_name}" <eq name="extra" value="$atr.at_value">class="on"</eq>>{$extra}</span>
                                            </volist>
                                            <input type='hidden' name="text[{$k}][{$key1}][are_name]" value=''/>

                                        </eq>
                                    </div>
                                </in>

                            </volist>

                            <div class="pub_name pub_res">
                                <label>下载积分：</label>
                                <input type="text" name="re_points[]" value="0" class="points" />
                            </div>

                        </div>
                    </div>
                </volist>
                <button class="pub_hold pub_ser">发布</button>
            </form>
        </div>

    </div>

</div>
<include file="Public:footer"/>