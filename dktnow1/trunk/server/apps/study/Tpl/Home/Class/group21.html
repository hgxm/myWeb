<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public//Js/Home/jquery-ui.js"/>
<load href="__PUBLIC__/Css/Home/group_class.css"/>
<div class="warp">
    <include file="Public:leftSider"/>
    <ul class="top_tab_menu fl">
        <li class="tab_return" onclick="javascript:location.href='/Class'">返回</li>
        <li class="tab_name">{$class.s_id|replaceClassTitle=$class['c_type'],$class['c_grade'],$class['c_title'],$class['is_graduation']}</li>
        <li onclick="javascript:location.href='__URL__/student/id/{$class.c_id}'">同学们</li>
        <li class="selected">小组</li>
        <eq name="isBeanOpen" value="1">
            <li onclick="javascript:location.href='__URL__/honor/id/{$class.c_id}'">光荣榜</li>
         </eq>
        <li onclick="javascript:location.href='__URL__/syllabus/id/{$class.c_id}'">课程表</li>
    </ul>
    <div class="group_right fr">
        <div class="gr_left fr">

            <div class="left_main">
                <a class="left_add">＋添加小组</a>
                <div class="clear"></div>
                <a class="left_make"></a>
            </div>
            <div class="left_over">
                <p>添加成功</p>
                <a class="over_go"></a>
            </div>
        </div>
        <div class="gr_right fl">
            <div class="rig_main">
                <p>已创建的小组</p>
                <ul>
                    <li class="rige_name">小组名称</span>
                    <li class="rige_edit">编辑</span>
                    <li class="rige_remove">删除</span>
                    <li class="rige_found">创建人</span>
                    <li class="rige_poh">成员</span>
                </ul>
            </div>
        </div>
    </div>
</div>
<div class="rig_cure" title="成员">
    <label>小组成员：</label>
    <div class="ruge_on">

    </div>
    <div class="clear"></div>
    <div class="all">
    <label>班级成员：</label>
        <div class="ruge_none">
            <volist name="students" id="student">
                <span attr="{$student.a_id}">{$student.a_nickname}</span>
            </volist>
        </div>
    </div>
</div>
<script>
$(function(){

    $('.left_over').hide();

    $('.tab_return').click(function() {
        location.href = "__URL__";
    })

    var str = '';
    for(i = 0; i < 40; i++){
        str += "<a class=sol_"+i+"></a>";
    }

    // 点击选择图标显示
    $(document).on('click','.map_sor',function(){
        if($(this).hasClass('left_click')){
            $(this).removeClass('left_click');
            $(this).children('div').hide();
        }else{
            $(this).addClass('left_click');
            $(this).children('div').show();
        }
    })

    // 滑离选择图标隐藏
    $(document).on('mouseout','.map_sor',function(){
        $(this).removeClass('left_click');
        $(this).children('div').hide();
    })

    $(document).on('mouseover','.map_sor div',function(){
        $(this).parent().addClass('left_click');
        $(this).show();
    })

    // 选择图标
    $(document).on('mouseover','.sorll a',function(){
        $(this).addClass('sor_hover').siblings().removeClass('sor_hover');
    })

    $(document).on('click','.sorll a',function(){
        var t_class = $(this).attr('class');
        var t_name = $(this).parents('div').siblings('.left_null').children('a');
        t_name.attr('class' , '').attr('style' , '').addClass('left_map').addClass(t_class);
    })

    //＋添加小组
    $(document).on('click','.left_add',function(){

        var tLength = $('.gr_right>div').eq(0).children('div').size();
        var tNav = $(this).parent().children('.main_gor').size();
        var tNum = tLength + tNav;

        if(tNum < 15){
            $(this).before("<div class='main_gor'><div class='left_null fl'><a class='left_map'></a></div><div class='fl'><span class='map_sor'><div class='sorll'>"+str+"</div></span><input type='text' name='' value='' class='class_input'/><a class='input_select'></a></div></div>");
            $('.left_main .main_gor').last().children().children('input').focus();
        }else{
            showMessage('最多能添加15个小组');
        }

    })

    //删除未添加的小组
    $(document).on('click','.input_select',function(){
        if (confirm('确定要删除该小组吗？'))
        {
            $(this).parents('.main_gor').remove();
        } else {
            return false;
        }
    })

    //删除已添加的小组
    $(document).on('click','.edit_select',function(){

        if(confirm("确定要删除该小组吗？")){

            $(this).parents('.right_gor').remove();

            // 删除小组
            $.post('__APPURL__/ClassGroup/del', 'cg_id='+$(this).parents('.right_gor').attr('attr'), function(json){
                if (!json) {
                    showMessage('删除失败');
                }
            }, 'json');

            if (parseInt($('.right_gor').size()) == 0) {
                $('.rig_main').find('p').eq(0).html('暂无小组');
                $('.rig_main ul').hide();
            }

        } else {
            return false;
        }
    })

    // 编辑小组
    $(document).on('click','.edit_add',function(){
        $(this).parent().hide().siblings('div').show();
        $(this).parent().hide().siblings('.gor_hide').find('.class_input').val($(this).prev().text());
    })

    // 编辑删除按钮
    $(document).on('click','.rig_select',function(){
        $(this).parent().hide().siblings('div').show();
    })

    // 编辑发布按钮
    $(document).on('click','.rig_add',function(){

        var tVal = $(this).siblings('input').val();
        String.prototype.trim = function () {
            return this.replace(/[ ]/g, '');
        }
        var tRim = tVal.trim();
        if (tRim == ""){
            showMessage('请输入小组名称');
            return false;
        }

        if (tRim.length > 6) {
            showMessage('小组名称最多6个字符');
            return false;
        }

        var obj = $(this).parent();

        var cg_id = $(this).parents('.right_gor').attr('attr');
        var cg_logo = '';
        var cg_title = tRim;
        if (obj.find('.map_sor').find('.sor_hover').attr('class') != undefined) {
            cg_logo = obj.find('.map_sor').find('.sor_hover').attr('class').replace(/[^0-9]+/ig, "");
        }

        $.post('__APPURL__/ClassGroup/update', 'cg_logo='+cg_logo+'&cg_id='+cg_id+'&cg_title='+cg_title, function(json){

            if (!json) {
                showMessage('编辑失败');
            } else {
                obj.next().find('i').text(tRim);
                obj.hide().siblings('div').show();
            }
        }, 'json');
    })

    // 发布点击
    $(document).on('click','.left_make',function(){

        if ($('.main_gor').size() < 1) {
            return false;
        }

        var sTrue = true;
        var tLength = $('.gr_right>div').eq(0).children('div').size();
        var tNav = $(this).parent().children('.main_gor').size();
        var tNum = tLength + tNav;
        if(tNum > 15){
            showMessage('最多只能添加15个小组');
            sTrue = false;
        }

        var groupTitleStr = '';
        var logoStr = '';

        $('.left_main input').each(function(){
                var tNullee = $(this).parent().siblings('.left_null').html();
                var tVal = $(this).val();
                String.prototype.trim = function () {
                    return this.replace(/[ ]/g, '');
                }
                var tLen = tVal.trim();
                if(tLen == ""){
                    showMessage('不能为空');
                    sTrue = false;
                }else{
                    if(tLen.length > 6){
                        showMessage('名字超过6个字符，请重新输入');
                        sTrue = false;
                    }
                }

                groupTitleStr += ',' + $(this).val();

                var groupLogo = $(this).prev().find('.sorll a.sor_hover').attr('class');

                if (!groupLogo) {
                    groupLogo = 0;
                } else {
                    groupLogo = groupLogo.replace(/[^0-9]+/ig,"");
                }

                logoStr += ',' + groupLogo;


        })

        groupTitleStr = groupTitleStr.slice(1);
        logoStr = logoStr.slice(1);

        if(sTrue == true){

            // 添加班级小组
            $.post('__APPURL__/ClassGroup/insert', 'cg_logo='+logoStr+'&c_id='+{$class.c_id}+'&groupTitleStr='+groupTitleStr, function(json){

                var groups = styLeft = group = sty = styTop = '';
                if (json) {

                    for (var i = 0; i < json.length; i++) {

                        styLeft = (json[i]['cg_logo'] % 10) * 30 + 4;
                        styTop = (parseInt(json[i]['cg_logo'] / 10) * 32) + 2;
                        sty = 'style="background-position:-'+styLeft+'px -'+styTop+'px;"';

                        groups += "<div class='right_gor' attr='"+json[i]['cg_id']+"'><div class='left_null fl'><a class='left_map' "+sty+"></a></div><div class='gor_hide fl'><span class='map_sor'><div class='sorll'>"+str+"</div></span><input type='text' name='' value='' class='class_input'/><a class='rig_select'></a><a class='rig_add'></a></div><div class='rig_edit'><i>"+json[i]['cg_title']+"</i><a class='edit_add'></a><a class='edit_select'></a><a class='edit_found'>"+json[i]['a_nickname']+"</a><label class='edit_leaguer'></label></div></div>";
                        $('.left_main').hide().siblings('.left_over').show();

                    }

                } else {
                    showMessage('对不起, 您已经添加过, 请更改小组名称');
                }

                $('.rig_main').find('p').eq(0).html('已创建的小组');
                $('.rig_main ul').show();
                $('.gr_right .rig_main').append(groups);

            }, 'json');

       }

    })

    // 继续发布
    $('.over_go').click(function(){
        $('.left_main').show().siblings('.left_over').hide();
        $('.left_main').html("<a class='left_add'>＋添加小组</a><div class='clear'></div><a class='left_make'></a>");
    })

    // 获取班级小组列表
    $.post('__APPURL__/ClassGroup/lists', 'c_id='+{$class.c_id}, function(json){

        var styLeft = group = sty = styTop = '';
        if (json) {
            for (var i = 0; i < json.length; i++) {

                styLeft = (json[i]['cg_logo'] % 10) * 30 + 4;
                styTop = (parseInt(json[i]['cg_logo'] / 10) * 32) + 2;
                sty = 'style="background-position:-'+styLeft+'px -'+styTop+'px;"';

                group += "<div class='right_gor' attr="+json[i]['cg_id']+"><div class='left_null fl'><a class='left_map' "+sty+"></a></div><div class='gor_hide fl'><span class='map_sor'><div class='sorll'>"+str+"</div></span><input type='text' name='' value='' class='class_input'/><a class='rig_select'></a><a class='rig_add'></a></div><div class='rig_edit'><i title="+json[i]['cg_title']+">"+json[i]['cg_title']+"</i><a class='edit_add'></a><a class='edit_select'></a><a class='edit_found' title="+json[i]['a_nickname']+">"+json[i]['a_nickname']+"</a><label class='edit_leaguer'></label></div></div>";
            }
        }

        $('.gr_right .rig_main').append(group);

        // 如果没有以创建的小组，隐藏菜单
        if ($('.right_gor').size() < 1) {
            $('.rig_main').find('p').eq(0).html('暂无小组');
            $('.rig_main ul').hide();
        }

    }, 'json');


    // 查看成员
    $(document).on('click','.edit_leaguer',function(){

        $('.rig_cure label:first').html($(this).parent().find('i').text()+'成员:');
        var cg_id = $(this).parent().parent().attr('attr');
        $('.ruge_none span').removeClass('on');
        $(this).parent().parent().addClass('on').siblings().removeClass('on');
        $('.ruge_on').html('');
        $.post('__APPURL__/ClassGroupStudent/lists', 'cg_id='+cg_id, function(json){

            if (json) {
                var groupStudentList = '';

                for (var i = 0; i < json.length; i++) {
                    $('.ruge_none span').each(function() {
                        if ($(this).attr('attr') == json[i]) {
                            $(this).click();
                        }
                    })
                }
            }
            $(".rig_cure").dialog("open");
        }, 'json');
    })

    // 查看成员弹窗
    $(".rig_cure").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '480',
        height: 'auto',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
          effect: "explode",
          duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {

                var str = '';
                $('.ruge_on span').each(function() {
                    str += ',' + $(this).attr('attr');
                })

                str = str.slice(1);

                var obj = $(this);

                $.post('__APPURL__/ClassGroupStudent/insert', 'c_id='+{$class.c_id}+'&cg_id='+$('.right_gor.on').attr('attr')+'&a_id='+str, function(json) {
                    if (json.status == 1) {
                        obj.dialog('close');
                    } else {
                        showMessage(json.info);
                    }
                }, 'json')
            },
            取消: function() {
                $(this).dialog('close');
            }
        }
    })

    // 添加成员
    $(document).on('click','.ruge_none span',function(){

        var a_id = $(this).attr('attr');

        if ($(this).hasClass('on')) {
            $(this).removeClass('on');
            $('.ruge_on span').each(function() {
                if ($(this).attr('attr') == a_id) {
                    $(this).remove();
                }
            })
        } else {
            $(this).addClass('on');
            $('.ruge_on').append("<span attr="+a_id+">"+$(this).text()+"<a href='javascript:void(0);' class='flex_close cDel'></a></span>")
        }
    })

    //成员删除按钮 显示
    $(document).on('mouseover','.ruge_on span',function(){
        $(this).children('a').show();
    })

    //成员删除按钮 隐藏
    $(document).on('mouseout','.ruge_on span',function(){
        $(this).children('a').hide();
    })

    //成员删除按钮 删除
    $(document).on('click','.ruge_on a',function(){
        if(confirm('确定要删除该成员吗')){

            var obj = $(this);
            var attr = obj.parent().attr('attr');
            $('.ruge_none span').each(function() {
                if ($(this).attr('attr') == attr) {
                    $(this).removeClass('on');
                }
            })
            obj.parent().remove();
        }
    })
})
</script>
<include file="Public:footer"/>