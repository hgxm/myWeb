<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<load href="__PUBLIC__/Css/Ilc/permission.css"/>
<script type="text/javascript">
// 表格排列
var listObj =  {"_checkbox": '8%',"_order": "15%" ,"_name": "20%","_status": "10%","_operate": "10%",'_edit':"8%",'_commision':"8%",'_statusText':'8%','_del':'8%'};
$(function(){
    // 添加窗口
    $("#createGroup").dialog({
        draggable: true,
        resizable: true,
        autoOpen: false,
        position :'center',
        bgiframe: true,
        width: '410',
        height: 'auto',

        show: {
            effect: "blind",
            duration: 400
        },
        hide: {
          effect: "explode",
          duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            确定: function() {

                // 组名不能为空
                var oVal = $('input[name=sr_name]').val();
                String.prototype.trim = function(){
                    return this.replace(/[ ]/g,'')
                }
                var newVal = oVal.trim();
                if(newVal == '') {
                    showMessage("请输入组名");
                    return false;
                }else{
                    if(newVal.length > 10){
                        showMessage("组名不可超过10个字符");
                        return false;
                    }
                }

                // 获取新增组信息
                var gid = $('input[name=sr_id]').val();

                var gname = $('input[name=sr_name]').val();
                var gstatus = $('#group_status option:selected').val();
                var gstatus_pic = '';
                var statusText = new Array('启用', '禁用');
                var sStatus = 0;
                if(gstatus == 1){
                    sStatus = 0;
                    gstatus_pic = 'qy_status.png';
                }else {
                    sStatus = 1;
                    gstatus_pic = 'jy_status.gif';
                }
                var obj = $(this);
                var postStr = 'sr_name='+gname+'&sr_status='+gstatus+'&sr_id='+gid;

                if (gid > 0) {

                    if ($('.plist.on .per_name').html() != gname || $('.plist.on .per_status').attr('attr') != gstatus) {
                        $.post('__URL__/update', postStr, function(data){
                            if (data) {
                                $('.plist.on ._name').html(gname);
                                $('.plist.on ._status').attr('attr', gstatus);
                                $('.plist.on ._status').html("<img src='__APPURL__/Public/Images/Ilc/"+gstatus_pic+"'>");
                                $('.plist.on ._statusText').html(statusText[1-sStatus]);

                                $('.plist.on').removeClass('on');
                                // 关闭窗口
                                obj.dialog('close');
                            } else {
                                showMessage('操作失败');
                            }
                        })
                    } else {
                        $('.plist.on').removeClass('on');
                        // 关闭窗口
                        obj.dialog('close');
                    }
                } else {
                    $.post('__URL__/insert', postStr, function(data) {
                        if (data) {
                            var newGroup = "<div class='perission_caption plist' attr="+data+"><ul><li class='_checkbox'><input type='checkbox' name='key' value='"+data+"'></li><li class='_order'>"+data+"</li><li class='_name'>"+gname+"</li><li class='_status' attr="+gstatus+"><img src='__APPURL__/Public/Images/Ilc/"+gstatus_pic+"'></li><li class='_edit'><span>编辑</span></li><li class='_commision'><span>授权</span></li><li class='_statusText'>"+statusText[1-sStatus]+"</li><li class='_userList'><span>用户列表</span></li><li class='_del' onclick='del("+data+")'><span>删除</span></li></ul></div>";

                            $('.perission_list').append(newGroup);
                            $('.plist.on').removeClass('on');
                            setWidth(listObj);
                            // 关闭窗口
                            obj.dialog('close');
                        } else {
                            showMessage('操作失败');
                        }
                    });
                }
            },
            取消: function() {
                $('.plist.on').removeClass('on');
                $(this).dialog('close');
            }
        }
    });

    // 编辑组
    $(document).on('click','._edit', function(){
        $('input[name=sr_name]').val($(this).prev().prev().html());
        $('#group_status').val($(this).prev().attr('attr'));
        $('input[name=sr_id]').val($(this).parents('.plist').attr('attr'));
        $(this).parents('.plist').addClass('on').siblings().removeClass('on');
        $("#createGroup").dialog("open");
    })

    // 创建组
    $('.tools .add').click(function(){
        $('input[name=sr_name]').val('');$('input[name=sr_id]').val(0);
        $("#createGroup").dialog("open");
    })

    // 授权
    $(document).on('click','._commision', function(){
        location.href = '__URL__/commision/id/'+$(this).parents('.plist').attr('attr');
    })

    // 用户列表
    $(document).on('click','._userList', function(){
        location.href = '__URL__/user/id/'+$(this).parents('.plist').attr('attr');
    })

    // 启用禁用
    $(document).on('click','._statusText', function(){
        var status = $(this).parents('.plist').find('._status').attr('attr');
        var id = $(this).parents('.plist').attr('attr');
        status = status == 1 ? 1 : 0;
        forbid(id, status);
    })

    setWidth(listObj);
})
</script>
<div class="warp">
    <include file="Public:left"/>
    <div class="perission fl">
        <!-- <a class="create_role fl">创建角色</a> -->
        <div class="tools xin_tools">
            <span class="add" attr="1"><i></i>新增</span>
            <span class="del"><i></i>删除</span>
            <span class="forbidden"><i></i>禁用</span>
            <span class="resume"><i></i>恢复</span>
        </div>
        <div class="perission_list fl" id="roleList">
            <div class="perission_caption">
                <ul>
                    <li class="_checkbox"><input type="checkbox" onclick="CheckAll('roleList')"/></li>
                    <li class="_order">编号</li>
                    <li class="_name">组名</li>
                    <li class="_status">状态</li>
                    <li class="_operate">操作</li>
                </ul>
            </div>
            <volist name="list" id="vo">
                <div class="perission_caption plist" attr="{$vo.sr_id}">
                    <ul>
                        <li class="_checkbox"><input name="key" type="checkbox" value="{$vo.sr_id}"/></li>
                        <li class="_order">{$vo.sr_id}</li>
                        <li class="_name">{$vo.sr_name}</li>
                        <li class="_status" attr="{$vo.sr_status}">
                            <eq name="vo.sr_status" value="1">
                                <img src="__APPURL__/Public/Images/Ilc/qy_status.png" />
                            <else/>
                                <img src="__APPURL__/Public/Images/Ilc/jy_status.gif" />
                            </eq>
                        </li>
                        <li class="_edit"><span>编辑</span></li>
                        <li class="_commision"><span>授权</span></li>
                        <li class="_statusText"><eq name="vo.sr_status" value="9">启用<else/>禁用</eq></li>
                        <li class="_userList"><span>用户列表</span></li>
                        <li class="_del" onclick="del({$vo.sr_id})"><span>删除</span></li>
                    </ul>
                </div>
            </volist>
        </div>
        <div class="page">{$page}</div>
    </div>
    <div class="clear"></div>
</div>
<div id="createGroup" title="创建组">
    <p>
        <label>组名：</label>
        <input type="text" name="sr_name"/>
    </p>
    <p>
        <label>组状态：</label>
        <select id="group_status" class="sr_status">
            <option value="1">启用</option>
            <option value="9">禁用</option>
        </select>
        <input type="hidden" name="sr_id"/>
    </p>
</div>
<include file="Public:footer"/>