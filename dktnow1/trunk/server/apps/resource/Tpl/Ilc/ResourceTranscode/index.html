<include file="Public:header"/>
<load href="__PUBLIC__/Css/Home/jquery-ui.css"/>
<load href="/Public/Js/Home/jquery-ui.js"/>
<load href="__PUBLIC__/Css/Ilc/lead.css"/>
<script>
$(function(){

    // 点编辑的时候值为1，点击确定或取消时为0
    var editStatus = 0;

    $('.colu_carte li').eq(7).addClass('car_click').siblings().removeClass('car_click');

    //表格排列
    var dateWidth = {'data_check':'2%','data_id':'8%','data_name':'20%','data_status':'10%', 'data_opera':'30%'};
    setWidth(dateWidth);

    //弹窗名称判断
    $('input[name=rt_title]').focus(function(){
        if ($(this).val().replace(/[ ]/g,'') == '') {
            $(this).next('p').text("请输入模版名称").removeClass('all_lea');
        }
    })
    $('input[name=rt_title]').blur(function(){
        var t_val = $(this).val().replace(/[ ]/g,'');
        if (t_val.length == 0) {
            $(this).next().text('');
        } else {
            if (t_val.length > 12) {
                $(this).next().text('模版名称不能超过6个字符').addClass('all_lea')
            } else {
                $(this).next().text('');
            }
        }
    })

    // 新增按钮点击
    $('.tools .addCode').click(function(){

        // 判断节点下是否有十个模版
        if ($('.data_main li').size() == 10) {
            showMessage('只允许添加十个模板');
            return;
        }

        $('.allocation').dialog("open");
    })

    // 修改按钮
    $(document).on('click', '.data_opera', function () {

        // 编辑状态置为1，同时在该节点和父节点上添加个标记
        editStatus = 1;
        $(this).parent().addClass('on').siblings().removeClass('on');
        //$(this).addClass('flag').siblings().removeClass('flag');

        // 把弹出框里的值设为该模板的值
        $('input[name=rt_title]').val($(this).attr('rt_title'));
        $('select[name=rt_type]').val($(this).attr('rt_type'));
        $('select[name=rt_video_code]').val($(this).attr('rt_video_code'));
        $('select[name=rt_video_rp]').val($(this).attr('rt_video_rp'));
        $('select[name=rt_video_bite]').val($(this).attr('rt_video_bite'));
        $('select[name=rt_video_bite]').val($(this).attr('rt_video_bite'));
        $('select[name=rt_video_frame]').val($(this).attr('rt_video_frame'));
        $('select[name=rt_voice_code]').val($(this).attr('rt_voice_code'));
        $('select[name=rt_voice_sample]').val($(this).attr('rt_voice_sample'));
        $('select[name=rt_voice_sound]').val($(this).attr('rt_voice_sound'));
        $('select[name=rt_voice_bite]').val($(this).attr('rt_voice_bite'));
        $('select[name=rt_cover_rp]').val($(this).attr('rt_cover_rp'));
        $('select[name=rt_cover_time]').val($(this).attr('rt_cover_time'));
        $('select[name=rt_status]').val($(this).attr('rt_status'));

        $('.allocation').dialog("open");
    })

    // 弹窗显示
    $(".allocation").dialog({
        draggable: true,        // 是否允许拖动,默认为 true
        resizable: true,        // 是否可以调整对话框的大小,默认为 true
        autoOpen: false,        // 初始化之后,是否立即显示对话框,默认为 true
        position :'center',       // 用来设置对话框的位置
        stack : true,       // 对话框是否叠在其他对话框之上。默认为 true
        modal: true,       // 是否模式对话框,默认为 false(模式窗口打开后，页面其他元素将不能点击，直到关闭模式窗口)
        bgiframe: true,         // 在IE6下,让后面遮罩层盖住select
        width: '680',
        height: 'auto',

        show: {     // 对话框打开效果
            effect: "blind",
            duration: 400
        },
        hide: {     // //对话框关闭效果
            effect: "explode",
            duration: 400
        },
        overlay: {
            backgroundColor: '#000',
            opacity: 0.5
        },
        buttons: {
            保存: function() {

                var _this = $(this);

                // 判断名称
                var oVal = $('input[name=rt_title]').val();
                var t_val = oVal.replace(/[ ]/g,'');
                if (t_val == '') {
                    $('input[name=rt_title]').next().text('模板名称不能为空').addClass('all_lea');
                    return;
                } else if (t_val.length > 6) {
                    $('input[name=rt_title]').next().text('名称超过了6个字符，请重新输入').addClass('all_lea');
                    return;
                }

                // 编号
                var idLength = editStatus == 0 ? ($('.data_main').children().length+1) : $('.data_main li.on .data_id').text();

                // 状态名称
                var statusName = $('select[name=rt_status]').val() == 0 ? '停用': '启用';

                // 判断是否有已经启用的
                var flag = 0;
                $('.data_main span.data_status').each(function(){

                    if ($(this).attr('attr') == 1) {
                        flag = 1;
                        id = $(this).parent().attr('attr');
                    }
                });

                // 添加
                if (editStatus == 0 ) {

                        if (flag ==1 && $('select[name=rt_status]').val() == 1) {

                            if (confirm('有且仅有一个模板可为启用状态，您是否确定启用')) {

                                $('.data_main span.data_status').each(function(){

                                    if ($(this).attr('attr') == 1) {
                                        $(this).attr('attr', 0);
                                        $(this).text('停用');
                                    }
                                });

                            } else {
                                return false;
                            }
                        }

                        $.post('__URL__/insert', {rt_title: t_val, rt_type: $('select[name=rt_type]').val(), rt_video_code: $('select[name=rt_video_code]').val(), rt_video_rp: $('select[name=rt_video_rp]').val(), rt_video_bite: $('select[name=rt_video_bite]').val(), rt_video_bite: $('select[name=rt_video_bite]').val(), rt_video_frame: $('select[name=rt_video_frame]').val(), rt_voice_code: $('select[name=rt_voice_code]').val(), rt_voice_sample: $('select[name=rt_voice_sample]').val(), rt_voice_sound: $('select[name=rt_voice_sound]').val(), rt_voice_bite: $('select[name=rt_voice_bite]').val(), rt_cover_rp: $('select[name=rt_cover_rp]').val(), rt_cover_time: $('select[name=rt_cover_time]').val(), rt_status: $('select[name=rt_status]').val(), flag: flag}, function (json) {
                        if (json.status == 1) {
                            var htm = '';
                                htm += '<li attr="' + json.info + '" class="plist">'
                                    +  '<input type="checkbox" name="key" value="' + json.info + '" class="data_check"/>'
                                    +  '<span class="data_id">' + idLength + '</span>'
                                    +  '<span class="data_name" title="' + t_val + '">' + t_val + '</span>'
                                    +  '<span class="data_status" attr="'+$('select[name=rt_status]').val()+'">' + statusName + '</span>'
                                    +  '<span class="data_opera" rt_title="' + t_val + '" rt_type="' + $('select[name=rt_type]').val() + '" rt_video_code="' + $('select[name=rt_video_code]').val() + '" rt_video_rp="' + $('select[name=rt_video_rp]').val() + '" rt_video_bite="' + $('select[name=rt_video_bite]').val() + '" rt_video_frame="' + $('select[name=rt_video_frame]').val() + '" rt_voice_code="' + $('select[name=rt_voice_code]').val() + '" rt_voice_sample="' + $('select[name=rt_voice_sample]').val() + '" rt_voice_sound="' + $('select[name=rt_voice_sound]').val() + '" rt_voice_bite="' + $('select[name=rt_voice_bite]').val() + '" rt_cover_rp="' + $('select[name=rt_cover_rp]').val() + '" rt_cover_time="' + $('select[name=rt_cover_time]').val() + '" rt_title="' + $('select[name=rt_title]').val() + '" rt_status="' + $('select[name=rt_status]').val() + '">编辑</span>'
                                    +  '</li>'
                            $('.data_main').append(htm);
                            setWidth(dateWidth);
                        } else {
                            showMessage(json.info);
                            return;
                        }
                        _this.dialog('close');
                        // 恢复窗口原状
                        clearDom();
                    }, 'json');

                // 更新
                } else if (editStatus == 1){

                    if (flag ==1 && $('select[name=rt_status]').val() == 1 && id != $('.data_main li.on').attr('attr')) {

                        if (confirm('有且仅有一个模板可为启用状态，您是否确定启用')) {

                            $('.data_main span.data_status').each(function(){

                                if ($(this).attr('attr') == 1) {
                                    $(this).attr('attr', 0);
                                    $(this).text('停用');
                                }
                            });

                        } else {
                            return false;
                        }
                    } else {
                        flag = 0;
                    }

                    $.post('__URL__/update', {rt_title: t_val, rt_type: $('select[name=rt_type]').val(), rt_video_code: $('select[name=rt_video_code]').val(), rt_video_rp: $('select[name=rt_video_rp]').val(), rt_video_bite: $('select[name=rt_video_bite]').val(), rt_video_bite: $('select[name=rt_video_bite]').val(), rt_video_frame: $('select[name=rt_video_frame]').val(), rt_voice_code: $('select[name=rt_voice_code]').val(), rt_voice_sample: $('select[name=rt_voice_sample]').val(), rt_voice_sound: $('select[name=rt_voice_sound]').val(), rt_voice_bite: $('select[name=rt_voice_bite]').val(), rt_cover_rp: $('select[name=rt_cover_rp]').val(), rt_cover_time: $('select[name=rt_cover_time]').val(), rt_status: $('select[name=rt_status]').val(), rt_id: $('.data_main li.on').attr('attr'), flag: flag}, function (json) {
                        if (json.status == 1) {
                            var htm = '';
                                htm+=  '<input type="checkbox" name="key" value="' + $('.data_main li.on').attr('attr') + '" class="data_check"/>'
                                    +  '<span class="data_id">' + idLength + '</span>'
                                    +  '<span class="data_name" title="' + t_val + '">' + t_val + '</span>'
                                    +  '<span class="data_status" attr="'+$('select[name=rt_status]').val()+'">' + statusName + '</span>'
                                    +  '<span class="data_opera" rt_title="' + t_val + '" rt_type="' + $('select[name=rt_type]').val() + '" rt_video_code="' + $('select[name=rt_video_code]').val() + '" rt_video_rp="' + $('select[name=rt_video_rp]').val() + '" rt_video_bite="' + $('select[name=rt_video_bite]').val() + '" rt_video_frame="' + $('select[name=rt_video_frame]').val() + '" rt_voice_code="' + $('select[name=rt_voice_code]').val() + '" rt_voice_sample="' + $('select[name=rt_voice_sample]').val() + '" rt_voice_sound="' + $('select[name=rt_voice_sound]').val() + '" rt_voice_bite="' + $('select[name=rt_voice_bite]').val() + '" rt_cover_rp="' + $('select[name=rt_cover_rp]').val() + '" rt_cover_time="' + $('select[name=rt_cover_time]').val() + '" rt_title="' + $('select[name=rt_title]').val() + '" rt_status="' + $('select[name=rt_status]').val() + '">编辑</span>'
                            $('.data_main li.on').html(htm);
                            setWidth(dateWidth);
                        } else {
                            showMessage(json.info);
                            return;
                        }

                        editStatus = 0;
                        _this.dialog('close');

                        // 恢复窗口原状
                        clearDom();
                    }, 'json');
                }
            },
            取消: function() {

                // 清空题目标题和编辑状态
                clearDom();
                editStatus = 0;
                $(this).dialog('close');
            }
        }
    });

    // checkbox 全选按钮
    $(document).on('click','input[name=allcheck]',function(){
        if($(this).is(':checked')){
            $('.data_main .data_check').prop('checked',true)
        } else {
            $('.data_main .data_check').prop('checked',false)
        }
    })
})

// 清空弹出框中被选中的状态
function clearDom() {
    $('input[name=rt_title]').val('');
    $('select[name=rt_type]').val(1);
    $('select[name=rt_video_code]').val(1);
    $('select[name=rt_video_rp]').val(1);
    $('select[name=rt_video_bite]').val(1);
    $('select[name=rt_video_bite]').val(1);
    $('select[name=rt_video_frame]').val(1);
    $('select[name=rt_voice_code]').val(1);
    $('select[name=rt_voice_sample]').val(1);
    $('select[name=rt_voice_sound]').val(1);
    $('select[name=rt_voice_bite]').val(1);
    $('select[name=rt_cover_rp]').val(1);
    $('select[name=rt_cover_time]').val(1);
    $('select[name=rt_status]').val(0);
}
</script>
<div class="warp">
<include file="Public:left"/>
<div class="colu_right alloca_right">
    <ul class="colu_carte">
        <volist name="secondList" id="selist">
            <li attr="{$selist['sn_name']}" <eq name="selist.sn_name" value="ResourceTranscode">class="car_click"</eq>><a href="__APPURL__{$selist['sn_url']}">{$selist['sn_title']}</a></li>
        </volist>
    </ul>
    <div class="colu_arrow ResourceTranscode">
        <image src="__APPURL__/Public/Images/Ilc/resource_arrow.png"/>
    </div>
    <div class="colu_main">
        <div class="tools fl">
            <span class="addCode"><i></i>新增</span>
            <span class="del"><i></i>删除</span>
            <div class="clear"></div>
            <p class="warn">提示：最多添加10个模板，且有且只有一个可以启用</p>
        </div>
        <ul class="handle_data data_hea">
            <li>
                <input type="checkbox" name="allcheck" class="data_check"/>
                <span class="data_id">ID</span>
                <span class="data_name">名称</span>
                <span class="data_status">状态</span>
                <span class="data_opera">操作</span>
            </li>
        </ul>
        <ul class="handle_data data_main">
            <volist name="template" id="vo">
            <li attr="{$vo.rt_id}" class="plist">
                <input type="checkbox" name="key" value="{$vo.rt_id}" class="data_check"/>
                <span class="data_id">{$key+1}</span>
                <span class="data_name" title='{$vo.rt_title}'>{$vo.rt_title}</span>
                <span class="data_status" attr='{$vo.rt_status}'><if condition="$vo.rt_status eq 0">停用<else />启用</if></span>
                <span class="data_opera" rt_title="{$vo.rt_title}" rt_type="{$vo.rt_type}" rt_video_code="{$vo.rt_video_code}" rt_video_rp="{$vo.rt_video_rp}" rt_video_bite="{$vo.rt_video_bite}" rt_video_frame="{$vo.rt_video_frame}" rt_voice_code="{$vo.rt_voice_code}" rt_voice_sample="{$vo.rt_voice_sample}" rt_voice_sound="{$vo.rt_voice_sound}" rt_voice_bite="{$vo.rt_voice_bite}" rt_cover_rp="{$vo.rt_cover_rp}" rt_cover_time="{$vo.rt_cover_time}" rt_title="{$vo.rt_title}" rt_status="{$vo.rt_status}">编辑</span>
            </li>
            </volist>
        </ul>
    </div>
</div>
</div>

<!--弹窗-->
<div class="allocation" title="创建转码参数模板">
    <ul>
        <li>
            <label>参数模板名称：</label>
            <input type="" name="rt_title" value=""/>
            <p></p>
        </li>
        <li class="all_style">
            <label>输出格式：</label>
            <select name="rt_type">
                <option value="1">MP4</option>
            </select>
        </li>
        <li>
            <label>视频参数：</label>
        </li>
        <li>
            <label>视频编码器：</label>
            <select name="rt_video_code">
                <volist name="video.param.videoCode.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
            <label>分辨率：</label>
            <select name="rt_video_rp">
                <volist name="video.param.resolvingPower.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
        </li>
        <li>
            <label>比特率：</label>
            <select name="rt_video_bite">
                <volist name="video.param.bite.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
            <label>帧速率：</label>
            <select name="rt_video_frame">
                <volist name="video.param.frameRate.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
        </li>
        <li>
            <label>音频编码器：</label>
            <select name="rt_voice_code">
                <volist name="voice.param.voiceCode.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
            <label>采样率：</label>
            <select name="rt_voice_sample">
                <volist name="voice.param.sample.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
        </li>
        <li>
            <label>声道：</label>
            <select name="rt_voice_sound">
                <volist name="voice.param.sound.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
            <label>比特率：</label>
            <select name="rt_voice_bite">
                <volist name="voice.param.bite.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
        </li>
        <li>
            <label>封面截图配置：</label>
        </li>
        <li>
            <label>分辨率：</label>
            <select name="rt_cover_rp">
                <volist name="cover.param.resolvingPower.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
            <label>截图时间：</label>
            <select name="rt_cover_time">
                <volist name="cover.param.time.param" id="vo">
                    <option value="{$key}">{$vo}</option>
                </volist>
            </select>
        </li>
        <li>
            <label>转码模板状态：</label>
        </li>
        <li>
            <label>状态：</label>
            <select name="rt_status">
                <option value="0">停用</option>
                <option value="1">启用</option>
            </select>
            <p>模板状态只能有一个启用</p>
        </li>
    <ul>
</div>
<include file="Public:footer"/>
